---
title: "Matrix comparison, negative polarity"
author: "SÃ¸ren Fjelstrup, Chiara Volani, Giuseppe Paglia and Johannes Rainer"
graphics: yes
output:
  BiocStyle::html_document:
    toc_float: true
bibliography: references.bib
csl: biomed-central.csl
references:
- id: dummy
  title: no title
  author:
  - family: noname
    given: noname
---

```{r biocstyle, echo = FALSE, results='hide', message = FALSE}
library(BiocStyle)
BiocStyle::markdown()
```

**Modified**: `r file.info("vams_matrix_neg.Rmd")$mtime`<br />
**Compiled**: `r date()`

```{r settings, echo = FALSE, results = "hide", message = FALSE, warning = FALSE}
#' Set general options
options(useFancyQuotes = FALSE)
set.seed(18011977)

#' Define paths:
filename <- "vams_matrix_neg"
#' Path to save the images; remove all old images.
IMAGE_PATH <- paste0("images/", filename, "/")
if (file.exists(IMAGE_PATH)) 
    unlink(IMAGE_PATH, recursive = TRUE)
dir.create(IMAGE_PATH, recursive = TRUE)
#' Path to store RData files
RDATA_PATH <- paste0("data/RData/", filename, "/")
if (!file.exists(RDATA_PATH)) dir.create(RDATA_PATH, recursive = TRUE)

#' Get the number of cpus allocated or fall back to 3
ncores <- as.integer(Sys.getenv("SLURM_JOB_CPUS_PER_NODE", 3))
```

# Introduction

In this document we evaluate differences between the 4 matrices (sample sources)
*venous*, *capillary*, *plasma* and *RBC*. We are specifically interested in
identifying features which are specific to one matrix or common to all matrices
(qualitative analysis) as well as features with different abundances between
matrices (quantitative analyses). For the former analysis we use determine for
each feature whether it is *present* in a sample or not based on whether a
chromatographic peak was identified for it. The latter analysis is based on the
feature abundances.

The analysis is performed similarly to the one for the positive polarity
[vams_matrix_pos.Rmd](vams_matrix_pos.Rmd).

The analysis uses the normalized feature abundances generated in
[vams_normalization_neg.Rmd](vams_normalization_neg.Rmd). The normalized data
contains abundance estimates for all features that are present in at least 30%
of samples of a matrix (QC samples excluded). The abundances from the two
technical replicates of each sample were combined into a single feature
abundance. Also, flags have been defined that provide information about the
*quality* of a normalized feature concentration. It is based on whether a
chromatographic peak was identified in a sample and how similar the reported
abundances for the feature in the two (technical) replicates for each sample
are. Based on their flag value, features can be classified into 6 different
types:

- `1`: signal from 2 detected peaks present and the RSD of their abundances is <
  30%. The `mean` of the two is reported.
- `0.9`: 1 detected and one filled-in signal present and their RSD is < 30%. The
  `mean` of the two is reported.
- `0.8`: only filled-in signal, but their RSD is < 30%. The `mean` of the two is
  reported.
- `0.7`: signal for two detected peaks but their RSD is >= 30%. The `mean` of
  the two is reported.
- `0.5`: signal from 1 detected peak present (independently of whether a
  filled-in signal is present for the other replicate). Report only
  the value for the detected peak.
- `0.25`: only filled-in signal is present. Either mean or single value
  reported.

Below we load all required libraries, define a color for each matrix and load
the normalized data.

```{r load-data , results='hide', message = FALSE}
library(xcms)
library(RColorBrewer)
library(pander)
library(doParallel)
registerDoParallel(ncores)
register(DoparParam(), default = TRUE)
#' register(SerialParam())
library(SummarizedExperiment)
library(UpSetR)

#' Load utility functions for the analysis
source("util-functions.R")

#' Define colors for the groups.
col_source <- brewer.pal(5, name = "Set1")[c(1, 2, 4, 5)]
names(col_source) <- c("RBC",           #' red
                       "plasma",        #' blue
                       "capillary",     #' purple
                       "venous")        #' orange

load("data/RData/vams_normalization_neg/vams_neg.RData")

```

# Data pre-filtering

The loaded data set consists of `r nrow(assay(vams_neg))` features that have
multiple peaks per samples in less than 10% of samples in which a peak was found
and that are present in at least 30% of samples from one matrix. We next
pre-filter this data set (further) by removing features with an RSD higher than
30% across QC samples (sample pools). The only concern with such a pre-filtering
on QC samples is that, in the present data set, the QC, which is in fact a
sample pool, seems to not be completely representative for every matrix.

Prior pre-filtering we plot the distribution of the RSD values across QC
samples.

```{r qc-rsd-distribution, echo = FALSE, fig.path = IMAGE_PATH, fig.cap = "Distribution of RSD values across QC samples. The grey vertical line indicates the 30% cut-off.", fig.width = 6, fig.height = 6}
plot(density(rowData(vams_neg)$QC_rsd, na.rm = TRUE),
     xlab = expression(RSD[QC]))
abline(v = 0.3, col = "grey")

```

This 30% RSD filtering will remove a considerable amount of samples.

```{r pre-filter}
keep <- rowData(vams_neg)$QC_rsd < 0.3
vams_neg <- vams_neg[which(keep), ]
```

Pre-filtering reduced the data set from `r length(keep)` features to 
`r sum(keep, na.rm = TRUE)` (`r sum(is.na(keep))` had an RSD of `NA` and were 
also excluded.


# *Qualitative* data analysis

## Identifying detected/present features for each matrix

We next aim to identify *present* (detected) features for each matrix which
allows to perform qualitative comparisons between the matrices. In contrast to
features with differences in abundances (identified in the next section) we do
not consider absolute intensities in this analysis but rather evaluate whether a
feature is detected in most samples of a matrix or not, i.e. whether a
chromatographic peak was identified or not. This information is encoded into th
*weight* of a measurement (see Introduction for the definition of the weights):
a chromatographic peak was detected for a feature in at least one of the two
replicates if the weight is either 1, 0.9, 0.7 or 0.5. Below we use these
weights to determine the proportion of samples for each matrix in which a
chromatographic peak was identified.

```{r proportion-detected, message = FALSE, warning = FALSE}
wght_detected <- c(1, 0.9, 0.7, 0.5)

#' Determine for each feature the proportion of samples (per matrix) in
#' which a peak was detected/
prop_detected <- apply(assay(vams_neg, "weights"), 1, function(x, grps) {
    vapply(split(x, grps), function(z) sum(z %in% wght_detected) / length(z),
           numeric(1))
}, grps = vams_neg$source)
prop_detected <- t(prop_detected)

```

Defining absent/present calls is not trivial. Using a hard cut-off on the
proportion of samples with a detected peak can be problematic, as features can
not be expected to be present in all samples. Sex-specific features would for
example be expected to be present in only 50% of samples. Requiring features to
be present in 60% of samples to define them as *present* would thus flag all
sex-specific features to be *absent*.

We therefore use an approach that compares, separately for each feature, and in
each matrix the number of samples in which a chromatographic peak was detected
to the maximum such number in any of the matrices. Specifically, features are
called *absent* in a certain matrix, if a peak was detected in less than one
third of the maximal number of samples with a detected peak in any of the
matrices. As example, if a feature was detected in 10 samples of a matrix, but
only in 3 in another matrix, it will be called *absent* in the latter. On the
other hand, if a feature was detected at most in 4 samples in a matrix, it is
still considered to be present in matrices in which e.g. in 2 samples a peak was
detected.

Below we calculate first the ratio between the proportion of samples in which a
peak was detected and the maximal proportion for that feature and subsequently
define the absent/present calls for each feature in each matrix based on these
values.

Note that the present analysis bases on features with a detected peak in at
least 1/3 of samples.

```{r present-absent-call, message = FALSE, warning = FALSE}
#' Calculate ratio between proportion and max proportion
prop_ratio <- (1 / rowMax(prop_detected)) * prop_detected

#' Define present/absent calls
present_call <- prop_ratio > 1/3
```


## Comparison of numbers of features detected in each matrix

With the present/absent calls available we can next evaluate the number of
features being detected in each matrix. The results are represented with the
barplot below.

```{r barplot-features, message = FALSE, warning = FALSE, echo = FALSE, fig.path = IMAGE_PATH, fig.cap = "Number of features detected by each matrix", fig.width = 6, fig.height = 8}
par(mfrow = c(1, 1), mar = c(7, 4.5, 2, 0.5))
barplot(colSums(present_call), col = col_source[colnames(present_call)],
        main = "Detected features", ylab = "count", las = 2)
```

Most features are present in venous samples followed by plasma. The fewest are
present in RBC samples and capillary samples. The numbers are also shown in
the table below.

```{r feature-count-table, results = "asis", echo = FALSE}
cpt <- paste0("Number of features detected in each matrix")
pandoc.table(colSums(present_call), style = "rmarkdown",
             caption = cpt)
```


## Matrix-specific features and features present in all matrices

We next compare the overlaps and intersects of features being *present* in the 4
matrices.

```{r upsetr-plot, message = FALSE, warning = FALSE, echo = FALSE, fig.path = IMAGE_PATH, fig.cap = "Visualisation of the feature intersects between the 4 matrices.", fig.width = 10, fig.height = 8}
ints <- apply(present_call, MARGIN = 2, which)
upset(fromList(ints), order.by = "freq",
      sets.bar.color = col_source[c("venous", "plasma", "capillary", "RBC")])
```

Almost half of the features are detectable in all 4 matrices. The
next largest overlap with ~ 900 features is between venous and plasma samples
as well as between venous, RBC and capillary samples. The number of
matrix-specific features is only very small ranging from 150 (venous) to 50
(RBC).

Next we define feature that are either present in all matrix or are specific to
a certain matrix.

```{r matrix-specific-features}
feats_common <- rownames(present_call)[rowSums(present_call) == 4]
feats_plasma_spec <- rownames(present_call)[rowSums(present_call) == 1 &
                                            present_call[, "plasma"]]
feats_venous_spec <- rownames(present_call)[rowSums(present_call) == 1 &
                                            present_call[, "venous"]]
feats_RBC_spec <- rownames(present_call)[rowSums(present_call) == 1 &
                                         present_call[, "RBC"]]
feats_capillary_spec <- rownames(present_call)[rowSums(present_call) == 1 &
                                               present_call[, "capillary"]]
```

```{r nacount, echo = FALSE}
na_count <- apply(assay(vams_neg), MARGIN = 1, function(z) sum(is.na(z)))
```

`r sum(na_count > 0)` features have (even after filling-in missing peaks) a 
missing value in at least one sample. We replace these with half of the
feature's smallest value in all samples adding a small standard deviation
to avoid constant values.

```{r Imputation-of-Values}
assays(vams_neg)$imputed <- imputeRowMinRand(
                    assay(vams_neg), min_fraction = 1/2,
                    sd_fraction = 1, abs = TRUE)

```

What seems to be common to all matrix-specific features is that their abundance
is moderate. Below we thus evaluate whether the average abundance level of
matrix-specific features is different to those from common features.

```{r matrix-specific-abundance, message = FALSE, fig.path = IMAGE_PATH, fig.cap = "Distribution of average (across samples) abundances of common and matrix-specific features.", fig.width = 6, fig.height = 8}
ints <- list(
    common = rowMeans(assay(vams_neg)[feats_common, ]),
    plasma = rowMeans(assay(vams_neg)[feats_plasma_spec,
                                      vams_neg$source == "plasma"]),
    venous = rowMeans(assay(vams_neg)[feats_venous_spec,
                                      vams_neg$source == "venous"]),
    RBC = rowMeans(assay(vams_neg)[feats_RBC_spec,
                                   vams_neg$source == "RBC"]),
    capillary = rowMeans(assay(vams_neg)[feats_capillary_spec,
                                         vams_neg$source == "capillary"])
)
par(mar = c(7, 4.5, 1, 1))
boxplot(lapply(ints, log2), varwidth = TRUE, col = col_source[names(ints)],
        ylab = expression(log[2]~abundance), las = 2, main = "average abundance")
grid(nx = NA, ny = NULL)
```

Indeed, the average abundance of matrix-specific features seems to be about two
to three-fold lower than the abundance of *common* features. Thus many features
might appear to be matrix specific because their abundance is below the
detection limit in other matrices. Also note that the number of matrix-specific
features is much smaller than that of common features.

# *Quantitative* data analysis

## Grouping samples based on metabolite abundances

We perform a principal component analysis to evaluate the grouping of the
samples/matrices in our experiment.

```{r pca-rsd, message = FALSE, warning = FALSE, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 10, fig.height = 5, fig.cap = "PCA grouping samples based on (centered) feature abundances. Only features with an RSD < 30% in QC samples were used. Circles represent samples from female, rectangles from male participants. Missing values were replaced with half of the feature's minimal abundance adding also a small random variance."}
#' RSD < 30% in QC samples
tmp <- log2(assay(vams_neg, "imputed"))
pc <- prcomp(t(tmp), scale = FALSE, center = TRUE)
pchs <- ifelse(vams_neg$sex == "F", 21, 22)

par(mfrow = c(1, 2), mar = c(4.5, 4.5, 1, 1))
plot_pca(pc, pc_x = 1, pc_y = 2, col = paste0(col_source[vams_neg$source], "ce"),
         bg = paste0(col_source[vams_neg$source], 60), pch = pchs, cex = 1.5)
legend("bottomright", col = col_source, legend = names(col_source), pch = 16)
plot_pca(pc, pc_x = 3, pc_y = 4, col = paste0(col_source[vams_neg$source], 80),
         bg = paste0(col_source[vams_neg$source], 40), pch = pchs, cex = 1.5)

```

In the first dimension we can see a clear separation between plasma and all
other, blood cell containing, samples. On PC2 capillary, RBC and venous samples
are separated. RBC samples are spread across PC2, whereas all other samples
groups into compact clusters. A similar separation by matrix type can also be
seen on PC3 while PC4 seems to mostly represent the spread of RBC samples.


Despite data normalization it could be possible that the differences seen in the
previous PCA plots are due to overall concentration differences. Thus each of
the sample types were plotted to see if significant differences in overall
concentration is found.

```{r BoxplotOfAbundances, fig.path = IMAGE_PATH, fig.cap = "Distribution of average abundances of common features and features detected within a certain matrix.", echo = FALSE}

#' All feautures present in the respective sample types are found. Note this is
#' different to when only the unique were found.
feats_plasma <- rownames(present_call)[present_call[, "plasma"]]
feats_venous <- rownames(present_call)[present_call[, "venous"]]
feats_RBC <- rownames(present_call)[present_call[, "RBC"]]
feats_capillary <- rownames(present_call)[present_call[, "capillary"]]

#' A list containing the abundances of the respective features were made. 
#' Note that they are imputed as it otherwise have too many missing values
intsMean <- list(
    common =  rowMeans(assay(vams_neg, "imputed")[feats_common, ]),
    plasma = rowMeans(assay(vams_neg, "imputed")[feats_plasma,
                                                 vams_neg$source == "plasma"]),
    venous = rowMeans(assay(vams_neg, "imputed")[feats_venous,
                                                 vams_neg$source == "venous"]),
    RBC = rowMeans(assay(vams_neg, "imputed")[feats_RBC,
                                              vams_neg$source == "RBC"]),
    capillary = rowMeans(assay(vams_neg, "imputed")[feats_capillary,
                                                    vams_neg$source == "capillary"])
)
  
#' Boxplot showing the distributions of the different groups
par(mar = c(7, 4.5, 1, 1))
boxplot(lapply(intsMean, log2), varwidth = TRUE, col = col_source[names(intsMean)],
        ylab = expression(log[2]~abundance), las = 2, main = "average abundance")
```

With the exception of common features that show slightly higher average
abundances, the average abundances of features detected in a matrix are
comparable. In addition to boxplots we create also cumulative distribution
functions to evaluate whether the distribution of average feature abundances are
comparable.

```{r CumulativeDistributionFunctionsOfAbundances, fig.path = IMAGE_PATH, echo = FALSE, fig.cap = "Cumulative density function of each matrix. The distributions of the matrices are mostly identical, with the plasma having a sligthly higher overall abundance and the RBC a slightly higher proportion of low abundance features"}
#' Cumulative distribution functions are made for the different groups, 
#' log2 is necessary due to the large differences in abundances
plasma_ecdf <- ecdf(as.numeric(log2(intsMean$plasma)))
venous_ecdf <- ecdf(as.numeric(log2(intsMean$venous))) 
RBC_ecdf <- ecdf(as.numeric(log2(intsMean$RBC)))
capillary_ecdf <- ecdf(as.numeric(log2(intsMean$capillary)))

plot(plasma_ecdf, col = col_source["plasma"], main = "cdf of abundance",
     xlab = "log2 abundance", ylab = "Density" , xlim = c(0,20), ylim = (c(0,1)))
lines(venous_ecdf, col = col_source["venous"])
lines(RBC_ecdf, col = col_source["RBC"])
lines(capillary_ecdf, col = col_source["capillary"])

legend('left', c("plasma","venous","RBC","capillary"), fill = col_source[
  c("plasma","venous","RBC","capillary")], border=NA)
```

The cumulative density function shows that the abundances of the features for
the RBC is the lowest,and the plasma is the highest, the venous and capillary
are almost identical. The differences are however very minor, so it is unlikely
to have had much of an effect.


## Differential abundance analysis

In this analysis we fit the regression model to log2 transformed abundances
(including imputed values) of each feature and extract the coefficients from the
fitted model representing the slope (or difference) of the average abundance of
samples from the respective matrix to the base line capillary samples. The
p-value represents the significance from the Wald test against the null
hypothesis of the coefficient being 0 (i.e. no differences between the average
abundances).

Capillary samples are used as baseline, comparing thus abundances of all other
matrices against these.

The p-values are subsequently adjusted for multiple hypothesis testing using the
method from Benjamini and Hochberg for a strong control of the false discovery
rate.

The employed model `conc ~ source + sex` adjusts for sex-specific differences. A
simple model without accounting for any confounding effects yielded however
similar results (not shown).

Linear models are fit using the `limma` package and p-values are estimated with
the empirical Bayes-based moderated t-test.

```{r limma, warning = FALSE}
library(limma)
SourcesTypes <- c("sourceplasma","sourceRBC","sourcevenous")
pLimit <- 0.01
foldLimit <- 1

source <- vams_neg$source
sex <- vams_neg$sex
dsgn <- model.matrix(~ source + sex)
fit <- lmFit(log2(assay(vams_neg, "imputed")), design = dsgn)
fit <- eBayes(fit)

res_matrix_neg <- data.frame(coef = fit$coefficients[, -1],
                             pvalue = fit$p.value[, -1])
adjp <- apply(fit$p.value[, -1], MARGIN = 2, p.adjust, method = "BH")
sign <- adjp < pLimit & abs(fit$coefficients[, -1]) > foldLimit
res_matrix_neg <- cbind(as.data.frame(rowData(vams_neg)),
                        res_matrix_neg,
                        adj.pvalue = adjp,
                        significant = sign,
                        present = present_call)

```

Histograms of each of the 3 matrixes against capillary is made.

```{r Histogramofpvalues, fig.path = IMAGE_PATH, echo = FALSE, fig.cap = "Histogram of the p values each of the linear models against capillary.", fig.width = 12, fig.height = 4}
TestedSourcenames <-  c("plasma", "RBC", "venous")
par(mfrow=c(1, 3))
for (i in 1:3) {
    hist(res_matrix_neg[, paste0("pvalue.", SourcesTypes[i])],
         main = paste0(TestedSourcenames[i], " vs capillary"),
         xlab = "p-value")
}

```

It looks like the p-values decrease gradually, this suggest that the effect of
any confounding effects are likely to be minor, compared to the overall
differences from the matrices. We do however have a very large number of
features with differences in their abundances.

Based on the models created in the previous section volcano plots are made for
each of the matrices compared to capillary.

```{r VolcanoPlotMultipleRegression, fig.path = IMAGE_PATH, echo = FALSE, fig.cap = "Volcano plots of each of the linear models against capillary. Benjamini-Hochberg adjusted values, against the mean differences for each feature, show a large proportion of the features are statistically significantly different between matrixes", fig.width = 12, fig.height = 4}
#' A new color set is defined to better conform to what is need by the volcano plot
col_volcano <- brewer.pal(9, name = "Set1")[c(9, 9, 9, 3)]
names(col_volcano) <- c("all", "pLimit", "foldLimit", "significant")

#' The filters for pvalue and fold increase is defined
colorFilterLowP <- as.matrix(
    res_matrix_neg[, paste0("adj.pvalue.", SourcesTypes)]) < pLimit
colorFilterHighFold <- abs(as.matrix(
    res_matrix_neg[, paste0("coef.", SourcesTypes)])) > foldLimit

#' The filter for coloring the points is made
colorFilter <- 1 * colorFilterLowP
colorFilter[colorFilterHighFold] <- 2
colorFilter[colorFilterHighFold * colorFilterLowP == 1] <- 3
colorFilter <- colorFilter + 1

par(mfrow=c(1, 3), mar = c(4.3, 4.3, 1, 1))
x_range <- range(as.matrix(
    res_matrix_neg[, grep("^coef", colnames(res_matrix_neg))]), na.rm = TRUE)
y_range <- range(
    -log10(as.matrix(res_matrix_neg[, grep("^adj", colnames(res_matrix_neg))])),
    na.rm = TRUE)
for (i in 1:3){
    plot(3, 3, pch = NA, xlim = x_range, ylim = y_range,
         xlab = expression(log[2]~fold~change),
         ylab = expression(-log[10]~p[BH]~value),
         main = paste0(TestedSourcenames[i], " vs capillary"))
    grid(col = "#cecece20")
    points(res_matrix_neg[, paste0("coef.", SourcesTypes[i])],
           -log10(res_matrix_neg[, paste0("adj.pvalue.", SourcesTypes[i])]),
           pch = 16, col = paste0(col_volcano[colorFilter[, i]], 60),
           cex = 0.6)
    abline(h = -log10(pLimit))
    abline(v = c(-foldLimit, foldLimit))
}

```

A surprisingly large amount of features were detected to have statistically
different abundances between the compared matrices. This was expected for the
RBC and plasma, but not for the venous one, but is consistent with what was seen
in the PCA plots. The number of significant features for each comparison are
listed below.

```{r count-table_linear_model, results = "asis", echo = FALSE}
cpt <- paste0("Number of features with a significant difference in abundances",
              " (more than two-fold difference in abundances at a 1% FDR.")
pandoc.table(colSums(as.matrix(
    res_matrix_neg[, grep("significant", colnames(res_matrix_neg))]),
    na.rm = TRUE), style = "rmarkdown", caption = cpt)
```

As expected, the largest number of features with differences in abundances was
identified between plasma and capillary samples. The number of significant
features is smaller for the comparisons between RBC and capillary and for
venous and capillary samples.

The large differences may have many sources. To help identify these it was
decided to probe the underlying distributions of the features based on the
two factors we know. The mass/charge ratio and the retention time. It would be
expected that the venous and capillary would be mostly the same with the plasma
and RBC being different.

Plots showing the distributions of the matrixes based on m/z were made.

```{r pValueDependencyOnmzNoconfounding, fig.cap = "Smoothed histograms showing the distribution of m/z values (left) or retention time (right) for detected features in a matrix.", echo = FALSE, fig.width = 12, fig.height = 6, fig.path = IMAGE_PATH}

#' Distributions of mz values for each matrix.
par(mfrow = c(1, 2), mar = c(4.3, 4.3, 1, 1))
hsts <- apply(present_call, MARGIN = 2, function(z) {
    hist(res_matrix_neg$mzmed[z], plot = FALSE, breaks = 128)
})
ymax <- max(vapply(hsts, function(z) max(z$counts), numeric(1)))
plot(3, 3, pch = NA, ylab = "counts", xlab = "m/z", ylim = c(0, ymax),
     xlim = range(res_matrix_neg$mzmed),
     main = "Detected features in a matrix")
legend("topleft", col = col_source, legend = names(col_source), lwd = 2)
for (i in 1:ncol(present_call)) {
    col <- paste0(col_source[colnames(present_call)[i]], 80)
    ## points(hsts[[i]]$mids, hsts[[i]]$counts, type = "l", col = col)
    points(lowess(hsts[[i]]$mids, hsts[[i]]$counts, f = 0.1),
           type = "l", lwd = 2, col = col)
}
#' retention time
hsts <- apply(present_call, MARGIN = 2, function(z) {
    hist(res_matrix_neg$rtmed[z], plot = FALSE, breaks = 128)
})
ymax <- max(vapply(hsts, function(z) max(z$counts), numeric(1)))
plot(3, 3, pch = NA, ylab = "counts", xlab = "retention time",
     ylim = c(0, ymax), xlim = range(res_matrix_neg$rtmed),
     main = "Detected features in a matrix")
for (i in 1:ncol(present_call)) {
    col <- paste0(col_source[colnames(present_call)[i]], 80)
    ## points(hsts[[i]]$mids, hsts[[i]]$counts, type = "l", col = col)
    points(lowess(hsts[[i]]$mids, hsts[[i]]$counts, f = 0.05),
           type = "l", lwd = 2, col = col)
}

```

The distribution of m/z values for detected features is very similar across all
matrices (most likely also because the number of matrix-specific features is
only very small). Also the distribution of retention times for detected features
are highly comparable between the matrices.

Next we evaluate the distribution of m/z and retention times for the
matrix-specific features.

```{r mz-rt-matrix-specific, fig.cap = "Smoothed histograms showing the distribution of m/z values (left) or retention time (right) for matrix-specific features.", echo = FALSE, fig.width = 12, fig.height = 6, fig.path = IMAGE_PATH}

#' Distributions of mz values for each matrix.
par(mfrow = c(1, 2), mar = c(4.3, 4.3, 1, 1))
hsts <- lapply(list(feats_capillary_spec, feats_plasma_spec,
                    feats_RBC_spec, feats_venous_spec), function(z) {
                        hist(res_matrix_neg[z, "mzmed"], plot = FALSE,
                             breaks = 64)
                    })
ymax <- max(vapply(hsts, function(z) max(z$counts), numeric(1)))
plot(3, 3, pch = NA, ylab = "counts", xlab = "m/z", ylim = c(0, ymax),
     xlim = range(res_matrix_neg$mzmed),
     main = "Matrix-specific features")
legend("topleft", col = col_source, legend = names(col_source), lwd = 2)
for (i in 1:ncol(present_call)) {
    col <- paste0(col_source[colnames(present_call)[i]], 80)
    ## points(hsts[[i]]$mids, hsts[[i]]$counts, type = "l", col = col)
    points(lowess(hsts[[i]]$mids, hsts[[i]]$counts, f = 0.1),
           type = "l", lwd = 2, col = col)
}
#' retention time
hsts <- lapply(list(feats_capillary_spec, feats_plasma_spec,
                    feats_RBC_spec, feats_venous_spec), function(z) {
                        hist(res_matrix_neg[z, "rtmed"], plot = FALSE,
                             breaks = 64)
                    })
ymax <- max(vapply(hsts, function(z) max(z$counts), numeric(1)))
plot(3, 3, pch = NA, ylab = "counts", xlab = "retention time",
     ylim = c(0, ymax), xlim = range(res_matrix_neg$rtmed),
     main = "Matrix-specific features")
for (i in 1:ncol(present_call)) {
    col <- paste0(col_source[colnames(present_call)[i]], 80)
    ## points(hsts[[i]]$mids, hsts[[i]]$counts, type = "l", col = col)
    points(lowess(hsts[[i]]$mids, hsts[[i]]$counts, f = 0.05),
           type = "l", lwd = 2, col = col)
}

```

Note that the number of matrix-specific features is about 3 times higher for
venous and plasma samples, thus the plot above is a little hard to read.
Plasma samples seem to have a higher proportion of features with an m/z range
from about 700 to 750 compared to all other matrices. On the other hand plasma
samples seem to lack features with an m/z from 750 to 800.

Next we evaluate the distribution of m/z and retention times for the features
with significant differences in abundances compared to capillary samples.

```{r mzSignificant, fig.cap = "Smoothed histograms showing the distributions of m/z values (left) and retention times (right) for features with significant different abundances compared to the levels in capillary samples.", echo = FALSE, fig.width = 12, fig.height = 6, fig.path = IMAGE_PATH}
par(mfrow = c(1, 2), mar = c(4.3, 4.3, 1, 1))
sources <- c("plasma", "RBC", "venous")
#' m/z
hsts <- lapply(res_matrix_neg[, paste0("significant.source", sources)],
               function(z) hist(res_matrix_neg$mzmed[z], plot = FALSE,
                                breaks = 128))
ymax <- max(vapply(hsts, function(z) max(z$counts), numeric(1)))
plot(3, 3, pch = NA, ylab = "counts", xlab = "m/z", ylim = c(0, ymax),
     xlim = range(res_matrix_neg$mzmed),
     main = "Significant features against capillary")
legend("topleft", col = col_source[sources], legend = sources, lwd = 2)
for (i in 1:length(sources)) {
    col <- paste0(col_source[sources[i]], 80)
    ## points(hsts[[i]]$mids, hsts[[i]]$counts, type = "l", col = col)
    points(lowess(hsts[[i]]$mids, hsts[[i]]$counts, f = 0.1),
           type = "l", lwd = 2, col = col)
}
#' retention time
hsts <- lapply(res_matrix_neg[, paste0("significant.source", sources)],
               function(z) hist(res_matrix_neg$rtmed[z], plot = FALSE,
                                breaks = 128))
ymax <- max(vapply(hsts, function(z) max(z$counts), numeric(1)))
plot(3, 3, pch = NA, ylab = "counts", xlab = "retention time",
     ylim = c(0, ymax), xlim = range(res_matrix_neg$rtmed),
     main = "Significant features against capillary")
for (i in 1:length(sources)) {
    col <- paste0(col_source[sources[i]], 80)
    ## points(hsts[[i]]$mids, hsts[[i]]$counts, type = "l", col = col)
    points(lowess(hsts[[i]]$mids, hsts[[i]]$counts, f = 0.04),
           type = "l", lwd = 2, col = col)
}

```

This distribution includes only the features with significantly different
abundances between matrices. The overall shape of the density lines for the m/z
values are similar for all matrices.

The distribution of significant features along the retention time dimension
differs more between matrices. Only very few features with a low retention time
of about 30 seconds were found to be different between venous and RBC
samples. On the other hand, the largest number of features with a retention time
of about 160 seconds were found significant between RBC and capillary samples.

Next we evaluate over- and under-represented features (compared to capillary
samples) separately.

```{r mzCountsSignificant, fig.cap = "Smoothed histograms showing the distribution of m/z values (left) and retention time (right) for significant features with a higher or lower abundance compared to capillary samples.", echo = FALSE, fig.width = 12, fig.height = 6, fig.path = IMAGE_PATH}

par(mfrow = c(1, 2), mar = c(4.3, 4.3, 1.5, 1))
plot(x = 1, y = 1, pch = NA, xlim = c(50, 1100), ylim = c(-30, 30),
     xlab = "m/z", ylab = "count", main = "Significant features")
text(x = c(50, 50), y = c(-25, 25), pos = c(4, 4),
     label = c("lower abundance than capillary",
               "higher abundance than capillary"))
for (src in TestedSourcenames) {
    yLow <- res_matrix_neg[
        which(res_matrix_neg[, paste0("significant.source", src)] & 
              res_matrix_neg[, paste0("coef.source", src)] < 0), "mzmed"]
    yLow <- hist(yLow, breaks = seq(50, 1100, 5), plot = FALSE)   
    yHigh <- res_matrix_neg[
        which(res_matrix_neg[, paste0("significant.source", src)] & 
              res_matrix_neg[, paste0("coef.source", src)] > 0), "mzmed"]
    yHigh <- hist(yHigh, breaks = seq(50, 1100, 5), plot = FALSE)
    ## lines(yHigh$mids, yHigh$counts, col = paste0(col_source[src], 80), lwd = 2)
    ## lines(yLow$mids, -yLow$counts, col = paste0(col_source[src], 80), lwd = 2)
    points(lowess(yHigh$mids, yHigh$counts, f = 0.05),
           col = paste0(col_source[src], 80), lwd = 2, type = "l")
    points(lowess(yLow$mids, -yLow$counts, f = 0.05),
           col = paste0(col_source[src], 80), lwd = 2, type = "l")
}
grid()
abline(h = 0)
legend("topright", legend = TestedSourcenames, lwd = 2, lty = 1,
       col = col_source[TestedSourcenames], inset = c(0, 0))
plot(x = 1, y = 1, pch = NA, xlim = c(0, 250), ylim = c(-400, 400),
     xlab = "rt", ylab = "count", main = "Significant features")
text(x = c(0, 0), y = c(-350, 350), pos = c(4, 4),
     label = c("lower abundance than capillary",
               "higher abundance than capillary"))
for (src in TestedSourcenames) {
    yLow <- res_matrix_neg[
        which(res_matrix_neg[, paste0("significant.source", src)] & 
              res_matrix_neg[, paste0("coef.source", src)] < 0), "rtmed"]
    yLow <- hist(yLow, breaks = seq(0, 250, 5), plot = FALSE)   
    yHigh <- res_matrix_neg[
        which(res_matrix_neg[, paste0("significant.source", src)] & 
              res_matrix_neg[, paste0("coef.source", src)] > 0), "rtmed"]
    yHigh <- hist(yHigh, breaks = seq(0, 250, 5), plot = FALSE)
    ## lines(yHigh$mids, yHigh$counts, col = paste0(col_source[src], 80), lwd = 2)
    ## lines(yLow$mids, -yLow$counts, col = paste0(col_source[src], 80), lwd = 2)
    points(lowess(yHigh$mids, yHigh$counts, f = 0.1),
           col = paste0(col_source[src], 80), lwd = 2, type = "l")
    points(lowess(yLow$mids, -yLow$counts, f = 0.1),
           col = paste0(col_source[src], 80), lwd = 2, type = "l")
}
grid()
abline(h = 0)

```

While no differences can be observed between all 3 comparisons for features with
higher abundances compared to capillary samples, differences are present between
matrix comparisons for features with higher abundances in capillary samples:
compared to the other two comparisons, only few features with an m/z value
higher than 300 are have significantly lower abundances in venous compared to
capillary samples. In contrast, features with a lower m/z value (between 100 and
400) are enriched among features found to have significantly lower abundances in
plasma samples than in capillary samples.

The distribution of retention times for significant features is very informative
too (right plot in the figure above). Retention time distribution for
significant features with higher abundances in plasma or venous samples are
similar. The largest differences are again visible for features with higher
abundances in capillary samples, most notable for features significant for RBC
samples that are enriched for compounds with a very low retention time (about 30
seconds) or a retention time of about 160 seconds.


# Result object

The results of this analysis are exported to the *vams_matrix_pos_results.txt*
file.

```{r writexl}
library(writexl)
write_xlsx(as.data.frame(res_matrix_neg),
           path = "data/xls/vams_matrix_neg_results.xlsx")

save(res_matrix_neg, file = paste0(RDATA_PATH, "res_matrix_neg.RData"))
```

The most important columns in the result table are:
- `mzmed`, `mzmin`, `mzmax`: m/z of the feature.
- `rtmed`, `rtmin`, `rtmax`: retention time window of the feature.
- `QC_rsd`: RSD over QC samples.
- `coef.source<matrix>`: log2 fold change of feature abundance between
  `<matrix>` and capillary samples.
- `pvalue.source<matrix>`: p-value representing the significance of the
  difference in abundances between `<matrix>` and capillary samples. These are
  raw (unadjusted) p-values and should only considered for sorting of the
  features.
- `adj.pvalue.source<matrix>`: p-values adjusted for multiple hypothesis
  testing representing the significance of differential abundance.
- `significant.source<matrix>`: logical indicating whether the feature was
  identified to have a significant difference in abundances.
- `present.<matrix>`: *present* call of the feature from the qualitative
  analysis.



# Session information

```{r sessionInfo}
devtools::session_info()
```

# References
