useNames = TRUE))
upset(fromList(listInput), order.by = "freq")
sig_CV <- which(rowData(res)$significant.CapvsVen, useNames = TRUE)
sig_CP <- which(rowData(res)$significant.CapvsPlas, useNames = TRUE)
sig_VP <- which(rowData(res)$significant.VenvsPlas, useNames = TRUE)
sig_ft <- unique(c(rowData(res)[sig_CV & sig_CP & sig_VP, ]))
## Create heatmap
tmp <- log2(assay(
res, "normalized_filled_imputed")[rownames(sig_ft), , drop = FALSE])
tmp <- tmp - rowMeans(tmp, na.rm = TRUE)
ann <- as.data.frame(colData(res)[, c("source", "sex")])
pm <- pheatmap(tmp, annotation_col = ann, labels_col = colnames(tmp),
annotation_color = list(source = col_source,
sex = col_sex))
rsds <- rowRsd(assay(res_qc, "normalized_filled"))
dratios_ven <- apply(
log2(assay(res_qc, "normalized_filled")), 1, sd, na.rm = TRUE) /
apply(log2(assay(res_neg[, res_neg$source == "venous"],
"normalized_filled")), 1, sd, na.rm = TRUE)
dratios_cap <- apply(
log2(assay(res_qc, "normalized_filled")), 1, sd, na.rm = TRUE) /
apply(log2(assay(res_neg[, res_neg$source == "capillary"],
"normalized_filled")), 1, sd, na.rm = TRUE)
dratios_pla <- apply(
log2(assay(res_qc, "normalized_filled")), 1, sd, na.rm = TRUE) /
apply(log2(assay(res_neg[, res_neg$source == "plasma"],
"normalized_filled")), 1, sd, na.rm = TRUE)
dratios <- apply(cbind(dratios_ven, dratios_cap, dratios_pla),
MARGIN = 1, mean, na.rm = TRUE)
dratios[is.infinite(dratios)] <- NA
par(mfrow = c(1, 2))
plot(density(rsds, na.rm = TRUE), xlab = "RSD",
main = "Distribution of RSD values")
abline(v = 0.3, col = "red", lty = 2)
plot(density(dratios, na.rm = TRUE), xlab = "D-ratio",
main = "Distribution of D-ratios")
abline(v = 0.5, col = "red", lty = 2)
plot(log2(rsds), log2(dratios), xlab = expression(log[2]~RSD),
ylab = expression(log[2]~D-ratio), pch = 16, col = "#00000040")
abline(v = log2(0.3), col = "red", lty = 2)
abline(h = log2(0.5), col = "red", lty = 2)
res <- res_neg[which(dratios < 0.5), ]
keep <- moreAreValidThan(assay(res, "raw"), f = res$source, prop = 1/3)
res <- res[keep, ]
pc <- prcomp(t(log2(assay(res, "normalized_filled_imputed"))),
center = TRUE, scale. = FALSE)
plas <- assay(res, "raw")[, res$source == "plasma"]
plas_present <- moreAreValidThan(plas, prop = 1/3)
ven <- assay(res, "raw")[, res$source == "venous"]
ven_present <- moreAreValidThan(ven, prop = 1/3)
cap <- assay(res, "raw")[, res$source == "capillary"]
cap_present <- moreAreValidThan(cap, prop = 1/3)
#create an UpSetR plot
library(UpSetR)
listInput <- list(capillary = which(cap_present, useNames = TRUE),
venous = which(ven_present, useNames = TRUE),
plasma = which(plas_present, useNames = TRUE))
upset(fromList(listInput), order.by = "freq")
## Factor sample source, sex and age
source <- factor(res$source)
sex <- factor(res$sex)
## Fit the data to the desired design
dsgn <- model.matrix(~ 0 + source + sex)
fit <- lmFit(log2(assay(res, "normalized_filled_imputed")), design = dsgn)
## Fit the actual contrasts of interest
contr_mat <- makeContrasts(
CapvsVen = sourcecapillary - sourcevenous,
CapvsPlas = sourcecapillary - sourceplasma,
VenvsPlas = sourcevenous - sourceplasma,
levels = dsgn)
fit <- contrasts.fit(fit, contrasts = contr_mat)
fit <- eBayes(fit)
adjp <- apply(fit$p.value, 2, p.adjust, method = "BH")
tmp <- data.frame(
coef = fit$coefficient,
pvalue = fit$p.value,
adjp = adjp,
significant = adjp < p.cut & abs(fit$coefficient) > m.cut
)
tmp$avg.Cap <- rowMeans(
log2(assay(res, "normalized_filled_imputed")[, res$source == "capillary"]))
tmp$avg.Ven <- rowMeans(
log2(assay(res, "normalized_filled_imputed")[, res$source == "venous"]))
tmp$avg.Plas <- rowMeans(
log2(assay(res, "normalized_filled_imputed")[, res$source == "plasma"]))
rowData(res) <- cbind(rowData(res), tmp)
tab <- colSums(as.matrix(rowData(res)[, grep("significant",
colnames(rowData(res)))]))
pandoc.table(tab, style = "rmarkdown",
caption = paste0("Number of significant features of the in",
" total", nrow(res), "analyzed features."))
plot_volcano <- function(x, contrast = "CapvsVen") {
par(mfrow = c(1, 1))
X <- rowData(x)[, paste0("coef.", contrast)]
Y <- rowData(x)[, paste0("adjp.", contrast)]
minp <- min(Y[Y > 0])
Y[Y == 0] <- minp / 100
Y <- -log10(Y)
plot(X, Y,
xlab = expression(log[2]~difference),
ylab = expression(-log[10]~p[BH]), pch = 16, col = "#00000060")
rect(xleft = -100, ybottom = -log10(p.cut), xright = -m.cut, ytop = 100,
border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
rect(xleft = m.cut, ybottom = -log10(p.cut), xright = 100, ytop = 100,
border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
sigs <- rowData(x)[, paste0("significant.", contrast)]
if (any(sigs))
points(X[sigs], Y[sigs], col = "#0000ffcc")
}
plot_volcano(res, "CapvsVen")
res_table <- function(x, contrast) {
## Write result table
sigs <- rowData(x)[, paste0("significant.", contrast)]
tab <- rowData(x)[sigs,
c("mzmed", "rtmed", paste0("coef.", contrast),
paste0("adjp.", contrast),
"avg.Cap", "avg.Ven", "avg.Plas", "RSD_QC", "Dratio")]
tab <- tab[order(tab$adjp, abs(tab$coef)), ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Features with significant differences in abundances.")
invisible(tab)
}
tab <- res_table(res, "CapvsVen")
## Create heatmap
tmp <- log2(assay(
res, "normalized_filled_imputed")[rownames(tab), , drop = FALSE])
tmp <- tmp - rowMeans(tmp, na.rm = TRUE)
ann <- as.data.frame(colData(res)[, c("source", "sex")])
pm <- pheatmap(tmp, annotation_col = ann, labels_col = colnames(tmp),
annotation_color = list(source = col_source,
sex = col_sex))
add_result <- function(x) {
## Generate result data frame
tmp <- data.frame(
coef = fit$coefficient[, "CapvsVen"],
pvalue = fit$p.value[, "CapvsVen"],
adjp = p.adjust(fit$p.value[, "CapvsVen"], method = "BH"),
avg.Cap = rowMeans(
log2(assay(x, "normalized_filled_imputed")
[, x$source == "capillary"])),
avg.Ven = rowMeans(
log2(assay(x, "normalized_filled_imputed")
[, x$source == "venous"]))
)
## Evaluate which features are significant
tmp$significant <- abs(tmp$coef) > m.cut & tmp$adjp < p.cut
tmp$RSD_QC <- rsds[rownames(rowData(x))]
tmp$Dratio <- dratios[rownames(rowData(x))]
## Add data frame to res
rowData(x) <- cbind(rowData(x), tmp)
x
}
CapvsVen <- add_result(res)
res_table <- function(x) {
## Write result table
if (any(rowData(x)$significant)) {
tab <- rowData(x)[rowData(x)$significant,
c("mzmed", "rtmed", "coef", "adjp",
"avg.Cap", "avg.Ven", "RSD_QC", "Dratio")]
tab <- tab[order(tab$adjp, abs(tab$coef)), ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Features with significant differences in abundances.")
} else {
tab <- rowData(x)[order(rowData(x)$pvalue),
c("mzmed", "rtmed", "coef", "adjp",
"avg.F", "avg.M", "RSD_QC", "Dratio")]
tab <- tab[1:20, ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Top 20 features with the smallest p-values.")
}
invisible(tab)
}
tab <- res_table(CapvsVen)
## Create heatmap
tmp <- log2(assay(
CapvsVen, "normalized_filled_imputed")[rownames(tab), , drop = FALSE])
tmp <- tmp - rowMeans(tmp, na.rm = TRUE)
ann <- as.data.frame(colData(res)[, c("source", "sex")])
pm <- pheatmap(tmp, annotation_col = ann, labels_col = colnames(tmp),
annotation_color = list(source = col_source,
sex = col_sex))
plot_volcano(res, "CapvsPlas")
add_result <- function(x) {
## Generate result data frame
tmp <- data.frame(
coef = fit$coefficient[, "CapvsPlas"],
pvalue = fit$p.value[, "CapvsPlas"],
adjp = p.adjust(fit$p.value[, "CapvsPlas"], method = "BH"),
avg.Cap = rowMeans(
log2(assay(x, "normalized_filled_imputed")[, x$source == "capillary"])),
avg.Plas = rowMeans(
log2(assay(x, "normalized_filled_imputed")[, x$source == "plasma"]))
)
## Evaluate which features are significant
tmp$significant <- abs(tmp$coef) > m.cut & tmp$adjp < p.cut
tmp$RSD_QC <- rsds[rownames(rowData(x))]
tmp$Dratio <- dratios[rownames(rowData(x))]
## Add data frame to res
rowData(x) <- cbind(rowData(x), tmp)
x
}
CapvsPlas <- add_result(res)
if (any(rowData(CapvsPlas)$significant)) {
tab <- rowData(CapvsPlas)[rowData(CapvsPlas)$significant,
c("mzmed", "rtmed", "coef", "adjp",
"avg.Cap", "avg.Plas", "RSD_QC", "Dratio")]
tab <- tab[order(tab$adjp, abs(tab$coef)), ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Features with significant differences in abundances.")
}
res_table <- function(x) {
## Write result table
if (any(rowData(x)$significant)) {
tab <- rowData(x)[rowData(x)$significant,
c("mzmed", "rtmed", "coef", "adjp",
"avg.Cap", "avg.Plas", "RSD_QC", "Dratio")]
tab <- tab[order(tab$adjp, abs(tab$coef)), ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Features with significant differences in abundances.")
}
}
tab <- res_table(CapvsPlas)
res_table <- function(x) {
## Write result table
if (any(rowData(x)$significant)) {
tab <- rowData(x)[rowData(x)$significant,
c("mzmed", "rtmed", "coef", "adjp",
"avg.Cap", "avg.Plas", "RSD_QC", "Dratio")]
tab <- tab[order(tab$adjp, abs(tab$coef)), ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Features with significant differences in abundances.")
} else {
tab <- rowData(x)[order(rowData(x)$pvalue),
c("mzmed", "rtmed", "coef", "adjp",
"avg.Cap", "avg.Plas", "RSD_QC", "Dratio")]
tab <- tab[1:20, ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Top 20 features with the smallest p-values.")
}
invisible(tab)
}
tab <- res_table(CapvsPlas)
res_table <- function(x) {
## Write result table
if (any(rowData(x)$significant)) {
tab <- rowData(x)[rowData(x)$significant,
c("mzmed", "rtmed", "coef", "adjp",
"avg.Cap", "avg.Plas", "RSD_QC", "Dratio")]
tab <- tab[order(tab$adjp, abs(tab$coef)), ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Features with significant differences in abundances.")
}
invisible(tab)
}
tab <- res_table(CapvsPlas)
res_table <- function(x) {
## Write result table
if (any(rowData(x)$significant)) {
tab <- rowData(x)[rowData(x)$significant,
c("mzmed", "rtmed", "coef", "adjp",
"avg.Cap", "avg.Ven", "RSD_QC", "Dratio")]
tab <- tab[order(tab$adjp, abs(tab$coef)), ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Features with significant differences in abundances.")
}
invisible(tab)
}
tab <- res_table(CapvsVen)
## Create heatmap
tmp <- log2(assay(
CapvsPlas, "normalized_filled_imputed")[rownames(tab), , drop = FALSE])
tmp <- tmp - rowMeans(tmp, na.rm = TRUE)
ann <- as.data.frame(colData(CapvsPlas)[, c("source", "sex")])
pm <- pheatmap(tmp, annotation_col = ann, labels_col = colnames(tmp),
annotation_color = list(source = col_source,
sex = col_sex))
plot_volcano(VenvsPlas)
y = "VenvsPlas"
plot_volcano(res, "VenvsPlas")
if (any(rowData(VenvsPlas)$significant)) {
tab <- rowData(VenvsPlas)[rowData(VenvsPlas)$significant,
c("mzmed", "rtmed", "coef", "adjp",
"avg.Ven", "avg.Plas", "RSD_QC", "Dratio")]
tab <- tab[order(tab$adjp, abs(tab$coef)), ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Features with significant differences in abundances.")
}
## Create heatmap
tmp <- log2(assay(
VenvsPlas, "normalized_filled_imputed")[rownames(tab), , drop = FALSE])
if (any(rowData(res)$significant.VenvsPlas)) {
tab <- rowData(res)$significant.VenvsPlas[rowData(VenvsPlas)$significant,
c("mzmed", "rtmed", "coef", "adjp",
"avg.Ven", "avg.Plas", "RSD_QC", "Dratio")]
tab <- tab[order(tab$adjp, abs(tab$coef)), ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Features with significant differences in abundances.")
}
res_table <- function(x) {
## Write result table
if (any(rowData(x)$significant)) {
tab <- rowData(x)[rowData(x)$significant,
c("mzmed", "rtmed", "coef", "adjp",
"avg.Ven", "avg.Plas", "RSD_QC", "Dratio")]
tab <- tab[order(tab$adjp, abs(tab$coef)), ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Features with significant differences in abundances.")
}
invisible(tab)
}
tab <- res_table(VenvsPlas)
y = "CapvsVen"
plot_volcano(res, "CapvsVen")
res_table <- function(x) {
## Write result table
if (any(rowData(x)$significant)) {
tab <- rowData(x)[rowData(x)$significant,
c("mzmed", "rtmed", "coef", "adjp",
"avg.Cap", "avg.Ven", "RSD_QC", "Dratio")]
tab <- tab[order(tab$adjp, abs(tab$coef)), ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Features with significant differences in abundances.")
}
invisible(tab)
}
tab <- res_table(CapvsVen)
plot_volcano(res, "CapvsPlas")
res_table <- function(x) {
## Write result table
if (any(rowData(x)$significant)) {
tab <- rowData(x)[rowData(x)$significant,
c("mzmed", "rtmed", "coef", "adjp",
"avg.Ven", "avg.Plas", "RSD_QC", "Dratio")]
tab <- tab[order(tab$adjp, abs(tab$coef)), ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Features with significant differences in abundances.")
}
invisible(tab)
}
tab <- res_table(VenvsPlas)
res_table <- function(x) {
## Write result table
if (any(rowData(x)$significant)) {
tab <- rowData(x)[rowData(x)$significant,
c("mzmed", "rtmed", "coef", "adjp",
"avg.Ven", "avg.Plas", "RSD_QC", "Dratio")]
tab <- tab[order(tab$adjp, abs(tab$coef)), ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Features with significant differences in abundances.")
}
invisible(tab)
}
tab <- res_table(res, "VenvsPlas")
res_table <- function(x, contrast) {
## Write result table
sigs <- rowData(x)[, paste0("significant.", contrast)]
tab <- rowData(x)[sigs,
c("mzmed", "rtmed", paste0("coef.", contrast),
paste0("adjp.", contrast),
"avg.Cap", "avg.Ven", "avg.Plas", "RSD_QC", "Dratio")]
tab <- tab[order(tab$adjp, abs(tab$coef)), ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Features with significant differences in abundances.")
invisible(tab)
}
tab <- res_table(res, "CapvsVen")
res_table <- function(x) {
## Write result table
if (any(rowData(x)$significant)) {
tab <- rowData(x)[rowData(x)$significant,
c("mzmed", "rtmed", "coef", "adjp",
"avg.Plas", "avg.Ven", "RSD_QC", "Dratio")]
tab <- tab[order(tab$adjp, abs(tab$coef)), ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Features with significant differences in abundances.")
}
invisible(tab)
}
tab <- res_table(PlasvsVen)
res_table <- function(x) {
## Write result table
if (any(rowData(x)$significant)) {
tab <- rowData(x)[rowData(x)$significant,
c("mzmed", "rtmed", "coef", "adjp",
"avg.Plas", "avg.Ven", "RSD_QC", "Dratio")]
tab <- tab[order(tab$adjp, abs(tab$coef)), ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Features with significant differences in abundances.")
}
invisible(tab)
}
tab <- res_table(VenvsPlas)
res_table <- function(x) {
## Write result table
if (any(rowData(x)$significant)) {
tab <- rowData(x)[rowData(x)$significant.VenvsPlas,
c("mzmed", "rtmed", "coef", "adjp",
"avg.Plas", "avg.Ven", "RSD_QC", "Dratio")]
tab <- tab[order(tab$adjp, abs(tab$coef)), ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Features with significant differences in abundances.")
}
invisible(tab)
}
tab <- res_table(res)
res_table <- function(x) {
## Write result table
if (any(rowData(x)$significant.VenvsPlas)) {
tab <- rowData(x)[rowData(x)$significant.VenvsPlas,
c("mzmed", "rtmed", "coef", "adjp",
"avg.Plas", "avg.Ven", "RSD_QC", "Dratio")]
tab <- tab[order(tab$adjp, abs(tab$coef)), ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Features with significant differences in abundances.")
}
invisible(tab)
}
tab <- res_table(res)
add_result <- function(x) {
## Generate result data frame
tmp <- data.frame(
coef = fit$coefficient[, "VenvsPlas"],
pvalue = fit$p.value[, "VenvsPlas"],
adjp = p.adjust(fit$p.value[, "VenvsPlas"], method = "BH"),
avg.Ven = rowMeans(
log2(assay(x, "normalized_filled_imputed")[, x$source == "capillary"])),
avg.Plas = rowMeans(
log2(assay(x, "normalized_filled_imputed")[, x$source == "plasma"]))
)
## Evaluate which features are significant
tmp$significant <- abs(tmp$coef) > m.cut & tmp$adjp < p.cut
tmp$RSD_QC <- rsds[rownames(rowData(x))]
tmp$Dratio <- dratios[rownames(rowData(x))]
## Add data frame to res
rowData(x) <- cbind(rowData(x), tmp)
x
}
VenvsPlas <- add_result(res)
res_table <- function(x) {
## Write result table
if (any(rowData(x)$significant)) {
tab <- rowData(x)[rowData(x)$significant,
c("mzmed", "rtmed", "coef", "adjp",
"avg.Plas", "avg.Ven", "RSD_QC", "Dratio")]
tab <- tab[order(tab$adjp, abs(tab$coef)), ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Features with significant differences in abundances.")
}
invisible(tab)
}
tab <- res_table(VenvsPlas)
## Create heatmap
tmp <- log2(assay(
VenvsPlas, "normalized_filled_imputed")[rownames(tab), , drop = FALSE])
tmp <- tmp - rowMeans(tmp, na.rm = TRUE)
ann <- as.data.frame(colData(VenvsPlas)[, c("source", "sex")])
##pm <- pheatmap(tmp, annotation_col = ann, labels_col = 1:ncol(res),
#               annotation_color = list(group = col_group,
#                                   sex = col_sex))
pm <- pheatmap(tmp, annotation_col = ann, labels_col = colnames(tmp),
annotation_color = list(source = col_source,
sex = col_sex))
add_result <- function(x) {
## Generate result data frame
tmp <- data.frame(
coef = fit$coefficient[, "CapvsPlas"],
pvalue = fit$p.value[, "CapvsPlas"],
adjp = p.adjust(fit$p.value[, "CapvsPlas"], method = "BH"))
## Evaluate which features are significant
tmp$significant <- abs(tmp$coef) > m.cut & tmp$adjp < p.cut
tmp$RSD_QC <- rsds[rownames(rowData(x))]
tmp$Dratio <- dratios[rownames(rowData(x))]
## Add data frame to res
rowData(x) <- cbind(rowData(x), tmp)
x
}
CapvsPlas <- add_result(res)
res_table <- function(x) {
## Write result table
if (any(rowData(x)$significant)) {
tab <- rowData(x)[rowData(x)$significant,
c("mzmed", "rtmed", "coef", "adjp",
"avg.Cap", "avg.Plas", "RSD_QC", "Dratio")]
tab <- tab[order(tab$adjp, abs(tab$coef)), ]
pandoc.table(
as.data.frame(tab), style = "rmarkdown",
caption = "Features with significant differences in abundances.")
}
invisible(tab)
}
tab <- res_table(CapvsPlas)
