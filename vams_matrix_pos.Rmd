---
title: "Matrix comparison"
author: "Johannes Rainer, SÃ¸ren Fjelstrup, Chiara Volani and Giuseppe Paglia"
graphics: yes
output:
  BiocStyle::html_document:
    toc_float: true
bibliography: references.bib
csl: biomed-central.csl
references:
- id: dummy
  title: no title
  author:
  - family: noname
    given: noname
---

```{r biocstyle, echo = FALSE, results='hide', message = FALSE}
library(BiocStyle)
BiocStyle::markdown()
```

**Modified**: `r file.info("vams_matrix_pos.Rmd")$mtime`<br />
**Compiled**: `r date()`

```{r settings, echo = FALSE, results = "hide", message = FALSE, warning = FALSE}
#' Set general options
options(useFancyQuotes = FALSE)
set.seed(18011977)

#' Define paths:
filename <- "vams_matrix_pos"
#' Path to save the images; remove all old images.
IMAGE_PATH <- paste0("images/", filename, "/")
if (file.exists(IMAGE_PATH)) 
    unlink(IMAGE_PATH, recursive = TRUE)
dir.create(IMAGE_PATH, recursive = TRUE)
#' Path to store RData files
RDATA_PATH <- paste0("data/RData/", filename, "/")
if (!file.exists(RDATA_PATH)) dir.create(RDATA_PATH, recursive = TRUE)

#' Get the number of cpus allocated or fall back to 3
ncores <- as.integer(Sys.getenv("SLURM_JOB_CPUS_PER_NODE", 3))
```

# Introduction

In this document we evaluate differences between the 4 matrices (sample sources)
*venous*, *capillary*, *plasma* and *RBC*. We are specifically interested in
identifying features which are specific to one matrix or common to all matrices
(qualitative analysis) as well as features with different abundances between
matrices (quantitative analyses). For the former analysis we use determine for
each feature whether it is *present* in a sample or not based on whether a
chromatographic peak was identified for it. The latter analysis is based on the
feature abundances.

The analysis uses the normalized feature abundances generated in
[vams_normalization.Rmd](vams_normalization.Rmd). The normalized data contains
abundance estimates for all features that are present in at least 30% of samples
of a matrix (QC samples excluded). The abundances from the two technical
replicates of each sample were combined into a single feature abundance. Also,
weights have been defined that provide information about the *quality* of a
normalized feature concentration. It is based on whether a chromatographic peak
was identified in a sample and how similar the reported abundances for the
feature in the two (technical) replicates for each sample are. Based on their
weight, features can be classified into 6 different types:

- `1`: signal from 2 detected peaks present and the RSD of their abundances is <
  30%. The `mean` of the two is reported.
- `0.9`: 1 detected and one filled-in signal present and their RSD is < 30%. The
  `mean` of the two is reported.
- `0.8`: only filled-in signal, but their RSD is < 30%. The `mean` of the two is
  reported.
- `0.7`: signal for two detected peaks but their RSD is >= 30%. The `mean` of
  the two is reported.
- `0.5`: signal from 1 detected peak present (independently of whether a
  filled-in signal is present for the other replicate). Report only
  the value for the detected peak.
- `0.25`: only filled-in signal is present. Either mean or single value
  reported.

Below we load all required libraries, define a color for each matrix and load
the normalized data.

```{r load-data , results='hide', message = FALSE}
library(xcms)
library(RColorBrewer)
library(pander)
library(doParallel)
registerDoParallel(ncores)
register(DoparParam(), default = TRUE)
#' register(SerialParam())
library(SummarizedExperiment)
library(UpSetR)
library(pls)
library(caret)

#' Load utility functions for the analysis
source("util-functions.R")

#' Define colors for the groups.
col_source <- brewer.pal(5, name = "Set1")[c(1, 2, 4, 5)]
names(col_source) <- c("RBC",           #' red
                       "plasma",        #' blue
                       "capillary",     #' purple
                       "venous")        #' orange

load("data/RData/vams_normalization/vams_pos.RData")

#' Remove rows/features that have only missing values
#' vams_pos <- vams_pos[rowNaProp(assay(vams_pos, "abundances")) < 1, ]
#' vams_pos <- vams_pos[1:400, ]

```


## Identifying detected/present features for each matrix

We next aim to identify *present* (detected) features for each matrix which
allows to perform qualitative comparisons between the matrices. In contrast to
features with differences in abundances (identified in the next section) we do
not consider absolute intensities in this analysis but rather evaluate whether a
feature is detected in most samples of a matrix or not, i.e. whether a
chromatographic peak was identified or not. This information is encoded into th
*weight* of a measurement (see Introduction for the definition of the weights):
a chromatographic peak was detected for a feature in at least one of the two
replicates if the weight is either 1, 0.9, 0.7 or 0.5. Below we use these
weights to determine the proportion of samples for each matrix in which a
chromatographic peak was identified.

```{r proportion-detected, message = FALSE, warning = FALSE}
wght_detected <- c(1, 0.9, 0.7, 0.5)

#' Determine for each feature the proportion of samples (per matrix) in
#' which a peak was detected/
prop_detected <- apply(assay(vams_pos, "weights"), 1, function(x, grps) {
    vapply(split(x, grps), function(z) sum(z %in% wght_detected) / length(z),
           numeric(1))
}, grps = vams_pos$source)
prop_detected <- t(prop_detected)
```

Defining absent/present calls is not trivial. Using a hard cut-off on the
proportion of samples with a detected peak can be problematic, as features can
not be expected to be present in all samples. Sex-specific features would for
example be expected to be present in only 50% of samples. Requiring features to
be present in 60% of samples to define them as *present* would thus flag all
sex-specific features to be *absent*.

We therefore use an approach that compares, separately for each feature, and in
each matrix the number of samples in which a chromatographic peak was detected
to the maximum such number in any of the matrices. Specifically, features are
called *absent* in a certain matrix, if a peak was detected in less than one
third of the maximal number of samples with a detected peak in any of the
matrices. As example, if a feature was detected in 10 samples of a matrix, but
only in 3 in another matrix, it will be called *absent* in the latter. On the
other hand, if a feature was detected at most in 4 samples in a matrix, it is
still considered to be present in matrices in which e.g. in 2 samples a peak was
detected.

Below we calculate first the ratio between the proportion of samples in which a
peak was detected and the maximal proportion for that feature and subsequently
define the absent/present calls for each feature in each matrix based on these
values.

Note that the present analysis bases on features with a detected peak in at
least 1/3 of samples.

```{r present-absent-call, message = FALSE, warning = FALSE}
#' Calculate ratio between proportion and max proportion
prop_ratio <- (1 / rowMax(prop_detected)) * prop_detected

#' Define present/absent calls
present_call <- prop_ratio > 1/3
```


## Comparison of numbers of features detected in each matrix

With the present/absent calls available we can next evaluate the number of
features being detected in each matrix. The results are represented with the
barplot below.

```{r barplot-features, message = FALSE, warning = FALSE, echo = FALSE, fig.path = IMAGE_PATH, fig.cap = "Number of features detected by each matrix", fig.width = 6, fig.height = 8}
par(mfrow = c(1, 1), mar = c(7, 4.5, 2, 0.5))
barplot(colSums(present_call), col = col_source[colnames(present_call)],
        main = "Detected features", ylab = "count", las = 2)
```

Not unexpectedly, most features are present in venous samples followed by
capillary and RBC samples. The fewest are present in plasma samples. The numbers
are shown also in the table below.

```{r feature-count-table, results = "asis", echo = FALSE}
cpt <- paste0("Number of features detected in each matrix")
pandoc.table(colSums(present_call), style = "rmarkdown",
             caption = cpt)
```


## Matrix-specific features and features present in all matrices

We next compare the overlaps and intersects of features being *present* in the 4
matrices.

```{r upsetr-plot, message = FALSE, warning = FALSE, echo = FALSE, fig.path = IMAGE_PATH, fig.cap = "Visualisation of the feature intersects between the 4 matrices.", fig.width = 10, fig.height = 8}
ints <- apply(present_call, MARGIN = 2, which)
upset(fromList(ints), order.by = "freq",
      sets.bar.color = col_source[c("venous", "capillary", "RBC", "plasma")])
```

About one third of the ~ 10,000 features is detectable in all 4 matrices. The
next largest overlap with ~ 2,000 features is between venous, capillary and RBC
samples followed by about 1,200 features that are specific to plasma and venous
samples. Over and above the results are as expected, with the largest overlap of
matrices being between samples containing also blood cells. The numbers of
matrix-specific features is with ~ 200 - 600 relatively small, with plasma
samples having the largest number of unique features.

```{r plot-common-features, echo = FALSE, warning = FALSE,eval = FALSE}
load("data/RData/vams_normalization/data_pos.RData")
col_sample <- col_source[data_pos$source]

plot_feats <- function(x, col) {
    col_bg <- paste0(col[chromPeaks(x)[, "sample"]], 20)
    col_fg <- paste0(col[chromPeaks(x)[, "sample"]], 60)
    col_bg[grep("^NA", col_bg)] <- NA
    col_fg[is.na(col_bg)] <- NA
    col_smpl <- paste0(col, 30)
    col_smpl[grep("^NA", col_smpl)] <- NA
    plot(x, col = col_smpl, peakBg = col_bg, peakCol = col_fg)
}

#' Present in all
feats_common <- rownames(present_call)[rowSums(present_call) == 4]
dr <- paste0(IMAGE_PATH, "common_features/")
dir.create(dr, showWarnings = FALSE)
feats <- sample(feats_common, 20)
feats_chrs <- featureChromatograms(data_pos, expandRt = 4, features = feats)
for (i in seq_along(feats)) {
    fn <- paste0(dr, feats[i], ".png")
    png(fn, width = 10, height = 8, units = "cm", res = 200, pointsize = 6)
    plot_feats(feats_chrs[i, ], col = col_sample)
    dev.off()
}

#' Plasma
feats_plasma <- rownames(present_call)[rowSums(present_call) == 1 &
                                       present_call[, "plasma"]]
dr <- paste0(IMAGE_PATH, "plasma_features/")
dir.create(dr, showWarnings = FALSE)
## feats <- sample(feats_plasma, 20)
## feats_chrs <- featureChromatograms(data_pos, expandRt = 4, features = feats)
## for (i in seq_along(feats)) {
##     fn <- paste0(dr, feats[i], ".png")
##     png(fn, width = 10, height = 8, units = "cm", res = 200, pointsize = 6)
##     plot_feats(feats_chrs[i, ], col = col_sample)
##     dev.off()
## }
#' most specific:
feats <- feats_plasma[order(rowMeans(prop_ratio[feats_plasma, ]))][1:20]
feats_chrs <- featureChromatograms(data_pos, expandRt = 4, features = feats)
for (i in seq_along(feats)) {
    fn <- paste0(dr, feats[i], ".png")
    png(fn, width = 10, height = 8, units = "cm", res = 200, pointsize = 6)
    plot_feats(feats_chrs[i, ], col = col_sample)
    dev.off()
}

#' Venous
feats_venous <- rownames(present_call)[rowSums(present_call) == 1 &
                                       present_call[, "venous"]]
dr <- paste0(IMAGE_PATH, "venous_features/")
dir.create(dr, showWarnings = FALSE)
feats <- feats_venous[order(rowMeans(prop_ratio[feats_venous, ]))][1:20]
feats_chrs <- featureChromatograms(data_pos, expandRt = 4, features = feats)
for (i in seq_along(feats)) {
    fn <- paste0(dr, feats[i], ".png")
    png(fn, width = 10, height = 8, units = "cm", res = 200, pointsize = 6)
    plot_feats(feats_chrs[i, ], col = col_sample)
    dev.off()
}

#' RBC
feats_RBC <- rownames(present_call)[rowSums(present_call) == 1 &
                                    present_call[, "RBC"]]
dr <- paste0(IMAGE_PATH, "RBC_features/")
dir.create(dr, showWarnings = FALSE)
feats <- feats_RBC[order(rowMeans(prop_ratio[feats_RBC, ]))][1:20]
feats_chrs <- featureChromatograms(data_pos, expandRt = 4, features = feats)
for (i in seq_along(feats)) {
    fn <- paste0(dr, feats[i], ".png")
    png(fn, width = 10, height = 8, units = "cm", res = 200, pointsize = 6)
    plot_feats(feats_chrs[i, ], col = col_sample)
    dev.off()
}

#' Capillary
feats_capillary <- rownames(present_call)[rowSums(present_call) == 1 &
                                          present_call[, "capillary"]]
dr <- paste0(IMAGE_PATH, "capillary_features/")
dir.create(dr, showWarnings = FALSE)
feats <- feats_capillary[order(rowMeans(prop_ratio[feats_capillary, ]))][1:20]
feats_chrs <- featureChromatograms(data_pos, expandRt = 4, features = feats)
for (i in seq_along(feats)) {
    fn <- paste0(dr, feats[i], ".png")
    png(fn, width = 10, height = 8, units = "cm", res = 200, pointsize = 6)
    plot_feats(feats_chrs[i, ], col = col_sample)
    dev.off()
}


```

Some example data for features are shown below. The first shows an example for a
*common* feature, i.e. a feature that is present (although at difference
abundance) in all 4 matrices.

```{r out.width = "750px", echo = FALSE, fig.cap = "Feature present in all 4 matrices."}
knitr::include_graphics(paste0(IMAGE_PATH, "common_features/FT02184.png"))
```

Below an example for a plasma-only feature is shown. There seems to be some
signal also for some samples from other matrices, but that is mostly below
detection limit.

```{r out.width = "750px", echo = FALSE, fig.cap = "Plasma-specific feature."}
knitr::include_graphics(paste0(IMAGE_PATH, "plasma_features/FT00481.png"))
```

An example for a venous-specific feature is shown below.

```{r out.width = "750px", echo = FALSE, fig.cap = "Venous-specific feature."}
knitr::include_graphics(paste0(IMAGE_PATH, "venous_features/FT07248.png"))
```

An example for a RBC-only feature is shown below.

```{r out.width = "750px", echo = FALSE, fig.cap = "RBC-specific feature."}
knitr::include_graphics(paste0(IMAGE_PATH, "RBC_features/FT02578.png"))
```

An example for a capillary-specific feature is shown below.

```{r out.width = "750px", echo = FALSE, fig.cap = "Capillary-specific feature."}
knitr::include_graphics(paste0(IMAGE_PATH, "capillary_features/FT01583.png"))
```

What seems to be common to all matrix-specific features is that their abundance
is moderate. Below we thus evaluate whether the average abundance level of
matrix-specific features is different to those from common features.

```{r matrix-specific-abundance, message = FALSE, fig.path = IMAGE_PATH, fig.cap = "Distribution of average (across samples) abundances of common and matrix-specific features.", fig.width = 6, fig.height = 8}
feats_common <- rownames(present_call)[rowSums(present_call) == 4]
feats_plasma <- rownames(present_call)[rowSums(present_call) == 1 &
                                       present_call[, "plasma"]]
feats_venous <- rownames(present_call)[rowSums(present_call) == 1 &
                                       present_call[, "venous"]]
feats_RBC <- rownames(present_call)[rowSums(present_call) == 1 &
                                    present_call[, "RBC"]]
feats_capillary <- rownames(present_call)[rowSums(present_call) == 1 &
                                          present_call[, "capillary"]]

ints <- list(
    common = apply(assay(vams_pos, "abundances")[feats_common, ],
                   MARGIN = 1, mean),
    plasma = apply(assay(vams_pos, "abundances")[feats_plasma,
                                                 vams_pos$source == "plasma"],
                   MARGIN = 1, mean),
    venous = apply(assay(vams_pos, "abundances")[feats_venous,
                                                 vams_pos$source == "venous"],
                   MARGIN = 1, mean),
    RBC = apply(assay(vams_pos, "abundances")[feats_RBC,
                                              vams_pos$source == "RBC"],
                MARGIN = 1, mean),
    capillary = apply(assay(vams_pos, "abundances")[feats_capillary,
                                                    vams_pos$source == "capillary"],
                      MARGIN = 1, mean)
)
par(mar = c(7, 4.5, 1, 1))
boxplot(lapply(ints, log2), varwidth = TRUE, col = col_source[names(ints)],
        ylab = expression(log[2]~abundance), las = 2, main = "average abundance")
grid(nx = NA, ny = NULL)
```

Indeed, the average abundance of matrix-specific features seems to be about
two-fold lower than the abundance of *common* features. Thus many features might
appear to be matrix specific because their abundance is below the detection
limit in other matrices.


## Grouping samples based on metabolite abundances

We perform a principal component analysis to evaluate the grouping of the
samples/matrices in our experiment.

```{r pca-rsd, message = FALSE, warning = FALSE, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 10, fig.height = 10, fig.cap = "PCA grouping samples based on (centered) feature abundances. Only features with an RSD < 30% in QC samples were used. Circles represent samples from female, rectangles from male participants. Missing values were replaced with half of the feature's minimal abundance adding also a small random variance."}
#' RSD < 30% in QC samples
tmp <- log2(assay(vams_pos, "abundances")[which(rowData(vams_pos)$QC_rsd < 0.3), ])
na_prop <- rowNaProp(tmp)
tmp <- imputeRowMinRand(tmp, min_fraction = 1/2)
pc <- prcomp(t(tmp), scale = FALSE, center = TRUE)
pchs <- ifelse(vams_pos$sex == "F", 21, 22)

par(mfrow = c(1, 2), mar = c(4.5, 4.5, 1, 1))
plot_pca(pc, pc_x = 1, pc_y = 2, col = paste0(col_source[vams_pos$source], "ce"),
         bg = paste0(col_source[vams_pos$source], 60), pch = pchs, cex = 1.5)
legend("bottomright", col = col_source, legend = names(col_source), pch = 16)
plot_pca(pc, pc_x = 3, pc_y = 4, col = paste0(col_source[vams_pos$source], 80),
         bg = paste0(col_source[vams_pos$source], 40), pch = pchs, cex = 1.5)



```

The PCA above was performed on all features that have an RSD < 30% in QC samples
(about 4000). Missing values were replaced with half of the feature's smallest
abundance adding also a small random value based on the features' standard
deviations. Note that excluding features with `NA` values (~ 1000) or performing
the PCA on all over 10,000 features yielded the same result (data not shown).

As expected, a clear separation of plasma samples from all other samples
(containing also blood cells) can be observed on PC1. Capillary and red blood
cell samples cluster close together, with some RBC samples being closest to the
cluster consisting of venous samples. Both show however a stronger variation
(especially in PC2) than plasma or venous samples. On PC3 we can see again a
separation by matrix, with plasma and venous samples being closest. The
separation on PC3 could reflect the different sampling source, i.e. sampling
from the finger tip with the Mitra device (capillary) *vs* sampling from
intravenous blood (venous, plasma and RBC).


## Identifying features with differential abundance between the matrices

It is possible that the differences seen in the previous PCA plots are due to
overall concentration differences. Thus each of the sample types were plotted to 
see if significant differences in overall concentration is found.

```{r BoxplotOfAbundances, fig.cap = "The average abundances of each of the features within a matrix."}

#' All feautures present in the respective sample types are found. Note this is different to when only the unique were found.
feats_plasma <- rownames(present_call)[present_call[, "plasma"]]
feats_venous <- rownames(present_call)[present_call[, "venous"]]
feats_RBC <- rownames(present_call)[present_call[, "RBC"]]
feats_capillary <- rownames(present_call)[present_call[, "capillary"]]

#' A list containing the abundances of the respective features were made. Note that they are imputed as it otherwise have too many missing values
ints <- list(
  common =  imputeRowMinRand( assay(vams_pos, "abundances")[feats_common,]
                               , min_fraction = 1/2, sd_fraction = 1, abs = TRUE), 
  
  plasma = imputeRowMinRand( assay(vams_pos, "abundances")[feats_plasma,
    vams_pos$source == "plasma"], min_fraction = 1/2, sd_fraction = 1, abs = TRUE),
    
    venous = imputeRowMinRand( assay(vams_pos, "abundances")[feats_venous,
    vams_pos$source == "venous"], min_fraction = 1/2, sd_fraction = 1, abs = TRUE),
    
    RBC = imputeRowMinRand( assay(vams_pos, "abundances")[feats_RBC,
    vams_pos$source == "RBC"], min_fraction = 1/2, sd_fraction = 1, abs = TRUE),

    capillary = imputeRowMinRand( assay(vams_pos, "abundances")[feats_capillary,
vams_pos$source == "capillary"], min_fraction = 1/2, sd_fraction = 1, abs = TRUE)
)
  
#' Boxplot showing the distributions of the different groups
par(mar = c(7, 4.5, 1, 1))
boxplot(lapply(ints, log2), varwidth = TRUE, col = col_source[names(ints)],
        ylab = expression(log[2]~abundance), las = 2, main = "average abundance")
```

The boxplots indicate that while some differences exist but the abundances are
mostly the same.

Box plots are somewhat are best for finding large differences, so a cumulative
distribution function was in addition made for each of the sample types.
This should show whether the distributions are somewhat identical.

```{r CumulativeDistributionFunctionsOfAbundances, fig.cap = "Cumulative density function of each matrix"}
#' Cumulative distribution functions are made for the different groups, log2 is necessary due to the large differences in abundances
plasma_ecdf <- ecdf(unlist(lapply(ints$plasma, log2)))
venous_ecdf <- ecdf(unlist(lapply(ints$venous, log2))) 
RBC_ecdf <- ecdf(unlist(lapply(ints$RBC, log2)))
capillary_ecdf <- ecdf(unlist(lapply(ints$capillary, log2)))

plot(plasma_ecdf, col = col_source["plasma"], main = "cdf of abundance",
     xlab = "log2 abundance", ylab = "Density" , xlim = c(0,20), ylim = (c(0,1)))
lines(venous_ecdf, col = col_source["venous"])
lines(RBC_ecdf, col = col_source["RBC"])
lines(capillary_ecdf, col = col_source["capillary"])

legend('left', c("plasma","venous","RBC","capillary"), fill = col_source[
  c("plasma","venous","RBC","capillary")], border=NA)
```

Two plots are made. The first shows the overall cumulative distribution.
Here it is seen that the abundances of the features for the RBC is the lowest,
and the plasma is the highest, the venous and capillary are comparable.
the second plot shows the low abundancy in more detail.
The distributions are however close so it is not expected to be a big problem.

# Unsupervised modelling

A PCA of the samples, based on the features which for all the sources are found
in at least 30% of the samples within that source. This means that all features 
specific for a matrix is excluded. Thus it is expected that the seperation will 
be much smaller than the earlier PCA plot.

```{r PCAOfAbundances, fig.cap = "PCA of all common features by abundance"}

#' A PCA is performed of the samples.
pc <- prcomp(t(ints$common), scale = FALSE, center = TRUE)
pchs <- ifelse(vams_pos$sex == "F", 21, 22)

par(mfrow = c(1, 2), mar = c(4.5, 4.5, 1, 1))
plot_pca(pc, pc_x = 1, pc_y = 2, col = paste0(col_source[vams_pos$source], "ce"),
         bg = paste0(col_source[vams_pos$source], 60), pch = pchs, cex = 1.5)
legend("topleft", col = col_source, legend = names(col_source), pch = 16)
plot_pca(pc, pc_x = 3, pc_y = 4, col = paste0(col_source[vams_pos$source], 80),
         bg = paste0(col_source[vams_pos$source], 40), pch = pchs, cex = 1.5)


```

The first and second dimension is dominated by 6 samples.
To identify these, the samples were filtered for low values in the 1st and 2nd dimension.

Then the features were ranked according to loading in the first dimension. 



```{r Outlier, fig.cap = "The 10  features with the most negative values in the 1st dimension of the PCA. These were chosen based on their loadings in the first dimension. Two features FT08876 and FT08384 have a much higher weigth than the rest of the features"}
#' The Outliers are found and the loadings in PC1 is sorted to find the features responsible.
OutlierFilter <- (pc$x[, 1]<(-1e+5) & pc$x[, 2] < 0)
(OutlierFilter[OutlierFilter])

sortedLoading <- sort(pc$rotation[,1])
plot(sortedLoading[1:10], xlab = "Rank in 1st dimension loading", ylab =  "1st dimension loading weight")
(sortedLoading[1:2])
#' The two outlier features are defined
feats <- c(names(sortedLoading[1:2]))
```
The samples were identified as:
(venous-7","capillary-17","capillary-19","capillary-16","venous-18","capillary-18")
these seem to be clear outlier samples, indeed if the loadings in the first and
second dimension is found it is seen that that they have just 2 outlier features
("FT08876","FT08384").


It was then decided to look at the chromatograms of the two features to determine
whether it could be found why they are so different.

```{r Chromatogram, eval=FALSE}
dr <- paste0(IMAGE_PATH, "Outlier_features/")
dir.create(dr, showWarnings = FALSE)


feats <- c("FT08876","FT08384")
feats_chrs <- featureChromatograms(data_pos, expandRt = 4, features = feats)
for (i in seq_along(feats)) {
    fn <- paste0(dr, feats[i], ".png")
    png(fn, width = 10, height = 8, units = "cm", res = 200, pointsize = 6)
    plot_feats(feats_chrs[i, ], col = col_sample)
    dev.off()
}
```

Here it is evident that for the outlier samples these features have values much
higher than the rest of the samples.
It is unclear if the smaller peaks at the lower retention times should be
included here as well.

Knowing this, a new PCA is performed excluding these features.

```{r OutlierFilteredPCA, fig.cap = "PCA of abundances of all common features, with FT08876 and FT08384 removed. Only the plasma samples seperate from the other samples, in the 2nd dimension"}


#' PCA without the outliers are made
intsCommonNoOutliers <- ints$common[!(rownames(ints$common) %in% feats), ] 

pc <- prcomp(t(intsCommonNoOutliers), scale = FALSE, center = TRUE)
pchs <- ifelse(vams_pos$sex == "F", 21, 22)

par(mfrow = c(1, 2), mar = c(4.5, 4.5, 1, 1))
plot_pca(pc, pc_x = 1, pc_y = 2, col = paste0(col_source[vams_pos$source], "ce"),
         bg = paste0(col_source[vams_pos$source], 60), pch = pchs, cex = 1.5)
legend("topright", col = col_source, legend = names(col_source), pch = 16)
plot_pca(pc, pc_x = 3, pc_y = 4, col = paste0(col_source[vams_pos$source], 80),
         bg = paste0(col_source[vams_pos$source], 40), pch = pchs, cex = 1.5)



```

Removing the outliers resulted in a plot without any real discernable differences
between the groups, apart from the plasma which seperates from all other sources,
in the second dimension. No seperation were seen in other dimensions (data not shown)




# Supervised modelling

## Linear Model - no confounding effects
The multiple linear regression of the features is made without imputation.
The models were made using the capillary as a baseline. Since the RBC and the
plasma were made from the venous it is expected to see large differences in all 
the models made. Although it would be expected that the pure venous would be the
most alike to the capillary.

The first models are made with no confounding effects included in the model.
```{r ModelforlinearmodelVSplasmanoconfounding, echo = FALSE }
SourcesTypes <- c("sourceplasma","sourceRBC","sourcevenous")

#' The function for the multiple linear regression is made. This takes a numeric
#' input along with a matrix containing the confounding factors, it returns the
#' means and the p value
fitlmFunction <- function(x,dataMat){
  dataMat <- cbind(conc = x,as.data.frame(dataMat))
  dataMat$source <- factor(x = vams_pos$source, 
                           levels = c("capillary", "plasma", "RBC", "venous"))
  
  mdl <- lm(conc ~ source,data = dataMat)
  smry <- data.frame(summary(mdl)$coefficients)
  
  Output <- c(coef = smry[SourcesTypes, 1], pvalue =  smry[SourcesTypes, 4])
  names(Output) <- c(paste0("coef.",SourcesTypes), paste0("pvalue.", SourcesTypes))
  Output
}

#' The data is log2 transformed to make it mostly gaussian in distribution  
Data <- log2(assay(vams_pos, "abundances"))
fitMatrix <- t(apply(Data[, , drop=FALSE],1,fitlmFunction,dataMat=colData(vams_pos)))
p.adjusted <- apply(fitMatrix[,paste0("pvalue.", SourcesTypes)], 2, p.adjust,method="BH")
#' The fitMatrix is appened to the rest of the data in vams_pos, making the new dataframe res_Matrix_pos
res_Matrix_pos <- cbind(rowData(vams_pos),fitMatrix)
res_Matrix_posAdjusted<- cbind(rowData(vams_pos), adj = p.adjusted)
```

Histograms of each of the 3 matrixes against capillary is made.

```{r Histogramofpvalues, fig.cap = "Histogram of the p values each of the linear models against capillary. All histograms show a smooth decrease over the range of pvalues, indicating only a small possible effect from confounding factors"}
TestedSourcenames <-  c("plasma", "RBC", "venous")
par(mfrow=c(1, 3))
for (i in 1:3) {
hist(res_Matrix_posAdjusted[, paste0("adj.pvalue.", SourcesTypes[i])], main = paste0("Histogram of ", TestedSourcenames[i], " pvalues"), xlab = "pValue")
}


```

It looks like the p-values decrease gradually, this suggest that the effect of any
confounding effects are likely to be minor, compared to the overall differences
from the matrices.

Based on the models created in the previous section volcano plots are made for
each of the matrices compared to capillary.

```{r VolcanoPlotMultipleRegression, fig.cap = "Volcano plots of each of the linear models against capillary. Benjamini-Hochberg adjusted values, against the mean differences for each feature, show a large proportion of the features are statistically significantly different between matrixes"}
#' A new color set is defined to better conform to what is need by the volcano plot
col_volcano <- brewer.pal(4, name = "Set1")
col_volcano[1] <- "#DDDDDD" #' Grey
col_volcano <- paste0(col_volcano, 40)
#' The means for each feature for each source is found, likewise the limits for 
#' fold increase and pLimit is defined. The pvalue limit is bonferroni adjusted.
#' Note that this is only done for the common feautures
par(mar = rep(2, 4))
pLimit <- -log10(0.00001)
foldLimit <- 2

#' The filters for pvalue and fold increase is defined
colorFilterLowP <- -apply(res_Matrix_posAdjusted[, paste0("adj.pvalue.", SourcesTypes)], 2, 
                          log10) > pLimit
#' higfold is NOT a matrix, find way to reshape
colorFilterHighFold <- apply(res_Matrix_pos[,paste0("coef.", 
                          SourcesTypes)],2,abs) > foldLimit

#The filter for coloring the points is made
colorFilter <- 1 * colorFilterLowP
colorFilter[colorFilterHighFold] <- 2
colorFilter[colorFilterHighFold * colorFilterLowP == 1] <- 3
colorFilter <- colorFilter + 1


 par(mfrow=c(1, 3))
  for (i in 1:3){
    plot(res_Matrix_pos[,paste0("coef.", SourcesTypes[i])],  cex = 0.5,
         -log10(res_Matrix_posAdjusted[, paste0("adj.pvalue.", SourcesTypes[i])]), pch = 16, main = paste0("Capillary VS. ", TestedSourcenames[i] ), col = col_volcano[colorFilter[, i]], ylab = "-log10, Benjamini-Hochberg adjusted p-value", xlab = "log2 fold change")
  abline(h=pLimit)
  abline(v=foldLimit)
  abline(v=-foldLimit)
  legend("topleft", c("Lowp", "Highfold", "Significant"), col = col_volcano, pch = 16)
  }


```
A surprisingly large amount of features seem to be statistically different.
This was expected for the RBC and plasma, but not for the venous one.
Below is counted the amount of features which is significantly different for each of the matrixes

```{r count-table_linear_model, results = "asis", echo = FALSE}
cpt <- paste0("Number of significant features detected in each matrix")
pandoc.table(apply(colorFilter == 4, 2, sum, na.rm=TRUE), style = "rmarkdown", caption = cpt)
```

The large differences may have many sources. To help identify these it was
decided to probe the underlying disctributions of the features based on the two
two factors we know. The mass/charge ratio and the retention time.
it would be expected that the venous and capillary would be mostly the same with 
the plasma and RBC being different.

Plots showing the distributions of the matrixes based on mz were made.
```{r pValueDependencyOnmzNoconfounding, fig.cap = "Density distributions of matrices as a function of mz. Apart from the plasma, all the matrices share roughly the same distribution"}
col_source_trans <- paste0(col_source, 20)
names(col_source_trans) <- names(col_source)

#' Distributions of mz values for each matrix.
par(mfrow=c(1, 1))
plot(density(res_Matrix_posAdjusted$mzmed[present_call[, 1]], na.rm=TRUE), col = col_source[colnames(present_call)[1]], main = "Distribution of mz-values", xlab="mz", ylim = c(0,0.002))
for (i in 2:4) {
lines(density(res_Matrix_posAdjusted$mzmed[present_call[, i]], na.rm=TRUE), col = col_source[colnames(present_call)[i]])
}
legend("topleft", legend = c(colnames(present_call)), col = col_source[colnames(present_call)], pch = 16)



```

Looking at the first plot showing the distribution of all features as a function
of the mz, only the plasma is clearly different from the others. Here a higher 
proportion of medium-mz, and much fewer high-mz are found. This is not 
surprising. When making plasma weight weight compounds are removed from the matrix.
The mz roughly corresponds to what we would expect from diacyl-glycerols. (Fatty acids)



```{r mzSignificant, fig.cap = "Distributions of mz values for each matrix, significantly different compared to capillary. The amount of significantly different features of each matrix mostly conforms to the overall abundance of features. With some differences, most notably in the 600-800 range."}
plot(density(res_Matrix_posAdjusted$mzmed[], na.rm=TRUE), col = col_source["capillary"], main="Distribution of mz-values, significantly different from capillary", xlab = "mz", ylim = c(0,0.002))
for (i in 1:3) {
lines(density(res_Matrix_posAdjusted$mzmed[colorFilterLowP[, paste0("adj.pvalue.", SourcesTypes[i])]], na.rm=TRUE), col = col_source[TestedSourcenames[i]])
}
legend("topleft", legend=c("All features", TestedSourcenames), col = col_source[c("capillary", TestedSourcenames[1:3])], pch = 16)

```

More interestingly is the second plot. This includes only the features show to
be significantly different in the previous model. The overall shape is mostly the same.
Most features are found in the range with the most features overall. 
Interestingly the the features from venous, have a larger proportion in the medium-low range.
This range corresponds roughly to where sugars and steroids are expected to be found.
Not surprisingly the plasma has many features being significantly different at
the high range, as the matrix is missing many of these features all together.

As the previous plots does not show wheter a feature is over or underexpressed 
when compared to the capillary sample a new plot was made. This shows the
distributions split by wheter they are up- and downregulated in the matrix
compared to capillary.

```{r mzCountsSignificant, fig.cap = "Up- or downregulation of significant features. The up- or downregulation of significant features as a function of the retention time. Of note is how well the venous and plasma conform in upregulation in the 200-600 range. and how significantly the plasma is down regulated compared to the capillary in the 600-800 range."}
LowFilter <- as.matrix(res_Matrix_pos[, paste0("coef.", SourcesTypes)]) < -foldLimit
HighFilter <- as.matrix(res_Matrix_pos[, paste0("coef.", SourcesTypes)]) > foldLimit
par(mfrow=c(1, 1))
plot(x = 1, y = 1, pch = NA, xlim = c(50,1100), ylim = c(-100, 100), main =
  paste0("RT, up- or downregulation, significant pval - vs capillary "),xlab = "mz", ylab = "count")
for (i in 1:3){ 
 yHigh <- hist(res_Matrix_pos[which(HighFilter[
  , paste0("coef.", SourcesTypes[i])]),"mzmed"], breaks = seq(50, 1100, 5), plot = FALSE)
yLow <- hist(res_Matrix_pos[which(LowFilter[
  ,paste0("coef.", SourcesTypes[i])]),"mzmed"], breaks = seq(50, 1100, 5), plot = FALSE)
yLow$counts <- -yLow$counts
yLow$breaks <- yLow$breaks
lines(yHigh$breaks[-1], yHigh$counts, col = col_source[TestedSourcenames[i]],
      main = paste0("mz VS coeff, significant pval - ", TestedSourcenames[i]))
lines(yLow$breaks[-1], yLow$counts, col = col_source[TestedSourcenames[i]], 
      main = paste0("mz VS coeff, significant pval - ", TestedSourcenames[i]))
}
abline(h = 0)
legend("topright", legend = c(TestedSourcenames),
       col = col_source[TestedSourcenames[1:3]], pch = 16,inset = c(0, 0))

```

As expected the plasma sample is characterised by having fewer features in the
high mz range. Interestingly this seems to be periodic with a distance of about 
24 mz, corresponding to about 2 residues in the acyl chain of a fatty acid.


Likewise the distributions of the samples as a funcion of the rentention time was 
made.

```{r pvalueDependencyOnRetentionTimesNoConfounding, fig.cap = "Distribution of features as a function of retention time. The matrices most conform to one anothers distributions. with the exception of plasma. Plasma has major differences cross the entire range. likewise Venous has a higher density in the 150-175 sec range, but otherwise confroms."}
#' Distributions of retention times for each matrix.
plot(density(res_Matrix_pos$rtmed[present_call[, 1]], na.rm = TRUE), col =
       col_source[colnames(present_call)[1]], main="rt, values", xlab = "Retention time (sec)", ylim = c(0,0.016))
for (i in 2:4) {
lines(density(res_Matrix_pos$rtmed[present_call[, i]], na.rm=TRUE), col = col_source[colnames(present_call)[i]])
}
legend("topleft", legend = c(colnames(present_call)), col = col_source[colnames(present_call)], pch = 16)

```

Again the distributions of RBC and capillary are mostly the same. With the plasma
and to a smaller degree the venous being different.
The plasma have a lower overall proportion of long retention time samples and a
higher proportion of low and medium retention time features.
This goes against the theory that the differences seen for the mz is due to fatty acids.
If this was the case we would expect to see a low peak for the low retention time.
The opposite is seen, whereas a samples with a long retention time, i.e. being hydrophillic,
have a lower precense, thus whatever is missing in the plasma sample must be both
large and hydrophillic.
The venous and the plasma partly share a large peak in the medium range. 
It is unclear what would elute here. The venous otherwise follow the RBC and capillary.



```{r DistributionsRententionTimesForEachMatrixSignificant, fig.cap = "Distribution of features significantly different from capillary by retention time. Most differences are seen in 100-225 sec range, despite a significant proportion of features being in the 0-50 sec range. With Venous having almost no significant changes here."}
plot(density(res_Matrix_pos$rtmed[], na.rm=TRUE), col = col_source["capillary"], 
     main = "Retention times significantly different from capillary", xlab = 
       "Retention time (sec)", ylim = c(0,0.040))
for (i in 1:3) {
lines(density(res_Matrix_pos$rtmed[colorFilterLowP[, paste0("adj.pvalue.", 
    SourcesTypes[i])]], na.rm=TRUE), col = col_source[TestedSourcenames[i]])
}
legend("topleft", legend=c(TestedSourcenames, "All features"), col = 
         col_source[c(TestedSourcenames[1:3], "capillary")], pch = 16)
```

Looking at only the significantly different features a much more dramatic 
difference is seen for the samples. Although a large amount of the features have
low retention times, a comparatively smaller amount is significantly different here.
with especially the venous being virtually identical to the capillary here.
Most differences are found in the medium to medium-long retention times.
The venousespecially are found to be different in the medium range. 
The Plasma is not suprisingly mostly different in the high range. 
The RBC mostly follows the mean, apart from the low retention times.

Once again a plot showing the distributions split by wheter they are up- or
downregulated in the matrix compared to capillary, is made.

```{r rtVsCoeffSignificantPval, fig.cap = "Up- or downregulation of significant features as a function of retention time. Big differences are seen in certain areas of the distributions, with the most startlin the high peak shared by venous and RBC at 150-175 sec. and the general downregulation of plasma in the 150-200 sec range."}
LowFilter <- as.matrix(res_Matrix_pos[, paste0("coef.", SourcesTypes)]) < -foldLimit
HighFilter <- as.matrix(res_Matrix_pos[, paste0("coef.", SourcesTypes)]) > foldLimit
par(mfrow=c(1,1))
plot(x = 1,y = 1, pch = NA, xlim = c(15.7, 252), ylim = c(-350, 350),
     main = paste0("Rt, significant pval - vs capillary "), xlab = "Retention time", ylab = "count")
for (i in 1:3){ 
 yHigh <- hist(res_Matrix_pos[which(HighFilter[,
  paste0("coef.", SourcesTypes[i])]), "rtmed"], breaks=seq(0,250, 2), plot = FALSE)
yLow <- hist(res_Matrix_pos[which(LowFilter[ ,
  paste0("coef.", SourcesTypes[i])]),"rtmed"], breaks = seq(0, 250, 2), plot = FALSE)
yLow$counts <- -yLow$counts
yLow$breaks <- yLow$breaks

lines(yHigh$breaks[-1], yHigh$counts, col = col_source[TestedSourcenames[i]],
      main = paste0("Rt VS coeff, significant pval - ", TestedSourcenames[i]))
lines(yLow$breaks[-1], yLow$counts,col = col_source[TestedSourcenames[i]]
      , main=paste0("Rt VS coeff, significant pval - ", TestedSourcenames[i]))
}
legend("topright", legend = c(TestedSourcenames),
       col = col_source[TestedSourcenames[1:3]], pch = 16, inset = c(0, 0))

```

This plot is very interesting. The original peaks in the low retention time range
is now split into three. The first peaks is overrepresentated in both RBC and plasma.
the second is overrepresentated in the plasma, but under in the RBC. The last peak
is both over- and underrepresentated in plasma, but only underrepresentated in the RBC.
Venous is moderate in the entire range.

The medium range is much more interesting. Here, the venous follows either the RBC
at or the plasma closely. e.g. at around 160 sec the plasma and venous are 
identical for a very large peak, which is missing in the RBC. from aprox. 
170-200 sec the plasma have many low abundancy features wheres the venous and
RBC are identical with medium values.


# Session information

```{r sessionInfo}
devtools::session_info()
```

# References
