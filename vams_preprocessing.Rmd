---
title: "Preprocessing of the vams vs intraveneous untargeted metabolomics data"
author: "Johannes Rainer, Giuseppe Paglia and Sigurdur Smarason"
graphics: yes
output:
  BiocStyle::html_document:
    toc_float: true
bibliography: references.bib
csl: biomed-central.csl
references:
- id: dummy
  title: no title
  author:
  - family: noname
    given: noname
---

```{r biocstyle, echo = FALSE, results = "asis" }
library(BiocStyle)
BiocStyle::markdown() 
```

**Modified**: `r file.info("vams_preprocessing.Rmd")$mtime`<br />
**Compiled**: `r date()`

```{r settings, echo = FALSE, results = "hide", message = FALSE}

## Set general options
options(useFancyQuotes = FALSE)
set.seed(18011977)

## Define paths:
filename <- "vams_preprocessing"
## Path to save the images; remove all old images.
IMAGE_PATH <- paste0("images/", filename, "/")
if (file.exists(IMAGE_PATH))
    unlink(IMAGE_PATH, recursive = TRUE)
dir.create(IMAGE_PATH, recursive = TRUE)
## Path to store RData files
RDATA_PATH <- paste0("data/RData/", filename, "/")
if (!file.exists(RDATA_PATH)) dir.create(RDATA_PATH, recursive = TRUE)

## Define the path where we can find the mzML files:
MZML_PATH <- "~/data/2018/"
if (!file.exists(MZML_PATH))
    stop("Can not find the directory with the mzML files: ", MZML_PATH)

## Wheter all calculations should be performed or cached data is to be used.
use_cached <- FALSE
## Run only the chunks that are required to produce the data.
just_analysis <- FALSE

## Where to cut the chromatogram (i.e. subset to spectra within rt 0-rt_cut)
rt_cut <- 250

```

# Introduction

In this section we perform the pre-processing of the untargeted metabolomics
data of the *MitYOU* project which comprises an initial quality assessment,
chromatographic peak detection, alignment (retention time correction) and
correspondence (chromatographic peak grouping across samples).

The input files represent centroided data, with centroiding performed using the
`MSnbase` package based on the following settings: smoothing of the signal in
retention time dimension by averaging signal from 3 neighboring spectra in a
moving window approach followed by smoothing of each spectrum (along the m/z
dimension) using a Savitzky-Golay filter with a half window size of 6. The data
was subsequently centroided refining in addition the centroid's m/z value with
an intensity-weighted average of m/z values for signal within the peak with at
least 33% of the centroid's intensity.

# Positive polarity

We first focus on the data in positive polarity.

## Raw data import and initial quality assessment

Below we load all required libraries for the analysis as well as the *phenodata*
file defining the experiment's layout. Also, we set up the parallel processing,
define colors to be used for the various experimental groups throughout the
experiment and finally read the raw data.

```{r pos-libraries-data, message = FALSE}
library(xcms)
library(RColorBrewer)
library(pander)
library(doParallel)
registerDoParallel(3)
register(DoparParam(), default = TRUE)

pd <- read.table("data/phenodata.txt", sep = "\t", as.is = TRUE, header = TRUE)
pd_pos <- pd[pd$polarity == "POS", ]

## Define colors for the groups.
col_source <- brewer.pal(5, name = "Set1")
names(col_source) <- c("RBC",           # red
                       "plasma",        # blue
                       "all",           # green
                       "capillary",     # purple
                       "venous")        # orange
## Read the data
data_pos <- readMSData(paste0(MZML_PATH, sub(".mzML", "_csp1_SG6_dp33.mzML",
                                             pd_pos$mzML_file)),
                       pdata = as(AnnotatedDataFrame(pd_pos),
                                  "NAnnotatedDataFrame"), mode = "onDisk")
```

All samples of the experiment are listed below.

```{r pos-phenodata, message = FALSE, results = "asis", echo = FALSE}
validatePdata <- function(x) {
    src <- c(`1` = "plasma", `2` = "venous", `3` = "capillary", RBC = "RBC")
    fn <- strsplit(x$mzML_file, split = "_")
    for (i in 1:nrow(x)) {
        splt <- fn[[i]]
        if (splt[1] != x$batch[i])
            message("Row ", i, ": batch wrong")
        if (length(splt) == 5) {
            if (as.numeric(splt[2]) != x$sample[i])
                message("Row ", i, ": sample wrong")
            if (src[splt[3]] != x$source[i])
                message("Row ", i, ": source wrong")
            if ((splt[4] == "a" & x$replicate[i] != 1) ||
                (splt[4] == "b" & x$replicate[i] != 2))
                message("Row ", i, ": replicate wrong")
        } else {
            if (x$sample[i] != "POOL")
                message("Row ", i, ": sample wrong")
        }
    }
}
## validatePdata(pData(data_pos))

tab <- pData(data_pos)[, -4]
pandoc.table(tab, style = "rmarkdown",
             caption = paste0("Data files and samples for positive polarity"))

```

The data set consists thus of samples from in total 22 individuals, with
measurements performed on plasma, venous and capillary blood samples as well as
on red blood cells for each. Measurements were performed in two runs, with each
sample measured in duplicates within each run. A pool of all samples (all
sources and samples) was used as quality control and repeatedly measured (every
9 injections) during a measurement run. The injection order layout of one
measurement run is visualized below.

```{r pos-run-plot, fig.width = 10, fig.height = 2, fig.path = IMAGE_PATH, fig.cap = "Layout of a measurement run."}
tmp <- pData(data_pos)[data_pos$batch == 31012018, ]
par(mar = c(2, 0, 2, 0))
plot(3, 3, pch = NA, xaxt = "n", yaxt = "n", ylim = c(0, 2),
     xlim = c(0.5, nrow(tmp) + 0.5), bty = "n")
rect(xleft = tmp$inj_idx - 0.5, xright = tmp$inj_idx + 0.5, ybottom = 0,
     ytop = 1, col = col_source[tmp$source], border = "grey")
axis(side = 1, line = 0, las = 2)
text(x = tmp$inj_idx, y = rep(0.5, nrow(tmp)), labels = tmp$sample,
     srt = 90, cex = 0.7)
legend("top", col = col_source, legend = names(col_source), horiz = TRUE,
       pch = 15)
```

Sample source type and individuals are randomly distributed along the injection
order.

Next we perform an initial quality assessment by comparing the distribution of
TIC and BPC values from the spectra between all samples.

```{r pos-calc-tic, message = FALSE}
chrs_tic <- chromatogram(data_pos, aggregationFun = "sum")
chrs_bpc <- chromatogram(data_pos, aggregationFun = "max")
```

The base peak chromatogram for the full experiment is shown below.

```{r pos-bpc-plot, message = FALSE, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 12, fig.height = 5, fig.cap = "Base peak chromatograms for all samples of the experiment (positive polarity)."}
plot(chrs_bpc, col = paste0(col_source[chrs_bpc$source], "60"))
legend("topright", col = col_source, legend = names(col_source), lwd = 2)

```

The base peak chromatograms are quite different between the different sample
sources. Plasma and venous samples have considerably higher signal in the
retention time range from 170 to 200 seconds. For most other parts similar the
BPC shows similar signal suggesting that similar compounds are
detected. Individual capillary blood samples show a distinct BPC potentially
indicating problems in sample preparation and/or measurement.

Next we evaluate the distribution of base peak and total ion values per sample
to identify potentially problematic samples/injections. In addition we calculate
per-sample RLA (relative log abundance) [@DeLivera:2012bw] values representing
average log2 signal (either base peak or total ion) of each sample relative to
the median log2 signal of all samples within the same group. The per sample RLA
values help to spot samples with an overall different average signal compared to
all other samples within the same sample group, which is in our case the sample
source.

```{r pos-bpc-boxplot, message = FALSE, fig.path = IMAGE_PATH, fig.width = 12, fig.height = 6, fig.cap = "Distribution of the spectras' base peak signal per sample (top) and average RLA of base peak signals per sample (bottom)."}
## function taken from BioCHRIStes... eventually add to xcms?
rla <- function(x, group, log.transform = TRUE) {
    if (missing(group))
        group <- rep_len(1, length(x))
    if (length(x) != length(group))
        stop("length of 'x' has to match length of 'group'")
    if (!is.factor(group))
	group <- factor(group, levels = unique(group))
    ## Calculate group medians.
    if (log.transform)
        log_x <- log2(x)
    grp_meds <- unlist(lapply(split(log_x, group), median, na.rm = TRUE))
    log_x - grp_meds[group]
}

bpcs <- lapply(chrs_bpc, intensity)
xl <- c(1, length(bpcs))
par(mfrow = c(2, 1), mar = c(0, 4.3, 0, 0.1))
boxplot(lapply(bpcs, log2), col = paste0(col_source[chrs_bpc$source], 60),
        pch = NA, xaxt = "n", ylab = expression(log[2]~base~peak~intensity),
        xlim = xl)
grid(nx = NULL)
par(mar = c(3, 4.3, 0.5, 0.1))
bpcs_rla <- rla(vapply(bpcs, mean, numeric(1)), group = chrs_bpc$source)
plot(bpcs_rla, xlab = "", ylab = "average RLA", xlim = xl,
     col = paste0(col_source[chrs_bpc$source], 80), pch = 16)
grid(nx = NULL)


```

Overall seen, the signal in the second batch is higher than in the first,
specifically if the QC samples from both batches are compared (green colored
boxes or points), that show an about two-fold higher overall signal in the
second batch. The distribution of base peak signals varies between samples with
stretches of measurements in both batches showing lower distribution than
samples measured before or after. Two red blood cell samples (one in the first
and one in the second) have much lower average base peak intensities, most
likely due to a failed injection (because the signal of the replicated
measurement is *normal*) and should thus be excluded from the analysis. Below we
list all samples for which one replicate yielded a more than two-fold difference
in average base peak signal.

```{r pos-bpc-outlier}
outl <- abs(bpcs_rla) > 1
outl_smps <- paste0(chrs_bpc$sample[outl], chrs_bpc$source[outl])
all_outl <- paste0(chrs_bpc$sample, chrs_bpc$source) %in% outl_smps
tab <- cbind(pData(chrs_bpc)[all_outl, ], bpc_rla = bpcs_rla[all_outl])

pandoc.table(tab[order(abs(tab$bpc_rla), decreasing = TRUE), ],
             style = "rmarkdown", split.table = Inf)
             caption = paste0("Samples for which one replicated measurement ",
                              "had a more than two-fold difference in average",
                              " base peak intensity."))
```

For all of the above samples one of the two replicates yielded a more than
two-fold difference in average base peak intensity, while the other did not. We
might thus exclude the problematic replicate for these samples. The two
capillary blood samples with a higher average intensity are most likely those
that showed also higher signal in the base peak chromatogram plot above. The
results on the total ion signal (i.e. the sum of signal per spectrum) is
comparable, but less pronounced (data not shown).

### Summary

The base peak and total ion chromatogram between samples from the various
sources are different. The distribution of signals does also show a relatively
large variation between all samples and batches, with the signal being generally
higher in the second batch. Four potentially problematic samples have been
spotted that show either more than two-fold lower or higher average base peak
intensity than other samples from the same source. These are two RBC and two
capillary blood samples. This is most likely caused by a failed/problematic
injection, because one replicate is affected.


## Chromatographic peak detection

- Perform peak detection.
- Compare numbers of identified peaks across samples.
- Compare intensity distributions across samples.
- Image of peak positions along retention time.
- Check chromatographic peaks for some known controls.

### Summary

## Alignment

### Summary

## Correspondence

- Categorize features: those with a single peak per sample and those with
  multiple.
- Check data for features with multiple peaks per sample.

### Summary

# References
