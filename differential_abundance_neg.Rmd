---
title: "Differential abundance analysis, semi-targeted approach"
subtitle: "Negative polarity"
author: "Christa Malfertheiner"
date: "06 July 2021"
output:
  BiocStyle::html_document:
    toc: true
    number_sections: false
    toc_float: true
bibliography: references.bib
csl: biomed-central.csl
references:
- id: dummy
  title: no title
  author:
  - family: noname
    given: noname
---

```{r setup, echo = FALSE, results = "asis", warning = FALSE}
library(BiocStyle)
BiocStyle::markdown()
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

```{r parameters, echo = FALSE, warning = FALSE}
## Set general parameters
polarity <- "NEG" # specify "POS" or "NEG"
p.cut <- 0.05     # cut-off for significance.
m.cut <- 0.7      # cut-off for log2 fold change

set.seed(123)

## Setting golden ratio to save images
phi <- (1+sqrt(5))/2

FILE_NAME <- "differential_abundance_neg"

## Define paths:
IMAGE_PATH <- paste0("images/", FILE_NAME, "/")
if (dir.exists(IMAGE_PATH)) unlink(IMAGE_PATH, recursive = TRUE, force = TRUE)
dir.create(IMAGE_PATH, recursive = TRUE, showWarnings = FALSE)

RDATA_PATH <- paste0("data/RData/", FILE_NAME, "/")
dir.create(RDATA_PATH, recursive = TRUE, showWarnings = FALSE)

RESULT_PATH <- paste0("data/results/", FILE_NAME, "/")
dir.create(RESULT_PATH, recursive = TRUE, showWarnings = FALSE)
```

# Introduction

In this document we perform the differential abundance analysis of the features
previously identified for the *MitYOU* project, with the aim of identifying
significant sex-related features. This task is performed by hypothesis testing,
where we try to identify which metabolites have the most different 
concentrations between female and male samples in plasma samples, venous and
capillary blood samples. We follow a semi-untargeted approach, where we look
at concentrations of a lab-internal set of standards.
The analysis comprises a differential abundance analysis carried out on each 
matrix separately.


# Data import

First, we load the required packages and the data, after preprocessing and
normalization. The end result of these steps is a `SummarizedExperiment` that
contains aligned data, where features are grouped (after correspondence), and
that have undergone gap filling, normalization by the median, linear fitting and 
per-feature between-batch normalization to remove any unwanted variability. 
The `SummarizedExperiment` lets us store all the information regarding the 
normalization steps in the form of `assays`, which we are still able to access 
to proceed with the analysis.

```{r load-data, echo = FALSE, warning = FALSE}
library(xcms)
library(limma)
library(pheatmap)
library(writexl)
library(SummarizedExperiment)
library(RColorBrewer)
library(MsFeatures)
library(MetaboAnnotation)
library(CompMetaboTools)
library(pander)
register(SerialParam())                 # disable parallel processing

load("data/RData/vams_normalization_neg/res_neg.RData")
res_neg$sample_pair <- paste0(res_neg$source, ".", res_neg$sample)
```

It is important now to remove the `POOL` samples from the dataset, because the
analysis has to be performed only on study samples; the `POOL` samples, though
are still required to evaluate the goodness of the detected features, therefore
they will be stored in a separate `SummarizedExperiment` object that can be
accessed when needed.

We also assign the colours as seen before.

```{r split-qc, echo = TRUE}
res_qc <- res_neg[, res_neg$source == "all"]
res_neg <- res_neg[, res_neg$source != "all"]
res_neg$source <- factor(as.character(res_neg$source))
res_neg$sex <- factor(as.character(res_neg$sex))

col_source <- brewer.pal(5, name = "Set1")
names(col_source) <- c("RBC",           #' red
                       "plasma",        #' blue
                       "all",           #' green
                       "capillary",     #' purple
                       "venous")        #' orange

col_sex <- brewer.pal(4, name = "Set1") [c(1, 2, 3)]
names(col_sex) <- c("F",           # red
                    "M",           # blue
                    "POOL")        # green

## Setting golden ratio to save images
phi <- (1+sqrt(5))/2
```

The samples used in this analysis are listed below.

```{r, echo = FALSE, results = "asis"}
tab <- colData(res_neg)[, c("source", "sex", "age")]
pandoc.table(as.data.frame(tab), style = "rmarkdown",
             caption = "Samples used in this analysis")
```

# Semi-targeted analysis

First, we restrict the analysis to a set of known compounds, whose mass-to-charge
ratio and retention time have been previously measured from the pure standards.
To start, a table of standards is loaded in the document, then a search in the
m/z and retention time dimensions is carried out to match the features found
before to these compounds. Subsequently, EICs for all the assigned features are
plotted and visually inspected: this step is necessary to accurately pair the
detected peaks to the standards. When the list of assigned standards is
complete, we perform a differential abundance analysis on the subset of
features.

First, we load the information on the standards, with the aim of identifying
features potentially matching these and plotting the EICs for all of these.

```{r known-cmps, message = FALSE, warning = FALSE}
## Extract known compunds
library("MetaboCoreUtils")
library(Rdisop)
std_info <- read.table(
    "https://raw.githubusercontent.com/EuracBiomedicalResearch/lcms-standards/master/data/standards_dilution.txt",
    sep = "\t", header = TRUE, as.is = TRUE)
std_info <- std_info[!is.na(std_info[, "NEG"]), ]
rownames(std_info) <- 1:nrow(std_info)
std_info$mzneut = NA
std_info$mz_ion = NA
for (i in seq(nrow(std_info))) {
    if (grepl("C", std_info$formula[i])) {
        std_info$mzneut[i] <- getMolecule(
            as.character(std_info$formula[i]))$exactmass
    } else {
        std_info$mzneut[i] = as.numeric(std_info$formula[i])
    }
    ## Calculate also the m/z
    std_info$mz_ion[i] <- mass2mz(
        std_info$mzneut[i], adduct = std_info[i, "NEG"])[1, 1]
}
std_info <- std_info[!is.na(std_info$mz_ion), ]
std_info <- std_info[order(std_info$name), ]

dr <- paste0(IMAGE_PATH, "/standards/")
dir.create(dr, recursive = TRUE, showWarnings = FALSE)

##load data_neg

load("data/RData/vams_normalization_neg/data_neg_filled.RData")

## Subset to the samples we're currently analyzing.
tmp <- filterFile(data_neg, match(res_neg$mzML_file, data_neg$mzML_file),
                  keepFeatures = TRUE)

```

We next match features from our data set against m/z of the expected ions and
the retention times for the set of lab-internal standards, extract their ion
chromatogram and plot these.

```{r}
## Match feature's m/z and rt values against expecte values for standards.
rowData(res_neg)$ft <- row.names(res_neg)
par <- MzRtParam(tolerance = 0, ppm = 20, toleranceRt = 30)
mo <- matchMz(res_neg, std_info, param = par, mzColname = c("mzmed", "mz_ion"), 
              rtColname = c("rtmed", "RT"))
## Subset to matching features.
mo <- mo[whichQuery(mo)]
mo <- pruneTarget(mo)

chrs <- featureChromatograms(tmp, features = mo$ft, expandRt = 7, filled = TRUE)
sample_colors <- col_source[tmp$source]
for (i in seq_len(length(mo$ft))) {
    chr <- chrs[i, ]
    pks <- chromPeaks(chr)
    fl <- mo$target_name[i]
    png(paste0(dr, fl, "-", mo$ft[i], ".png"),
        width = 10, height = 8, units = "cm", res = 300, pointsize = 6)
    plot(chr, col = "#00000040",
         peakCol = paste0(sample_colors[pks[, "column"]], 50),
         peakBg = paste0(sample_colors[pks[, "column"]], 10))
    abline(v = mo$target_RT[i])
    legend("topleft", legend = c(mo$ft[i], fl,
                                 paste0("rt: ", mo$target_RT[i]),
                                 paste0("mz: ", mo$target_mz_ion[i])))
    dev.off()
}

```

The EICs have been manually inspected and the best matching feature has been
manually assigned to the corresponding standard. Some features found a better
match than others, such as xyz; in this case, in fact, there is a single
peak detected, with high intensity, that is well within the theoretical m/z
range and it is very close to the theoretical retention time.

```{r assign-feature-metabolite, echo = FALSE, warning = FALSE, message = FALSE}
## This is the tricky manual thing:
## - Got through all plots for all standards and if there is one feature
##   that clearly matches (i.e. retention time close to the expected retention
##   time and a single peak present in the wider rt range) assign it.
## The code below helps creating the assignment:
## tmp <- cbind(mo$ft, mo$target_name)
## rownames(tmp)
## tmp <- tmp[order(tmp[, 2]), ]
## tmp[, 2, drop = FALSE]
to_keep <- c(
    FT00485 = "1-Methylhistidine",
    FT00948 = "1,5-anhydro D-glucitol",
    FT00066 = "2-Hydroxybutyric acid",
    FT00060 = "2-Ketobutyric acid",
    FT00066 = "3-Hydroxybutyric Acid",
    FT00485 = "3-Methylhistidine",
    FT01695 = "Acetyl-Glucosamine",
    FT00723 = "Acetylmethionine",
    FT02569 = "Adenosine",
    FT00377 = "Alanine",
    FT00383 = "Allantoin",
    FT00105 = "Alpha-ketoisovaleric acid",
    FT04310 = "alpha-Lactose",
    FT10798 = "AMP",
    FT00537 = "Arginine",
    FT00188 = "Asparagine",
    FT00603 = "Aspirin",
    FT01143 = "Carnosine",
    FT04651 = "CDP",
    FT07627 = "CDP-choline",
    FT05598 = "CDP-ethanolamine",
    FT00554 = "Citrulline",
    FT01310 = "Cystine",
    FT03172 = "Dihydroxyacetone phosphate",
    FT00061 = "Dimethylglycine",
    FT00604 = "Fructose",
    FT00785 = "Gluconic Acid",
    FT01139 = "Glucose",
    FT00287 = "Glutamine",
    FT00186 = "Glutaric acid",              # new
    FT09247 = "Glutathione Oxidized",
    FT09247 = "Glutathione Reduced",
    FT00071 = "Glyceric Acid",
    FT02155 = "Glycero-phosphocholine",
    FT00362 = "Histidine",
    FT00628 = "homovanillic acid",
    FT00177 = "Hydroxyproline",
    FT00236 = "Hypoxanthine",
    FT00905 = "Indolelactic acid",
    FT01712 = "Inosine",
    FT00737 = "Isocitric Acid",
    FT00181 = "Isoleucine",
    FT00172 = "Ketoleucine",
    FT00195 = "L-Aspartic Acid",
    FT00132 = "L-Cysteine",
    FT00294 = "L-Glutamic Acid",
    FT00181 = "Leucine",
    FT00289 = "Lysine",
    FT01139 = "Mannose",
    FT00313 = "Methionine",
    FT00439 = "Methioninesulfoxide",
    FT01141 = "Myo-Inositol",
    FT00535 = "N-Acetylornithine",
    FT10209 = "NAD",
    FT00191 = "Ornithine",
    FT00334 = "p-Hydroxyphenylacetic acid",
    FT00247 = "PABA",
    FT01063 = "Pantothenic Acid",
    FT00442 = "Phenylalanine",
    FT00433 = "Phenylpyruvic acid",
    FT00474 = "Phosphoenolpyruvic Acid",
    FT01944 = "Phosphorylethanolamine",
    FT00028 = "Pyruvic Acid",
    FT00464 = "Quinolinic acid",            # new
    FT00323 = "Ribose",
    FT04216 = "SAH",
    FT00253 = "Salicylic acid",
    FT08602 = "Sedoheptulose-7-phosphate",  # new
    FT00067 = "Serine",
    FT03306 = "Sphingosine",
    FT04105 = "Sphingosine-1-phosphate",
    FT00534 = "Suberic Acid",
    FT00118 = "Succinic Acid",
    FT00384 = "Succinylacetone",
    FT04311 = "Sucrose",
    FT00145 = "Taurine",
    FT00236 = "Threonic Acid",
    FT00123 = "Threonine",
    FT00891 = "Tryptophan",
    FT02088 = "Uridine",
    FT00333 = "Xanthine"
)

## Missing from previous analysis:
## FT00612 = "Tyrosine"
## FT00629 = "Galactitol" 

mo <- filterMatches(mo, queryValue = names(to_keep),
                    targetValue = to_keep,
                    queryColname = "ft",
                    targetColname = "target_name",
                    keep = TRUE)
mo <- mo[whichQuery(mo)]

## Handling duplicates.
md <- as.data.frame(matchedData(mo, c("ft", "target_name", "target_HMDB.code",
                                      "target_formula", "target_RT",
                                      "score", "score_rt")))
md <- split(md, md$ft)
md <- do.call(rbind, lapply(md, function(z) {
    tmp <- data.frame(ft = z$ft[1L])
    tmp$name <- paste0(unique(z$target_name), collapse = ";")
    tmp$HMDB <- paste0(unique(z$target_HMDB.code), collapse = ";")
    tmp$target_formula <- paste0(unique(z$target_formula), collapse = ";")
    tmp$diff_mz <- paste0(unique(z$score), collapse = ";")
    tmp$diff_rt <- paste0(unique(z$score_rt), collapse = ";")
    tmp
}))

```

A total of `r sum(nrow(md))` standards have been identified. The features
identified and the corresponding metabolite are summarized in this table:

```{r result-table-ft-std, echo = FALSE, results = "asis"}
## Write result table
tab <- md[, c("name"), drop = FALSE]
pandoc.table(as.data.frame(tab), style = "rmarkdown",
             caption = "Features assigned to known compounds")

```

Next, only the features assigned to the standards are taken into consideration
and are subsetted in the `std_res` object.

```{r std-subset, echo = FALSE}
std_res <- query(mo)
rowData(std_res) <- cbind(rowData(std_res),
                          md[rownames(std_res), ])
```

The subsetting reduced the number of features to `r length(std_res)`. 

A PCA analysis is then performed on the subset to verify whether anything has
changed and if any similarities among the samples are visible or not.

```{r standards-pca-all, echo = FALSE}
pc <- prcomp(t(log2(assay(std_res, "normalized_filled_imputed"))),
                 center = TRUE, scale. = FALSE)
```

```{r standards-pca-plot, fig.path = IMAGE_PATH, fig.cap = "PCA of the samples based on intensities of known compounds.", fig.width = 7 * phi, fig.height = 7, echo = FALSE}
par(mfrow = c(1, 2))
plot_pca(pc, col = paste0(col_source[as.character(std_res$source)], 90),
         pc_x = 1, pc_y = 2, labels = std_res$differentiation)
plot_pca(pc, col = paste0(col_source[as.character(std_res$source)], 90),
         pc_x = 3, pc_y = 4)
legend("topleft", col = col_source, legend = names(col_source),
       title = "phenotype", pch = 16, ncol = 2)
```

In the PC1 plot, capillary and RBC samples cluster together. Plasma samples 
clusters independently of all other sample sources. On PC2 both matrices with
cellular content (capillary and RBC) cluster together and separate from the
venous blood samples. RBC samples show the largest spread on PC2 suggesting a
potentially higher variability in these samples.

```{r std_id-samples, echo = FALSE, results = "asis"}
idx <- pc$x[, 1] > 10
tab <- colData(std_res)[which(idx), c("source", "age", "sex")]
pandoc.table(as.data.frame(tab), style = "rmarkdown",
             caption = "samples: PC1>10")

idx <- pc$x[, 2] < -5
tab <- colData(std_res)[which(idx), c("source", "age", "sex")]
pandoc.table(as.data.frame(tab), style = "rmarkdown",
             caption = "samples: PC2<-5")
```

We then create a data set for each sample source:

```{r source-subset, echo = FALSE}
res_cap = std_res[, std_res$source == "capillary"]
res_ven = std_res[, std_res$source == "venous"]
res_plas = std_res[, std_res$source == "plasma"]

```

Next, we want to see the clustering for each data set. Male and female samples
are represented by different colours. The numbers indicate the two replicates 
for each volunteer. We start with the capillary data set:

```{r PCA-std-capillary, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "PCA for capillary blood samples. Red numbers represents female, blue numbers male samples.", echo = FALSE}
pc_raw_capillary <- prcomp(t(log2(assay(res_cap, "normalized_filled_imputed"))),
                           scale = FALSE, center = TRUE)

pch <- rep(21, ncol(res_cap))
pch[res_cap$sex == "M"] <- 22
par(mfrow = c(1, 2))
plot_pca(pc_raw_capillary, col = paste0(col_sex[as.character(res_cap$sex)], 80),
         pc_x = 1, pc_y = 2, main = "capillary samples, M/F",
         pch = pch, labels = res_cap$sample)
plot_pca(pc_raw_capillary, col = paste0(col_sex[as.character(res_cap$sex)], 80),
         pc_x = 3, pc_y = 4, main = "capillary samples, M/F",
         pch = pch, labels = res_cap$sample)
legend("topleft", col = col_sex, legend = names(col_sex), pch = 16,
       cex = 0.4)

```

In the capillary samples, we see no clustering of female or male samples.

We then generate the PCA for the venous data set:

```{r PCA-std-venous, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "PCA for venous blood samples. Red numbers represents female, blue numbers male samples.", echo = FALSE}

pc_raw_venous <- prcomp(t(log2(assay(res_ven, "normalized_filled_imputed"))),
                        scale = FALSE, center = TRUE)

pch <- rep(21, ncol(res_ven))
pch[res_ven$sex == "M"] <- 22
par(mfrow = c(1, 2))
plot_pca(pc_raw_venous, col = paste0(col_sex[as.character(res_ven$sex)], 80),
         pc_x = 1, pc_y = 2, main = "venous samples, M/F",
         pch = pch, labels = res_ven$sample)
plot_pca(pc_raw_venous, col = paste0(col_sex[as.character(res_ven$sex)], 80),
         pc_x = 3, pc_y = 4, main = "venous samples, M/F",
         pch = pch, labels = res_ven$sample)
legend("topleft", col = col_sex, legend = names(col_sex), pch = 16,
       cex = 0.4)


```


In the venous data set, a hint of a differentiation between male and female
samples might be present.

Lastly, we generate the PCA for the plasma samples:

```{r PCA-std-plasma, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "PCA for plasma blood samples. Circles and rectangles indicate male or female samples.", echo = FALSE}

pc_raw_plasma <- prcomp(t(log2(assay(res_plas, "normalized_filled_imputed"))),
                        scale = FALSE, center = TRUE)

pch <- rep(21, ncol(res_plas))
pch[res_plas$sex == "M"] <- 22
par(mfrow = c(1, 2))
plot_pca(pc_raw_plasma, col = paste0(col_sex[as.character(res_plas$sex)], 80),
         pc_x = 1, pc_y = 2, main = "plasma samples, M/F",
         pch = pch, labels = res_plas$sample)
plot_pca(pc_raw_plasma, col = paste0(col_sex[as.character(res_plas$sex)], 80),
         pc_x = 3, pc_y = 4, main = "plasma samples, M/F",
         pch = pch, labels = res_plas$sample)
legend("topleft", col = col_sex, legend = names(col_sex), pch = 16,
       cex = 0.4)


```

In the plasma samples, we see a very light clustering effect between male and
female samples.

Next, we merge the technical replicates.

```{r}

#' Average 
averageSE <- function(x, column = character(), mainAssay = character()) {
    if (!column %in% colnames(colData(x)))
        stop("Column '", "' not found in 'colData' of 'x'")
    f <- factor(colData(x)[, column], levels = unique(colData(x)[, column]))
    ## new colData: take the first element for each replicate.
    cd <- colData(x)[match(levels(f), f), ]
    ## loop over the assays and average them.
    a <- lapply(assays(x), function(z) {
        z <- split.data.frame(t(z), f = f)
        z <- do.call(cbind, lapply(z, colMeans, na.rm = TRUE))
        z[is.na(z)] <- NA
        z
    })
    if (length(mainAssay)) {
        tmp <- split.data.frame(t(assay(x, mainAssay)), f = f)
        tmp <- do.call(cbind, lapply(tmp, function(y) {
            apply(y, MARGIN = 2, FUN = sd, na.rm = TRUE)
        }))
        tmp[is.na(tmp)] <- NA
        a[[paste0(mainAssay, "_sd")]] <- tmp
    }
    SummarizedExperiment(assays = a, rowData = rowData(x),
                         colData = cd, metadata = metadata(x))
}

## Average technical replicates:
res_neg <- averageSE(res_neg, column = "sample_pair",
                     mainAssay = "normalized_filled")
std_res <- averageSE(std_res, column = "sample_pair",
                     mainAssay = "normalized_filled")
```


For completeness, we recreate the PCA plots using data from the merged
technical replicates. First, we re-subset the data sets:

```{r}
res_cap = std_res[, std_res$source == "capillary"]
res_ven = std_res[, std_res$source == "venous"]
res_plas = std_res[, std_res$source == "plasma"]
```

Then, we perform a PCA of the capillary blood samples:

```{r PCA-std-capillary-avg. TR, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "PCA for capillary blood samples. Circles and rectangles indicate male or female samples.", echo = FALSE}

pc_raw_capillary <- prcomp(t(log2(assay(res_cap, "normalized_filled_imputed"))),
                           scale = FALSE, center = TRUE)

pch <- rep(21, ncol(res_cap))
pch[res_cap$sex == "M"] <- 22
par(mfrow = c(1, 2))
plot_pca(pc_raw_capillary, col = paste0(col_sex[as.character(res_cap$sex)], 80),
         pc_x = 1, pc_y = 2, main = "capillary samples, M/F",
         pch = pch, labels = res_cap$sample)
plot_pca(pc_raw_capillary, col = paste0(col_sex[as.character(res_cap$sex)], 80),
         pc_x = 3, pc_y = 4, main = "capillary samples, M/F",
         pch = pch, labels = res_cap$sample)
legend("topleft", col = col_sex, legend = names(col_sex), pch = 16,
       cex = 0.4)

```

We proceed with the venous blood samples:

```{r PCA-std-venous-avg. TR, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "PCA for venous blood samples. Circles and rectangles indicate male or female samples.", echo = FALSE}

pc_raw_venous <- prcomp(t(log2(assay(res_ven, "normalized_filled_imputed"))),
                        scale = FALSE, center = TRUE)

pch <- rep(21, ncol(res_ven))
pch[res_ven$sex == "M"] <- 22
par(mfrow = c(1, 2))
plot_pca(pc_raw_venous, col = paste0(col_sex[as.character(res_ven$sex)], 80),
         pc_x = 1, pc_y = 2, main = "venous samples, M/F",
         pch = pch, labels = res_ven$sample)
plot_pca(pc_raw_venous, col = paste0(col_sex[as.character(res_ven$sex)], 80),
         pc_x = 3, pc_y = 4, main = "venous samples, M/F",
         pch = pch, labels = res_ven$sample)
legend("topleft", col = col_sex, legend = names(col_sex), pch = 16,
       cex = 0.4)


```

And lastly, we perform the PCA showing the clusering of the plasma samples:

```{r PCA-std-plasma-avg. TR, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "PCA for plasma blood samples. Circles and rectangles indicate male or female samples.", echo = FALSE}

pc_raw_plasma <- prcomp(t(log2(assay(res_plas, "normalized_filled_imputed"))),
                        scale = FALSE, center = TRUE)

pch <- rep(21, ncol(res_plas))
pch[res_plas$sex == "M"] <- 22
par(mfrow = c(1, 2))
plot_pca(pc_raw_plasma, col = paste0(col_sex[as.character(res_plas$sex)], 80),
         pc_x = 1, pc_y = 2, main = "plasma samples, M/F",
         pch = pch, labels = res_plas$sample)
plot_pca(pc_raw_plasma, col = paste0(col_sex[as.character(res_plas$sex)], 80),
         pc_x = 3, pc_y = 4, main = "plasma samples, M/F",
         pch = pch, labels = res_plas$sample)
legend("topleft", col = col_sex, legend = names(col_sex), pch = 16,
       cex = 0.4)


```

Now, we start with the differential abundance analysis.

## Differential abundance analysis

The differential abundance analysis is performed on the subset of features that
have previously been assigned to the standards. We apply feature-wise multiple
linear regression using the `lmFit` function and we add the matrix defining
the contrasts using `contrast.fit`. Then, we calculate the p-values with `eBayes`.
Subsequently, we generate a data frame with the coefficients, the raw
and adjusted p-values (we apply a Benjamini-Hochberg correction for better
control of the false discovery rate), the average intensity of signals in plasma
samples, capillary and venous blood samples and whether or not a feature is to 
be considered significant.
This data frame is then added to the `rowData` of the `res_cap` object.

```{r standards-analysis, echo = FALSE}
sex <- factor(res_cap$sex)
dsgn <- model.matrix(~ 0 + sex)
fit <- lmFit(log2(assay(res_cap, "normalized_filled_imputed")), design = dsgn)

## Fit the actual contrasts of interest
contr_mat <- makeContrasts(
  MvsF = sexM - sexF,
  levels = dsgn)
fit <- contrasts.fit(fit, contrasts = contr_mat)
fit <- eBayes(fit)

tmp <- data.frame(
    coef = fit$coefficient[, "MvsF"],
    pvalue = fit$p.value[, "MvsF"],
    adjp = p.adjust(fit$p.value[, "MvsF"]),
    avg.M = rowMeans(
        log2(assay(
             std_res, "normalized_filled_imputed")[, res_cap$sex == "M"])),
    avg.F = rowMeans(
        log2(assay(
             std_res, "normalized_filled_imputed")[, res_cap$sex == "F"]))
    )
tmp$significant <- abs(tmp$coef) > m.cut & tmp$adjp < p.cut
rowData(res_cap) <- cbind(rowData(res_cap), tmp)
```

We plot then the distribution of p-values, both raw and adjusted.

```{r standards-histogram, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "Distribution of raw (left) and adjusted p-values (right)."}
par(mfrow = c(1, 2))
hist(rowData(res_cap)$pvalue, breaks = 64, xlab = "p value",
     main = "Distribution of raw p-values")
hist(rowData(res_cap)$adjp, breaks = 64, xlab = expression(p[BH]~value),
     main = "Distribution of adjusted p-values")
```

The frequency of raw p-values shows the highest peaks around 0.1 and o.3, 
whereas the highest peak of adjusted p-values is close to 1.

The volcano plot is now plotted to evaluate whether significant features are
still present or not.

```{r standards-volcano, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 10, fig.height = 10, fig.cap = "Volcano plot showing the analysis results."}
par(mfrow = c(1, 1))
plot(rowData(res_cap)$coef, -log10(rowData(res_cap)$adjp),
     xlab = expression(log[2]~difference),
     ylab = expression(-log[10]~p[BH]), pch = 16, col = "#00000060")
rect(xleft = -100, ybottom = -log10(p.cut), xright = -m.cut, ytop = 100,
     border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
rect(xleft = m.cut, ybottom = -log10(p.cut), xright = 100, ytop = 100,
     border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
if (any(rowData(res_cap)$significant)) {
    points(rowData(res_cap)$coef[rowData(res_cap)$significant],
           -log10(rowData(res_cap)$adjp[rowData(res_cap)$significant]),
           col = "#0000ffcc")
}
```

In total `r sum(rowData(res_cap)$significant)` feature were found to have a
significant difference in abundances between the two groups. The table below
lists these features (or the 20 features with the smallest p-values if no
feature was found significant).

```{r significant-standards-result-table capillary, echo = FALSE, results = "asis"}
## Write result table
if (any(rowData(res_cap)$significant)) {
    tab <- rowData(res_cap)[rowData(res_cap)$significant,
                            c("name", "mzmed", "rtmed", "coef", "adjp", "pvalue"
                              )]
    tab <- tab[order(tab$adjp, abs(tab$coef)), ]
    pandoc.table(
        as.data.frame(tab), style = "rmarkdown",
        caption = "Features with significant differences in abundances.")
} else {
    tab <- rowData(res_cap)[order(rowData(res_cap)$pvalue),
                            c("name", "mzmed", "rtmed", "coef", "adjp"
                              )]
    tab <- tab[1:20, ]
    pandoc.table(
        as.data.frame(tab), style = "rmarkdown",
        caption = "Top 20 features with the smallest p-values.")
}
```

The feature with the smalles p-value is **Gluconic acid**, which is produced
by oxidizing glucose and can be naturally found in foods like fruit, honey and 
wine. **Homovanillic acid** is a major catecholamine metabolite being associated
with dopamine levels in the brain. In neuroscience it is used as a marker of
metabolic stress caused by 2-desoxy-D-glucose (Marcelis et al., 2006). The third
smallest p-value was observed in **Allantoin**, a degradation produc of nucleic
acids.

At this stage, we delve a little deeper and build a beeswarm plot (a
one-dimensional scatterplot close to a stripchart) to show the different trends
of each metabolite with a small p-value found between male and female samples.
The advantage of the beeswarm plot is that it prevents overplotting, thus
making it easier for us to interpret the results. The gray line represents the
median.

```{r beeswarm capillary, echo = FALSE}
library(beeswarm)
tab <- rowData(res_cap)[rownames(tab), ]
tmp <- log2(assay(res_cap, "normalized_filled_imputed")[rownames(tab), 
                                                        , drop = FALSE])
rownames(tmp) <- tab$name
dr <- paste0(IMAGE_PATH, "standards-beeswarm/")
dir.create(dr, recursive = TRUE, showWarnings = FALSE)
for (i in seq_len(nrow(tmp))) {
    vals <- split(tmp[i, ], f = res_cap$sex)
    col <- col_sex[names(vals)]
    png(file = paste0(dr, rownames(tab)[i], "_", rownames(tmp)[i], ".png"),
        width = 6 * phi, height = 6, units = "in", res = 300, pointsize = 12)
    par(mar = c(5, 5, 5, 1))
    beeswarm(vals, col = paste0(col, 80), pch = 16, cex = 1.5, spacing = 1.2,
             cex.main = 1.5,
             cex.lab = 1.5,
             cex.axis = 1.3,
             main = paste0(rownames(tab)[i], ": ", rownames(tmp)[i]),
             ylab = expression(log[2]~intensity))
    bxplot(vals, probs = 0.5, col = "#00000060", add = TRUE, width = 0.9)
    dev.off()
}
```

![](images/differential_abundance_neg/standards-beeswarm/FT00785_Gluconic Acid.png)
![](images/differential_abundance_neg/standards-beeswarm/FT00628_homovanillic acid.png)
![](images/differential_abundance_neg/standards-beeswarm/FT00383_Allantoin.png)

The top three features with smallest p-value all show a higher concentration in
male samples compared to the female ones.

We now proceed with the differential abundace analysis in venous blood samples:

```{r standards-analysis venous, echo = FALSE}
sex <- factor(res_ven$sex)
dsgn <- model.matrix(~ 0 + sex)
fit <- lmFit(log2(assay(res_ven, "normalized_filled_imputed")), design = dsgn)

## Fit the actual contrasts of interest
contr_mat <- makeContrasts(
  MvsF = sexM - sexF,
  levels = dsgn)
fit <- contrasts.fit(fit, contrasts = contr_mat)
fit <- eBayes(fit)

tmp <- data.frame(
    coef = fit$coefficient[, "MvsF"],
    pvalue = fit$p.value[, "MvsF"],
    adjp = p.adjust(fit$p.value[, "MvsF"]),
    avg.M = rowMeans(
        log2(assay(
             res_ven, "normalized_filled_imputed")[, res_ven$sex == "M"])),
    avg.F = rowMeans(
        log2(assay(
             res_ven, "normalized_filled_imputed")[, res_ven$sex == "F"]))
    )
tmp$significant <- abs(tmp$coef) > m.cut & tmp$adjp < p.cut
rowData(res_ven) <- cbind(rowData(res_ven), tmp)
```

We plot then the distribution of p-values, both raw and adjusted.

```{r standards-histogram venous, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "Distribution of raw (left) and adjusted p-values (right)."}
par(mfrow = c(1, 2))
hist(rowData(res_ven)$pvalue, breaks = 64, xlab = "p value",
     main = "Distribution of raw p-values")
hist(rowData(res_ven)$adjp, breaks = 64, xlab = expression(p[BH]~value),
     main = "Distribution of adjusted p-values")
```

The frequency of raw p-values shows the highest peaks close to 0 and 0.8, other
values are randomly distributed and some are not represented at all. The bar 
showing the highest frequency of adjusted p-values is close to 1.

```{r standards-volcano venous, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 10, fig.height = 10, fig.cap = "Volcano plot showing the analysis results."}
par(mfrow = c(1, 1))
plot(rowData(res_ven)$coef, -log10(rowData(res_ven)$adjp),
     xlab = expression(log[2]~difference),
     ylab = expression(-log[10]~p[BH]), pch = 16, col = "#00000060")
rect(xleft = -100, ybottom = -log10(p.cut), xright = -m.cut, ytop = 100,
     border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
rect(xleft = m.cut, ybottom = -log10(p.cut), xright = 100, ytop = 100,
     border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
if (any(rowData(res_ven)$significant)) {
    points(rowData(res_ven)$coef[rowData(res_ven)$significant],
           -log10(rowData(res_ven)$adjp[rowData(res_ven)$significant]),
           col = "#0000ffcc")
}
```

In total `r sum(rowData(res_ven)$significant)` feature were found to have a
significant difference in abundances between the two groups. The table below
lists these features (or the 20 features with the smallest p-values if no
feature was found significant).

```{r significant-standards-result-table venous, echo = FALSE, results = "asis"}
## Write result table
## if (any(rowData(res_ven)$significant)) {
##     tab <- rowData(res_ven)[rowData(res_ven)$significant,
##                             c("name", "mzmed", "rtmed", "coef", "adjp"
##                               )]
##     tab <- tab[order(tab$adjp, abs(tab$coef)), ]
##     pandoc.table(
##         as.data.frame(tab), style = "rmarkdown",
##         caption = "Features with significant differences in abundances.")
## } else {
    tab <- rowData(res_ven)[order(rowData(res_ven)$pvalue),
                            c("name", "mzmed", "rtmed", "coef", "adjp"
                              )]
    tab <- tab[1:20, ]
    pandoc.table(
        as.data.frame(tab), style = "rmarkdown",
        caption = "Top 20 features with the smallest p-values.")
## }
```

**Gluconic acid** is found to be significant in venous blood samples between
male and female samples.This feature also had the smallest p-value in capillary
blood samples, when comparing male to female samples.

We now create the beeswarm plot:

```{r beeswarm venous, echo = FALSE}
library(beeswarm)
tab <- rowData(res_ven)[rownames(tab), ]
tmp <- log2(assay(res_ven, "normalized_filled_imputed")[rownames(tab), 
                                                        , drop = FALSE])
rownames(tmp) <- tab$name
dr <- paste0(IMAGE_PATH, "standards-beeswarm-ven/")
dir.create(dr, recursive = TRUE, showWarnings = FALSE)
for (i in seq_len(nrow(tmp))) {
    vals <- split(tmp[i, ], f = res_ven$sex)
    col <- col_sex[names(vals)]
    png(file = paste0(dr, rownames(tab)[i], "_", rownames(tmp)[i], ".png"),
        width = 6 * phi, height = 6, units = "in", res = 300, pointsize = 12)
    par(mar = c(5, 5, 5, 1))
    beeswarm(vals, col = paste0(col, 80), pch = 16, cex = 1.5, spacing = 1.2,
             cex.main = 1.5,
             cex.lab = 1.5,
             cex.axis = 1.3,
             main = paste0(rownames(tab)[i], ": ", rownames(tmp)[i]),
             ylab = expression(log[2]~intensity))
    bxplot(vals, probs = 0.5, col = "#00000060", add = TRUE, width = 0.9)
    dev.off()
}
```

![](images/differential_abundance_neg/standards-beeswarm-ven/FT00785_Gluconic Acid.png)

Like already observed in capillary blood samples, also in venous blood Gluconic
Acid shows a higher concentration in male samples.

We then analyse the features for plasma samples:

```{r standards-analysis plasma, echo = FALSE}
sex <- factor(res_plas$sex)
dsgn <- model.matrix(~ 0 + sex)
fit <- lmFit(log2(assay(res_plas, "normalized_filled_imputed")), design = dsgn)

## Fit the actual contrasts of interest
contr_mat <- makeContrasts(
  MvsF = sexM - sexF,
  levels = dsgn)
fit <- contrasts.fit(fit, contrasts = contr_mat)
fit <- eBayes(fit)

tmp <- data.frame(
    coef = fit$coefficient[, "MvsF"],
    pvalue = fit$p.value[, "MvsF"],
    adjp = p.adjust(fit$p.value[, "MvsF"]),
    avg.M = rowMeans(
        log2(assay(
             res_plas, "normalized_filled_imputed")[, res_plas$sex == "M"])),
    avg.F = rowMeans(
        log2(assay(
             res_plas, "normalized_filled_imputed")[, res_plas$sex == "F"]))
    )
tmp$significant <- abs(tmp$coef) > m.cut & tmp$adjp < p.cut
rowData(res_plas) <- cbind(rowData(res_plas), tmp)
```

We plot then the distribution of p-values, both raw and adjusted.

```{r standards-histogram plasma, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "Distribution of raw (left) and adjusted p-values (right)."}
par(mfrow = c(1, 2))
hist(rowData(res_plas)$pvalue, breaks = 64, xlab = "p value",
     main = "Distribution of raw p-values")
hist(rowData(res_plas)$adjp, breaks = 64, xlab = expression(p[BH]~value),
     main = "Distribution of adjusted p-values")
```

In the raw p-values we observe higher bars between 0 and 0.6, in the adjusted 
p-values the highest bar is close to 0.

```{r standards-volcano plasma, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 10, fig.height = 10, fig.cap = "Volcano plot showing the analysis results."}
par(mfrow = c(1, 1))
plot(rowData(res_plas)$coef, -log10(rowData(res_plas)$adjp),
     xlab = expression(log[2]~difference),
     ylab = expression(-log[10]~p[BH]), pch = 16, col = "#00000060")
rect(xleft = -100, ybottom = -log10(p.cut), xright = -m.cut, ytop = 100,
     border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
rect(xleft = m.cut, ybottom = -log10(p.cut), xright = 100, ytop = 100,
     border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
if (any(rowData(res_plas)$significant)) {
    points(rowData(res_plas)$coef[rowData(res_plas)$significant],
           -log10(rowData(res_plas)$adjp[rowData(res_plas)$significant]),
           col = "#0000ffcc")
}
```

In total `r sum(rowData(res_plas)$significant)` feature were found to have a
significant difference in abundances between the two groups. The table below
lists these features (or the 20 features with the smallest p-values if no
feature was found significant).

```{r significant-standards-result-table, echo = FALSE, results = "asis"}
## Write result table
if (any(rowData(res_plas)$significant)) {
    tab <- rowData(res_plas)[rowData(res_plas)$significant,
                            c("name", "mzmed", "rtmed", "coef", "adjp"
                              )]
    tab <- tab[order(tab$adjp, abs(tab$coef)), ]
    pandoc.table(
        as.data.frame(tab), style = "rmarkdown",
        caption = "Features with significant differences in abundances.")
} else {
    tab <- rowData(res_plas)[order(rowData(res_plas)$pvalue),
                            c("name", "mzmed", "rtmed", "coef", "adjp"
                              )]
    tab <- tab[1:20, ]
    pandoc.table(
        as.data.frame(tab), style = "rmarkdown",
        caption = "Top 20 features with the smallest p-values.")
}
```

In plasma samples, **Homovanillic acid** is the feature with the smallest
p-value. This feature was also observed in the top three features with smallest
p-value in capillary blood samples. **Cystine** is an oxidized dimeric form of 
cysteine, which is found in high concentrations in digestive enzymes and in the
cells of the immune system, skeletal and connective tissues, skin, and hair.

Lastly, we create beeswarm-plots for the 20 features:

```{r beeswarm plasma, echo = FALSE}
library(beeswarm)
tab <- rowData(res_plas)[rownames(tab), ]
tmp <- log2(assay(res_plas, "normalized_filled_imputed")[rownames(tab), 
                                                        , drop = FALSE])
rownames(tmp) <- tab$name
dr <- paste0(IMAGE_PATH, "standards-beeswarm-plas/")
dir.create(dr, recursive = TRUE, showWarnings = FALSE)
for (i in seq_len(nrow(tmp))) {
    vals <- split(tmp[i, ], f = res_plas$sex)
    col <- col_sex[names(vals)]
    png(file = paste0(dr, rownames(tab)[i], "_", rownames(tmp)[i], ".png"),
        width = 6 * phi, height = 6, units = "in", res = 300, pointsize = 12)
    par(mar = c(5, 5, 5, 1))
    beeswarm(vals, col = paste0(col, 80), pch = 16, cex = 1.5, spacing = 1.2,
             cex.main = 1.5,
             cex.lab = 1.5,
             cex.axis = 1.3,
             main = paste0(rownames(tab)[i], ": ", rownames(tmp)[i]),
             ylab = expression(log[2]~intensity))
    bxplot(vals, probs = 0.5, col = "#00000060", add = TRUE, width = 0.9)
    dev.off()
}
```

![](images/differential_abundance_neg/standards-beeswarm-plas/FT00628_homovanillic acid.png)

![](images/differential_abundance_neg/standards-beeswarm-plas/FT01310_Cystine.png)

Both features show a higher intensity in male samples compared to female ones.

At last we compare the concentrations for the 3 metabolites Gluconic Acid,
homovanillic acid and Allantonin in male and female participants across all 3
matrices.

```{r beeswarm-gluconic-acid, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 8, fig.height = 6, fig.cap = "Abundance of gluconic acid in female and male participants across all 3 sample matrices (capillary, venous and plamsa)."}

beeswarm_feature <- function(x, main = x) {
    a <- log2(assay(res_cap, "normalized_filled_imputed")[x, ])
    a <- split(a, res_cap$sex)
    b <- log2(assay(res_ven, "normalized_filled_imputed")[x, ])
    b <- split(b, res_ven$sex)
    c <- log2(assay(res_plas, "normalized_filled_imputed")[x, ])
    c <- split(c, res_plas$sex)
    par(mar = c(5, 4, 1, 1))
    vals <- c(cap = a, ven = b, plas = c)
    beeswarm(vals,
             col = paste0(col_sex[c("F", "M", "F", "M", "F", "M")]),
             pch = 16, main = main, ylab = expression(log[2]~intensity),
             las = 2)
    grid(nx = NA, ny = NULL)
    bxplot(vals, probs = 0.5, col = "#00000060", add = TRUE, width = 0.9)
}
beeswarm_feature("FT00785", "FT00785: Gluconic Acid")
```

Also in plasma samples a trend of differential abundance between male and female
participants is visible, but the concentration of this metabolite is much lower
(explaining the larger noise and hence poor statistical significance).

```{r beeswarm-homovanillic-acid, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 8, fig.height = 6, fig.cap = "Abundance of homovanillic acid in female and male participants across all 3 sample matrices (capillary, venous and plamsa)."}
beeswarm_feature("FT00628", "FT00628: homovanillic acid")
```

Also for homovanillic acid a difference in concentrations between male and
female participants is present in all 3 sample matrices. Despite being lowest in
plasma samples, the absolute concentrations are comparable in the 3 matrices.

```{r beeswarm-allantoin, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 8, fig.height = 6, fig.cap = "Abundance of Allantoin in female and male participants across all 3 sample matrices (capillary, venous and plamsa)."}
beeswarm_feature("FT00383", "FT00383: Allantoin")
```

Similar to homovanillic acid, concentrations are comparable across the 3
matrices, but lowest in plasma samples. Again, male participants show higher
abundances than female participants.


```{r}
save(res_neg, file = paste0(RDATA_PATH, "res_neg.RData"))
```

# Session information

The versions of R and the individually used packges are listed below.

```{r}
sessionInfo()
```
