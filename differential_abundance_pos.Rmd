---
title: "Differential abundance analysis, semi-targeted approach"
subtitle: "Positive polarity"
author: "Christa Malfertheiner"
date: "15 June 2021"
output:
  BiocStyle::html_document:
    toc: true
    number_sections: false
    toc_float: true
bibliography: references.bib
csl: biomed-central.csl
references:
- id: dummy
  title: no title
  author:
  - family: noname
    given: noname
---

```{r setup, echo = FALSE, results = "asis", warning = FALSE}
library(BiocStyle)
BiocStyle::markdown()
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

<!--
**Modified**: `r file.info("differential_abundance_pos.Rmd")$mtime`<br />
**Compiled**: `r date()`
-->

```{r parameters, echo = FALSE, warning = FALSE}
## Set general parameters
polarity <- "POS" # specify "POS" or "NEG"
p.cut <- 0.05     # cut-off for significance.
m.cut <- 0.7      # cut-off for log2 fold change

set.seed(123)

## Setting golden ratio to save images
phi <- (1+sqrt(5))/2

FILE_NAME <- "differential_abundance_pos"

## Define paths:
IMAGE_PATH <- paste0("images/", FILE_NAME, "/")
if (dir.exists(IMAGE_PATH)) unlink(IMAGE_PATH, recursive = TRUE, force = TRUE)
dir.create(IMAGE_PATH, recursive = TRUE, showWarnings = FALSE)

RDATA_PATH <- paste0("data/RData/", FILE_NAME, "/")
dir.create(RDATA_PATH, recursive = TRUE, showWarnings = FALSE)

RESULT_PATH <- paste0("data/results/", FILE_NAME, "/")
dir.create(RESULT_PATH, recursive = TRUE, showWarnings = FALSE)
```

# Introduction

In this document we perform the differential abundance analysis of the features
previously identified for the *MitYOU* project, with the aim of identifying
significant sex-related features. This task is performed by hypothesis testing,
where we try to identify which metabolites have the most different 
concentrations between female and male samples in plasma samples, venous and
capillary blood samples. We follow a semi-targeted approach, where we look
at concentrations of features corresponding to lab-internal set of standards.
The analysis comprises a differential abundance analysis carried out on each 
matrix separately.


# Data import

First, we load the required packages and the data, after preprocessing and
normalization. The end result of these steps is a `SummarizedExperiment` that
contains aligned data, where features are grouped (after correspondence), and
that have undergone gap filling, normalization by the median, linear fitting and 
per-feature between-batch normalization to remove any unwanted variability. 
The `SummarizedExperiment` lets us store all the information regarding the 
normalization steps in the form of `assays`, which we are still able to access 
to proceed with the analysis.

```{r load-data, echo = FALSE, warning = FALSE}
library(xcms)
library(limma)
library(pheatmap)
library(writexl)
library(SummarizedExperiment)
library(RColorBrewer)
library(MsFeatures)
library(CompMetaboTools)
library(pander)
library(MetaboAnnotation)

load("data/RData/vams_normalization_pos/res_pos.RData")
res_pos$sample_pair <- paste0(res_pos$source, ".", res_pos$sample)
```

It is important now to remove the `POOL` samples from the dataset, because the
analysis has to be performed only on study samples; the `POOL` samples, though
are still required to evaluate the goodness of the detected features, therefore
they will be stored in a separate `SummarizedExperiment` object that can be
accessed when needed.

We also assign the colours as seen before.

```{r split-qc, echo = TRUE}
res_qc <- res_pos[, res_pos$source == "all"]
res_pos <- res_pos[, res_pos$source != "all"]
res_pos$source <- factor(as.character(res_pos$source))
res_pos$sex <- factor(as.character(res_pos$sex))

col_source <- brewer.pal(5, name = "Set1")
names(col_source) <- c("RBC",           #' red
                       "plasma",        #' blue
                       "all",           #' green
                       "capillary",     #' purple
                       "venous")        #' orange

col_sex <- brewer.pal(4, name = "Set1") [c(1, 2, 3)]
names(col_sex) <- c("F",           # red
                    "M",           # blue
                    "POOL")        # green

## Setting golden ratio to save images
phi <- (1+sqrt(5))/2
```

The samples used in this analysis are listed below.

```{r, echo = FALSE, results = "asis"}
tab <- colData(res_pos)[, c("source", "sex", "age")]
pandoc.table(as.data.frame(tab), style = "rmarkdown",
             caption = "Samples used in this analysis")
```

# Semi-targeted analysis

First, we restrict the analysis to a set of known compounds, whose
mass-to-charge ratio and retention time have been previously measured from the
pure standards. To start, a table of standards is loaded, then
a search in the m/z and retention time dimensions is carried out to match the
features found before to these compounds. Subsequently, EICs for all the
assigned features are plotted and visually inspected: this step is necessary to
accurately pair the detected peaks to the standards. When the list of assigned
standards is complete, we perform a differential abundance analysis on the
subset of features.

First, we load the information on the standards, with the aim of identifying
features potentially matching these and plotting the EICs for all of these.

```{r known-cmps, message = FALSE, warning = FALSE}
## Extract known compunds
library("MetaboCoreUtils")
library(Rdisop)
std_info <- read.table(
    "https://raw.githubusercontent.com/EuracBiomedicalResearch/lcms-standards/master/data/standards_dilution.txt",
    sep = "\t", header = TRUE, as.is = TRUE)
std_info <- std_info[!is.na(std_info[, "POS"]), ]
rownames(std_info) <- 1:nrow(std_info)
std_info$mzneut = NA
std_info$mz_ion = NA
for (i in seq(nrow(std_info))) {
    if (grepl("C", std_info$formula[i])) {
        std_info$mzneut[i] <- getMolecule(
            as.character(std_info$formula[i]))$exactmass
    } else {
        std_info$mzneut[i] = as.numeric(std_info$formula[i])
    }
    ## Calculate also the m/z
    std_info$mz_ion[i] <- mass2mz(
        std_info$mzneut[i], adduct = std_info[i, "POS"])[1, 1]
}
std_info <- std_info[!is.na(std_info$mz_ion), ]
std_info <- std_info[order(std_info$name), ]

## Manually adding an additional row for Creatinine and Creatine
to_add <- std_info[std_info$name %in% c("Creatinine", "Creatine"), ]
to_add$name <- paste0(to_add$name, "-full")
std_info <- rbind(std_info, to_add)

dr <- paste0(IMAGE_PATH, "/standards/")
dir.create(dr, recursive = TRUE, showWarnings = FALSE)

load("data/RData/vams_normalization_pos/data_pos_filled.RData")

## Subset to the samples we're currently analyzing.
tmp <- filterFile(data_pos, match(res_pos$mzML_file, data_pos$mzML_file),
                  keepFeatures = TRUE)
```

We next match features from our data set against m/z of the expected ions and
the retention times for the set of lab-internal standards, extract their ion
chromatogram and plot these.

```{r}
## Match feature's m/z and rt values against expecte values for standards.
rowData(res_pos)$ft <- row.names(res_pos)
## Note: would need a ppm of 40 to get Homocysteine-FT0178
par <- MzRtParam(tolerance = 0, ppm = 20, toleranceRt = 30)
mo <- matchMz(res_pos, std_info, param = par, mzColname = c("mzmed", "mz_ion"), 
              rtColname = c("rtmed", "RT"))
## Subset to matching features.
mo <- mo[whichQuery(mo)]
mo <- pruneTarget(mo)

chrs <- featureChromatograms(tmp, features = mo$ft, expandRt = 7, filled = TRUE)
sample_colors <- col_source[tmp$source]
for (i in seq_len(length(mo$ft))) {
    chr <- chrs[i, ]
    pks <- chromPeaks(chr)
    fl <- mo$target_name[i]
    png(paste0(dr, fl, "-", mo$ft[i], ".png"),
        width = 10, height = 8, units = "cm", res = 300, pointsize = 6)
    plot(chr, col = "#00000040",
         peakCol = paste0(sample_colors[pks[, "column"]], 50),
         peakBg = paste0(sample_colors[pks[, "column"]], 10))
    abline(v = mo$target_RT[i])
    legend("topleft", legend = c(mo$ft[i], fl,
                                 paste0("rt: ", mo$target_RT[i]),
                                 paste0("mz: ", mo$target_mz_ion[i])))
    dev.off()
}

```

The EICs have been manually inspected and the best matching feature has been
manually assigned to the corresponding standard.

```{r assign-feature-metabolite, echo = FALSE, warning = FALSE, message = FALSE}
## This is the tricky manual thing:
## - Go through all plots for all standards and if there is one feature
##   that clearly matches (i.e. retention time close to the expected retention
##   time and a single peak present in the wider rt range) assign it.

to_keep <- c(FT0293 = "1-Methylhistidine",
             FT0293 = "3-Methylhistidine", # same as 1-Methylhistidine
             FT0154 = "5-Oxoproline",
             FT0415 = "Acetylcarnitine",
             FT0518 = "Acetyl-Glucosamine",
             FT0384 = "Acetylhistidine",
             FT0407 = "ADMA",
             FT0051 = "Alanine",
             FT0268 = "alpha-Aminoadipic acid",
             FT1330 = "alpha-Lactose", # or FT1331
             FT1197 = "AMP",
             FT0307 = "Arginine",
             FT0162 = "Asparagine",
             ## c("Betaine", "FT0111/FT0112"),
             FT0486 = "C4 Carnitine",
             FT0527 = "C5 Carnitine", # rt shifted 10s
             FT0378 = "Caffeine",
             FT0472 = "Carnosine",
             ## c("Choline", "FT0072"),
             FT0312 = "Citrulline",
             ## c("Corticosterone", "FT1193"), # rt shifted 10s
             ##c("Creatine", "FT0159/FT0160"),
             ##c("Creatinine", "FT0099/FT0100"),
             FT0507 = "Cystine",
             FT1198 = "dGMP",
             FT0402 = "Fructose", # same as glucose and mannose
             FT0420 = "Galactitol", # same as sorbitol
             FT0460 = "Gluconic Acid",
             FT0402 = "Glucose", # same as Fructose
             FT0215 = "Glutamine",
             FT3342 = "Glutathione Oxidized", # same as Glu. Reduced
             FT3342 = "Glutathione Reduced", # same as Glu. Oxidized
             FT0581 = "Glycero-phosphocholine",
             FT0031 = "Glycine",
             FT0249 = "Histidine",
             ## FT0178 = "Homocysteine",      # only found with ppm 40
             FT0158 = "Hydroxyproline",
             FT0182 = "Hypoxanthine",
             FT0161 = "Isoleucine",
             FT0168 = "L-Aspartic Acid", # or FT0169
             FT0270 = "L-Carnitine", 
             FT0123 = "L-Cysteine",
             FT0161 = "Leucine",
             ##c("Levodopa", "FT0384"), # found with ppm = 50
             FT0220 = "L-Glutamic Acid",
             FT0216= "Lysine",
             FT0402 = "Mannose", # same as Fructose and Glucose
             FT0226 = "Methionine",
             FT0280 = "Methioninesulfoxide", 
             ## c("Myoinositol", "FT0402"), # detected as FT0820 and FT0821 - same as fructose, glucose and mannose
             FT0306 = "N-Acetylornithine",
             FT3776 = "NAD",
             FT0134 = "Niacinamide",
             FT0165 = "Ornithine",
             FT1588 = "Palmitoylcarnitine", # or FT1589
             FT0281 = "Phenylalanine",
             ##c("Phenylethylamine", "FT0129"),
             ##c("Phosphocreatine", "FT0436"),
             FT0338 = "Phosphorylcholine",
             FT0201 = "Phosphorylethanolamine",
             ##c("Pipecolic acid", "FT0155"),
             ## c("Proline", "FT0107/FT106"),
             ##c("Putrescine", "FT0024"),
             FT1481 = "SAH",
             FT1583 = "SAMe",
             FT0407 = "SDMA",
             FT0079 = "Serine",
             FT0420 = "Sorbitol", # same as galactitol
             FT1451 = "Sphingosine-1-phosphate",
             FT0843 = "Sphingosine",
             FT1331 = "Sucrose", # or FT1330
             FT0146 = "Taurine",
             FT0117 = "Threonine",
             FT0422 = "Tryptophan",
             FT0328 = "Tyrosine",
             FT0112 = "Valine",
             FT0160 = "Creatine",
             FT5630 = "Creatine-full",
             FT0099 = "Creatinine",
             FT5631 = "Creatinine-full")

mo <- filterMatches(mo, queryValue = names(to_keep), 
                    targetValue = to_keep, 
                    queryColname = "ft",
                    targetColname = "target_name",
                    keep = TRUE)
mo <- mo[whichQuery(mo)]
mo <- pruneTarget(mo) # Probably it's not very useful but since these two lines
# are used one after the other we could create a function e.g. reduceMatched 
# that does the two things

## Handling duplicates.
md <- as.data.frame(matchedData(mo, c("ft", "target_name", "target_HMDB.code")))
md <- split(md, md$ft)
md <- do.call(rbind, lapply(md, function(z) {
    tmp <- data.frame(ft = z$ft[1L])
    tmp$name <- paste0(z$target_name, collapse = ";")
    tmp$HMDB <- paste0(z$target_HMDB.code, collapse = ";")
    tmp
}))

```

A total of `r sum(nrow(md))` standards have been identified. The features
identified and the corresponding metabolite are summarized in this table:

```{r result-table-ft-std, echo = FALSE, results = "asis"}
## Write result table
md <- md[order(md$name), ]
pandoc.table(md[, c("ft", "name")], style = "rmarkdown",
             caption = "Features assigned to known compounds")
```

Next, only the features assigned to the standards are taken into consideration
and are subsetted in the `std_res` object.

```{r std-subset, echo = FALSE}
std_res <- query(mo)
rowData(std_res) <- cbind(rowData(std_res),
                          md[rownames(std_res), c("name", "HMDB")])
```

The subsetting reduced the number of features to `r length(std_res)`. 

A PCA analysis is then performed on the subset to verify whether anything has
changed and if any similarities among the samples are visible or not.

```{r standards-pca-all, echo = FALSE}
pc <- prcomp(t(log2(assay(std_res, "normalized_filled_imputed"))),
                 center = TRUE, scale. = FALSE)
```

```{r standards-pca-plot, fig.path = IMAGE_PATH, fig.cap = "PCA of the samples based on intensities of known compounds.", fig.width = 7 * phi, fig.height = 7, echo = FALSE}
par(mfrow = c(1, 2))
plot_pca(pc, col = paste0(col_source[as.character(std_res$source)], 90),
         pc_x = 1, pc_y = 2, labels = std_res$differentiation)
plot_pca(pc, col = paste0(col_source[as.character(std_res$source)], 90),
         pc_x = 3, pc_y = 4)
legend("topleft", col = col_source, legend = names(col_source),
       title = "phenotype", pch = 16, ncol = 2)
```

In the PC1 plot, capillary and RBC samples cluster together. Plasma samples 
clusters independently of all other sample sources. Venous and capillary samples
are separated on PC2. RBC samples show a large spread on PC2 suggesting higher
variability. Sample groups are also separating on PC3 but less pronounced than
on PC1 or PC2.

```{r std_id-samples, echo = FALSE, results = "asis"}
idx <- pc$x[, 1] > 10
tab <- colData(std_res)[which(idx), c("source", "age", "sex")]
pandoc.table(as.data.frame(tab), style = "rmarkdown",
             caption = "samples: PC1>10")

idx <- pc$x[, 2] > 5
tab <- colData(std_res)[which(idx), c("source", "age", "sex")]
pandoc.table(as.data.frame(tab), style = "rmarkdown",
             caption = "samples: PC2 > 5")
```

We then create a data set for each sample source:

```{r source-subset, echo = FALSE}
res_cap = std_res[, std_res$source == "capillary"]
res_ven = std_res[, std_res$source == "venous"]
res_plas = std_res[, std_res$source == "plasma"]

```

Next, we want to see the clustering for each data set. Male and female samples
are represented by different colours. The numbers indicate the two replicates 
for each volunteer. We start with the capillary data set:

```{r PCA-std-capillary, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "PCA for capillary blood samples. Red numbers represents female, blue numbers male samples.", echo = FALSE}
pc_raw_capillary <- prcomp(t(log2(assay(res_cap, "normalized_filled_imputed"))),
                           scale = FALSE, center = TRUE)

pch <- rep(21, ncol(res_cap))
pch[res_cap$sex == "M"] <- 22
par(mfrow = c(1, 2))
plot_pca(pc_raw_capillary, col = paste0(col_sex[as.character(res_cap$sex)], 80),
         pc_x = 1, pc_y = 2, main = "capillary samples, M/F",
         pch = pch, labels = res_cap$sample)
plot_pca(pc_raw_capillary, col = paste0(col_sex[as.character(res_cap$sex)], 80),
         pc_x = 3, pc_y = 4, main = "capillary samples, M/F",
         pch = pch, labels = res_cap$sample)
legend("topleft", col = col_sex, legend = names(col_sex), pch = 16,
       cex = 0.4)

```

In the capillary samples, we see some differences between male and female
samples. Some of the replicates cluster closely, while others, like nr. 13, are
far apart. The technical replicates are merged in a later step.

We then generate the PCA for the venous data set:

```{r PCA-std-venous, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "PCA for venous blood samples. Red numbers represents female, blue numbers male samples.", echo = FALSE}
pc_raw_venous <- prcomp(t(log2(assay(res_ven, "normalized_filled_imputed"))),
                        scale = FALSE, center = TRUE)

pch <- rep(21, ncol(res_ven))
pch[res_ven$sex == "M"] <- 22
par(mfrow = c(1, 2))
plot_pca(pc_raw_venous, col = paste0(col_sex[as.character(res_ven$sex)], 80),
         pc_x = 1, pc_y = 2, main = "venous samples, M/F",
         pch = pch, labels = res_ven$sample)
plot_pca(pc_raw_venous, col = paste0(col_sex[as.character(res_ven$sex)], 80),
         pc_x = 3, pc_y = 4, main = "venous samples, M/F",
         pch = pch, labels = res_ven$sample)
legend("topleft", col = col_sex, legend = names(col_sex), pch = 16,
       cex = 0.4)
```

In the venous data set, no separation of clustering of male and female samples
is visible. Also, the replicates are less close than in the capillary samples.

Lastly, we generate the PCA for the plasma samples:

```{r PCA-std-plasma, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "PCA for plasma blood samples. Circles and rectangles indicate male or female samples.", echo = FALSE}
pc_raw_plasma <- prcomp(t(log2(assay(res_plas, "normalized_filled_imputed"))),
                        scale = FALSE, center = TRUE)

pch <- rep(21, ncol(res_plas))
pch[res_plas$sex == "M"] <- 22
par(mfrow = c(1, 2))
plot_pca(pc_raw_plasma, col = paste0(col_sex[as.character(res_plas$sex)], 80),
         pc_x = 1, pc_y = 2, main = "plasma samples, M/F",
         pch = pch, labels = res_plas$sample)
plot_pca(pc_raw_plasma, col = paste0(col_sex[as.character(res_plas$sex)], 80),
         pc_x = 3, pc_y = 4, main = "plasma samples, M/F",
         pch = pch, labels = res_plas$sample)
legend("topleft", col = col_sex, legend = names(col_sex), pch = 16,
       cex = 0.4)

```

In the plasma samples, we see a light clustering effect between male and female
samples.

Next, we merge the technical replicates.

```{r}

#' Average 
averageSE <- function(x, column = character(), mainAssay = character()) {
    if (!column %in% colnames(colData(x)))
        stop("Column '", "' not found in 'colData' of 'x'")
    f <- factor(colData(x)[, column], levels = unique(colData(x)[, column]))
    ## new colData: take the first element for each replicate.
    cd <- colData(x)[match(levels(f), f), ]
    ## loop over the assays and average them.
    a <- lapply(assays(x), function(z) {
        z <- split.data.frame(t(z), f = f)
        z <- do.call(cbind, lapply(z, colMeans, na.rm = TRUE))
        z[is.na(z)] <- NA
        z
    })
    if (length(mainAssay)) {
        tmp <- split.data.frame(t(assay(x, mainAssay)), f = f)
        tmp <- do.call(cbind, lapply(tmp, function(y) {
            apply(y, MARGIN = 2, FUN = sd, na.rm = TRUE)
        }))
        tmp[is.na(tmp)] <- NA
        a[[paste0(mainAssay, "_sd")]] <- tmp
    }
    SummarizedExperiment(assays = a, rowData = rowData(x),
                         colData = cd, metadata = metadata(x))
}

## Average technical replicates:
res_pos <- averageSE(res_pos, column = "sample_pair",
                     mainAssay = "normalized_filled")
std_res <- averageSE(std_res, column = "sample_pair",
                     mainAssay = "normalized_filled")
```

For completeness, we recreate the PCA plots using data from the merged
technical replicates. First, we re-subset the data sets:

```{r}
res_cap = std_res[, std_res$source == "capillary"]
res_ven = std_res[, std_res$source == "venous"]
res_plas = std_res[, std_res$source == "plasma"]
```

Then, we perform a PCA of the capillary blood samples:

```{r PCA-std-capillary-avg. TR, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "PCA for capillary blood samples. Circles and rectangles indicate male or female samples.", echo = FALSE}
pc_raw_capillary <- prcomp(t(log2(assay(res_cap, "normalized_filled_imputed"))),
                           scale = FALSE, center = TRUE)

pch <- rep(21, ncol(res_cap))
pch[res_cap$sex == "M"] <- 22
par(mfrow = c(1, 2))
plot_pca(pc_raw_capillary, col = paste0(col_sex[as.character(res_cap$sex)], 80),
         pc_x = 1, pc_y = 2, main = "capillary samples, M/F",
         pch = pch, labels = res_cap$sample)
plot_pca(pc_raw_capillary, col = paste0(col_sex[as.character(res_cap$sex)], 80),
         pc_x = 3, pc_y = 4, main = "capillary samples, M/F",
         pch = pch, labels = res_cap$sample)
legend("topleft", col = col_sex, legend = names(col_sex), pch = 16,
       cex = 0.4)

```

We proceed with the venous blood samples:

```{r PCA-std-venous-avg. TR, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "PCA for venous blood samples. Circles and rectangles indicate male or female samples.", echo = FALSE}
pc_raw_venous <- prcomp(t(log2(assay(res_ven, "normalized_filled_imputed"))),
                        scale = FALSE, center = TRUE)

pch <- rep(21, ncol(res_ven))
pch[res_ven$sex == "M"] <- 22
par(mfrow = c(1, 2))
plot_pca(pc_raw_venous, col = paste0(col_sex[as.character(res_ven$sex)], 80),
         pc_x = 1, pc_y = 2, main = "venous samples, M/F",
         pch = pch, labels = res_ven$sample)
plot_pca(pc_raw_venous, col = paste0(col_sex[as.character(res_ven$sex)], 80),
         pc_x = 3, pc_y = 4, main = "venous samples, M/F",
         pch = pch, labels = res_ven$sample)
legend("topleft", col = col_sex, legend = names(col_sex), pch = 16,
       cex = 0.4)
```

And lastly, we perform the PCA showing the clusering of the plasma samples:

```{r PCA-std-plasma-avg. TR, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "PCA for plasma blood samples. Circles and rectangles indicate male or female samples.", echo = FALSE}
pc_raw_plasma <- prcomp(t(log2(assay(res_plas, "normalized_filled_imputed"))),
                        scale = FALSE, center = TRUE)

pch <- rep(21, ncol(res_plas))
pch[res_plas$sex == "M"] <- 22
par(mfrow = c(1, 2))
plot_pca(pc_raw_plasma, col = paste0(col_sex[as.character(res_plas$sex)], 80),
         pc_x = 1, pc_y = 2, main = "plasma samples, M/F",
         pch = pch, labels = res_plas$sample)
plot_pca(pc_raw_plasma, col = paste0(col_sex[as.character(res_plas$sex)], 80),
         pc_x = 3, pc_y = 4, main = "plasma samples, M/F",
         pch = pch, labels = res_plas$sample)
legend("topleft", col = col_sex, legend = names(col_sex), pch = 16,
       cex = 0.4)


```

Now, we start with the differential abundance analysis.

## Differential abundance analysis

The differential abundance analysis is performed on the subset of features that
have previously been assigned to the standards. We apply feature-wise multiple
linear regression using the `lmFit` function and we add the matrix defining
the contrasts using `contrast.fit`. Then, we calculate the p-values with `eBayes`.
Subsequently, we generate a data frame with the coefficients, the raw
and adjusted p-values (we apply a Benjamini-Hochberg correction for better
control of the false discovery rate), the average intensity of signals in plasma
samples, capillary and venous blood samples and whether or not a feature is to 
be considered significant.
This data frame is then added to the `rowData` of the `res_cap` object.
We start the analysis for the capillary blood samples:

```{r standards-analysis, echo = FALSE}
sex <- factor(res_cap$sex)
age <- res_cap$age
dsgn <- model.matrix(~ 0 + sex)
fit <- lmFit(log2(assay(res_cap, "normalized_filled_imputed")), design = dsgn)

## Fit the actual contrasts of interest
contr_mat <- makeContrasts(
  MvsF = sexM - sexF,
  levels = dsgn)
fit <- contrasts.fit(fit, contrasts = contr_mat)
fit <- eBayes(fit)

tmp <- data.frame(
    coef = fit$coefficient[, "MvsF"],
    pvalue = fit$p.value[, "MvsF"],
    adjp = p.adjust(fit$p.value[, "MvsF"]),
    avg.M = rowMeans(
        log2(assay(
             std_res, "normalized_filled_imputed")[, res_cap$sex == "M"])),
    avg.F = rowMeans(
        log2(assay(
             std_res, "normalized_filled_imputed")[, res_cap$sex == "F"]))
    )
tmp$significant <- abs(tmp$coef) > m.cut & tmp$adjp < p.cut
rowData(res_cap) <- cbind(rowData(res_cap), tmp)
```

We plot then the distribution of p-values of the capillary blood samples, both 
raw and adjusted.

```{r standards-histogram, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "Distribution of raw (left) and adjusted p-values (right)."}
par(mfrow = c(1, 2))
hist(rowData(res_cap)$pvalue, breaks = 64, xlab = "p value",
     main = "Distribution of raw p-values")
hist(rowData(res_cap)$adjp, breaks = 64, xlab = expression(p[BH]~value),
     main = "Distribution of adjusted p-values")
```

The distribution of the raw p-values reflects what was expected: the tallest bar
is close to 0 and the other p-values are randomly distributed. Also, we notice
that there are several p-values that are not represented at all in the dataset.

The distribution of the adjusted p-values also follows the trend we predicted:
the bar with the highest frequency is found near 0, the second highest is near
to 1, while few other values are scarcely represented.

The volcano plot is now plotted to evaluate whether significant features are
still present or not. First, we plot data belonging to the capillary blood 
samples:

```{r standards-volcano, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 10, fig.height = 10, fig.cap = "Volcano plot showing the analysis results."}
par(mfrow = c(1, 1))
plot(rowData(res_cap)$coef, -log10(rowData(res_cap)$adjp),
     xlab = expression(log[2]~difference),
     ylab = expression(-log[10]~p[BH]), pch = 16, col = "#00000060")
rect(xleft = -100, ybottom = -log10(p.cut), xright = -m.cut, ytop = 100,
     border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
rect(xleft = m.cut, ybottom = -log10(p.cut), xright = 100, ytop = 100,
     border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
if (any(rowData(res_cap)$significant)) {
    points(rowData(res_cap)$coef[rowData(res_cap)$significant],
           -log10(rowData(res_cap)$adjp[rowData(res_cap)$significant]),
           col = "#0000ffcc")
}
```

In total `r sum(rowData(res_cap)$significant)` feature were found to have a
significant difference in abundances between the two groups. The table below
lists these features (or the 20 features with the smallest p-values if no
feature was found significant).

```{r significant-standards-result-table capillary, echo = FALSE, results = "asis"}
## Write result table
if (any(rowData(res_cap)$significant)) {
    tab <- rowData(res_cap)[rowData(res_cap)$significant,
                            c("name", "mzmed", "rtmed", "coef", "adjp", "pvalue"
                              )]
    tab <- tab[order(tab$adjp, abs(tab$coef)), ]
    pandoc.table(
        as.data.frame(tab), style = "rmarkdown",
        caption = "Features with significant differences in abundances.")
} else {
    tab <- rowData(res_cap)[order(rowData(res_cap)$pvalue),
                            c("name", "mzmed", "rtmed", "coef", "adjp"
                              )]
    tab <- tab[1:20, ]
    pandoc.table(
        as.data.frame(tab), style = "rmarkdown",
        caption = "Top 20 features with the smallest p-values.")
}
```

**SAH** shows the smallest p-value, which is already described as being 
different in concentration when male and female are compared. The second 
identified metbolite with a small p-value  is **Citrulline**: this is an amino 
acid that is produced from arginine during the process of nitrogen monoxide 
(NO) synthesis. This biological messenger plays an important role in mechanical
and chemical signal transduction, especially in cardiomyocytes.
**L-Aspartic acid** is an amino  acid, which plays a major role in the 
production in antibodies. 

We now create the beeswarm plot:

```{r beeswarm capillary, echo = FALSE}
library(beeswarm)
tab <- rowData(res_cap)[rownames(tab), ]
tmp <- log2(assay(res_cap, "normalized_filled_imputed")[rownames(tab), 
                                                        , drop = FALSE])
rownames(tmp) <- tab$name
dr <- paste0(IMAGE_PATH, "standards-beeswarm-cap/")
dir.create(dr, recursive = TRUE, showWarnings = FALSE)
for (i in seq_len(nrow(tmp))) {
    vals <- split(tmp[i, ], f = res_cap$sex)
    col <- col_sex[names(vals)]
    png(file = paste0(dr, rownames(tab)[i], "_", rownames(tmp)[i], ".png"),
        width = 6 * phi, height = 6, units = "in", res = 300, pointsize = 12)
    par(mar = c(5, 5, 5, 1))
    beeswarm(vals, col = paste0(col, 80), pch = 16, cex = 1.5, spacing = 1.2,
             cex.main = 1.5,
             cex.lab = 1.5,
             cex.axis = 1.3,
             main = paste0(rownames(tab)[i], ": ", rownames(tmp)[i]),
             ylab = expression(log[2]~intensity))
    bxplot(vals, probs = 0.5, col = "#00000060", add = TRUE, width = 0.9)
    dev.off()
}
```

![](images/differential_abundance_pos/standards-beeswarm-cap/FT1481_SAH.png)
In our data, the SAH levels in male samples are higher then in female samples.

![](images/differential_abundance_pos/standards-beeswarm-cap/FT0312_Citrulline.png)
Also, the intensity of Citrulline and L-Aspartic acid peaks are higher in male 
compared to female samples.

![](images/differential_abundance_pos/standards-beeswarm-cap/FT0168_L-Aspartic Acid.png)

We than look for significant features in venous blood samples: 

```{r standards-analysis venous, echo = FALSE}
sex <- factor(res_ven$sex)
age <- res_ven$age
dsgn <- model.matrix(~ 0 + sex)
fit <- lmFit(log2(assay(res_ven, "normalized_filled_imputed")), design = dsgn)

## Fit the actual contrasts of interest
contr_mat <- makeContrasts(
  MvsF = sexM - sexF,
  levels = dsgn)
fit <- contrasts.fit(fit, contrasts = contr_mat)
fit <- eBayes(fit)

tmp <- data.frame(
    coef = fit$coefficient[, "MvsF"],
    pvalue = fit$p.value[, "MvsF"],
    adjp = p.adjust(fit$p.value[, "MvsF"]),
    avg.M = rowMeans(
        log2(assay(
             res_ven, "normalized_filled_imputed")[, res_ven$sex == "M"])),
    avg.F = rowMeans(
        log2(assay(
             res_ven, "normalized_filled_imputed")[, res_ven$sex == "F"]))
    )
tmp$significant <- abs(tmp$coef) > m.cut & tmp$adjp < p.cut
rowData(res_ven) <- cbind(rowData(res_ven), tmp)
```

We plot then the distribution of p-values, both raw and adjusted.

```{r standards-histogram venous, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "Distribution of raw (left) and adjusted p-values (right)."}
par(mfrow = c(1, 2))
hist(rowData(res_ven)$pvalue, breaks = 64, xlab = "p value",
     main = "Distribution of raw p-values")
hist(rowData(res_ven)$adjp, breaks = 64, xlab = expression(p[BH]~value),
     main = "Distribution of adjusted p-values")
```

Next, we generate a volcano plot for the significant features found in venous
blood samples:

```{r standards-volcano venous, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 10, fig.height = 10, fig.cap = "Volcano plot showing the analysis results."}
par(mfrow = c(1, 1))
plot(rowData(res_ven)$coef, -log10(rowData(res_ven)$adjp),
     xlab = expression(log[2]~difference),
     ylab = expression(-log[10]~p[BH]), pch = 16, col = "#00000060")
rect(xleft = -100, ybottom = -log10(p.cut), xright = -m.cut, ytop = 100,
     border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
rect(xleft = m.cut, ybottom = -log10(p.cut), xright = 100, ytop = 100,
     border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
if (any(rowData(res_ven)$significant)) {
    points(rowData(res_ven)$coef[rowData(res_ven)$significant],
           -log10(rowData(res_ven)$adjp[rowData(res_ven)$significant]),
           col = "#0000ffcc")
}
```

In total `r sum(rowData(res_ven)$significant)` feature were found to have a
significant difference in abundances between the two groups. The table below
lists these features (or the 20 features with the smallest p-values if no
feature was found significant).

```{r significant-standards-result-table venous, echo = FALSE, results = "asis"}
## Write result table
if (any(rowData(res_ven)$significant)) {
    tab <- rowData(res_ven)[rowData(res_ven)$significant,
                            c("name", "mzmed", "rtmed", "coef", "adjp"
                              )]
    tab <- tab[order(tab$adjp, abs(tab$coef)), ]
    pandoc.table(
        as.data.frame(tab), style = "rmarkdown",
        caption = "Features with significant differences in abundances.")
} else {
    tab <- rowData(res_ven)[order(rowData(res_ven)$pvalue),
                            c("name", "mzmed", "rtmed", "coef", "adjp"
                              )]
    tab <- tab[1:20, ]
    pandoc.table(
        as.data.frame(tab), style = "rmarkdown",
        caption = "Top 20 features with the smallest p-values.")
}
```

Only 2 features show a p-value lower than 0.5, which are **L-Aspartic acid** and
**C5-Carnitine**, former also being found with a low p-value between male and 
female samples in the capillary blood samples.

We now create the beeswarm plot:

```{r beeswarm venous, echo = FALSE}
library(beeswarm)
tab <- rowData(res_ven)[rownames(tab), ]
tmp <- log2(assay(res_ven, "normalized_filled_imputed")[rownames(tab), 
                                                        , drop = FALSE])
rownames(tmp) <- tab$name
dr <- paste0(IMAGE_PATH, "standards-beeswarm-ven/")
dir.create(dr, recursive = TRUE, showWarnings = FALSE)
for (i in seq_len(nrow(tmp))) {
    vals <- split(tmp[i, ], f = res_ven$sex)
    col <- col_sex[names(vals)]
    png(file = paste0(dr, rownames(tab)[i], "_", rownames(tmp)[i], ".png"),
        width = 6 * phi, height = 6, units = "in", res = 300, pointsize = 12)
    par(mar = c(5, 5, 5, 1))
    beeswarm(vals, col = paste0(col, 80), pch = 16, cex = 1.5, spacing = 1.2,
             cex.main = 1.5,
             cex.lab = 1.5,
             cex.axis = 1.3,
             main = paste0(rownames(tab)[i], ": ", rownames(tmp)[i]),
             ylab = expression(log[2]~intensity))
    bxplot(vals, probs = 0.5, col = "#00000060", add = TRUE, width = 0.9)
    dev.off()
}
```

![](images/differential_abundance_pos/standards-beeswarm-cap/FT0168_L-Aspartic Acid.png)
![](images/differential_abundance_pos/standards-beeswarm-ven/FT0527_C5 Carnitine.png)
Also these two metabolites show higher levels in male samples when compared
to female samples.

We then analyse the features for plasma samples:

```{r standards-analysis plasma, echo = FALSE}
sex <- factor(res_plas$sex)
age <- res_plas$age
dsgn <- model.matrix(~ 0 + sex)
fit <- lmFit(log2(assay(res_plas, "normalized_filled_imputed")), design = dsgn)

## Fit the actual contrasts of interest
contr_mat <- makeContrasts(
  MvsF = sexM - sexF,
  levels = dsgn)
fit <- contrasts.fit(fit, contrasts = contr_mat)
fit <- eBayes(fit)

tmp <- data.frame(
    coef = fit$coefficient[, "MvsF"],
    pvalue = fit$p.value[, "MvsF"],
    adjp = p.adjust(fit$p.value[, "MvsF"]),
    avg.M = rowMeans(
        log2(assay(
             res_plas, "normalized_filled_imputed")[, res_plas$sex == "M"])),
    avg.F = rowMeans(
        log2(assay(
             res_plas, "normalized_filled_imputed")[, res_plas$sex == "F"]))
    )
tmp$significant <- abs(tmp$coef) > m.cut & tmp$adjp < p.cut
rowData(res_plas) <- cbind(rowData(res_plas), tmp)
```

We plot the distribution of p-values, both raw and adjusted.

```{r standards-histogram plasma, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "Distribution of raw (left) and adjusted p-values (right)."}
par(mfrow = c(1, 2))
hist(rowData(res_plas)$pvalue, breaks = 64, xlab = "p value",
     main = "Distribution of raw p-values")
hist(rowData(res_plas)$adjp, breaks = 64, xlab = expression(p[BH]~value),
     main = "Distribution of adjusted p-values")
```

```{r standards-volcano plasma, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 10, fig.height = 10, fig.cap = "Volcano plot showing the analysis results."}
par(mfrow = c(1, 1))
plot(rowData(res_plas)$coef, -log10(rowData(res_plas)$adjp),
     xlab = expression(log[2]~difference),
     ylab = expression(-log[10]~p[BH]), pch = 16, col = "#00000060")
rect(xleft = -100, ybottom = -log10(p.cut), xright = -m.cut, ytop = 100,
     border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
rect(xleft = m.cut, ybottom = -log10(p.cut), xright = 100, ytop = 100,
     border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
if (any(rowData(res_plas)$significant)) {
    points(rowData(res_plas)$coef[rowData(res_plas)$significant],
           -log10(rowData(res_plas)$adjp[rowData(res_plas)$significant]),
           col = "#0000ffcc")
}
```

In total `r sum(rowData(res_plas)$significant)` feature were found to have a
significant difference in abundances between the two groups. The table below
lists these features (or the 20 features with the smallest p-values if no
feature was found significant).

```{r significant-standards-result-table plasma, echo = FALSE, results = "asis"}
## Write result table
if (any(rowData(res_plas)$significant)) {
    tab <- rowData(res_plas)[rowData(res_plas)$significant,
                            c("name", "mzmed", "rtmed", "coef", "adjp"
                              )]
    tab <- tab[order(tab$adjp, abs(tab$coef)), ]
    pandoc.table(
        as.data.frame(tab), style = "rmarkdown",
        caption = "Features with significant differences in abundances.")
} else {
    tab <- rowData(res_plas)[order(rowData(res_plas)$pvalue),
                            c("name", "mzmed", "rtmed", "coef", "adjp"
                              )]
    tab <- tab[1:20, ]
    pandoc.table(
        as.data.frame(tab), style = "rmarkdown",
        caption = "Top 20 features with the smallest p-values.")
}
```


Lastly, we create the beeswarm plots:

```{r beeswarm plasma, echo = FALSE}
library(beeswarm)
tab <- rowData(res_plas)[rownames(tab), ]
tmp <- log2(assay(res_plas, "normalized_filled_imputed")[rownames(tab), 
                                                        , drop = FALSE])
rownames(tmp) <- tab$name
dr <- paste0(IMAGE_PATH, "standards-beeswarm-plas/")
dir.create(dr, recursive = TRUE, showWarnings = FALSE)
for (i in seq_len(nrow(tmp))) {
    vals <- split(tmp[i, ], f = res_plas$sex)
    col <- col_sex[names(vals)]
    png(file = paste0(dr, rownames(tab)[i], "_", rownames(tmp)[i], ".png"),
        width = 6 * phi, height = 6, units = "in", res = 300, pointsize = 12)
    par(mar = c(5, 5, 5, 1))
    beeswarm(vals, col = paste0(col, 80), pch = 16, cex = 1.5, spacing = 1.2,
             cex.main = 1.5,
             cex.lab = 1.5,
             cex.axis = 1.3,
             main = paste0(rownames(tab)[i], ": ", rownames(tmp)[i]),
             ylab = expression(log[2]~intensity))
    bxplot(vals, probs = 0.5, col = "#00000060", add = TRUE, width = 0.9)
    dev.off()
}
```

Below we evaluate the EIC of the assigned feature for the most interesting
metabolites. Assignment of the feature *FT1481* to SAH seems to be OK:

![](images/differential_abundance_pos/standards/SAH-FT1481.png)

Also the selected feature for Citrulline seems to be OK:

![](images/differential_abundance_pos/standards/Citrulline-FT0312.png)

The chromatographic peak for the features assigned to L-Aspartic Acid looks
clean, but also another peak/feature is close by.

![](images/differential_abundance_pos/standards/L-Aspartic Acid-FT0168.png)

The retention time of the feature for C5-Carnitine is shifted by about 10
seconds, which could make this assignment also questionable.

![](images/differential_abundance_pos/standards/C5 Carnitine-FT0527.png)

At last we compare the concentrations for these metabolites in male and female
participants across all 3 matrices.

```{r beeswarm-SAH, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 8, fig.height = 6, fig.cap = "Abundance of SAH in female and male participants across all 3 sample matrices (capillary, venous and plamsa)."}

beeswarm_feature <- function(x, main = x) {
    a <- log2(assay(res_cap, "normalized_filled_imputed")[x, ])
    a <- split(a, res_cap$sex)
    b <- log2(assay(res_ven, "normalized_filled_imputed")[x, ])
    b <- split(b, res_ven$sex)
    c <- log2(assay(res_plas, "normalized_filled_imputed")[x, ])
    c <- split(c, res_plas$sex)
    par(mar = c(5, 4, 1, 1))
    vals <- c(cap = a, ven = b, plas = c)
    beeswarm(vals,
             col = paste0(col_sex[c("F", "M", "F", "M", "F", "M")]),
             pch = 16, main = main, ylab = expression(log[2]~intensity),
             las = 2)
    grid(nx = NA, ny = NULL)
    bxplot(vals, probs = 0.5, col = "#00000060", add = TRUE, width = 0.9)
}
beeswarm_feature("FT1481", "SAH: FT1481")
```

SAH shows lower levels in female participants in all 3 matrices, but
concentrations are much lower in plasma samples, leading to a higher variability
and thus lower significance.

```{r beeswarm-citrulline, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 8, fig.height = 6, fig.cap = "Abundance of citrulline in female and male participants across all 3 sample matrices (capillary, venous and plamsa)."}
beeswarm_feature("FT0312", "Citrulline: FT0312")
```

Also for citrulline a difference in concentrations between male and
female participants is present in all 3 sample matrices. Concentrations are
highest in capillary samples and lower, but comparable in venous and plasma
samples.

```{r beeswarm-l-aspartic-acid, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 8, fig.height = 6, fig.cap = "Abundance of L-Aspartic Acid in female and male participants across all 3 sample matrices (capillary, venous and plamsa)."}
beeswarm_feature("FT0168", "L-Aspartic Acid: FT0168")
```

Concentration of L-Aspartic Acid is comparably high in capillary and venous
samples but much lower in plasma samples. In contrast to capillary and venous
samples, in which concentrations are higher in male than in female samples, in
plasma samples the concentrations are higher in female samples.

```{r beeswarm-c5-carnitine, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 8, fig.height = 6, fig.cap = "Abundance of C5 Carnitine in female and male participants across all 3 sample matrices (capillary, venous and plamsa)."}
beeswarm_feature("FT0527", "C5 Carnitine: FT0527")
```

C5 Carnitine shows the same trend of differential abundance in all 3 matrices.


Also, we evaluate the abundances of Gluconic Acid, one of the metabolites found
to be different in the negative polarity data (for the other two metabolites
from the negative polarity analysis, homovanillic acid and Allantonin, no
feature was identified in positive mode).

```{r beeswarm-gluconic-acid, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 8, fig.height = 6, fig.cap = "Abundance of Gluconic Acid in female and male participants across all 3 sample matrices (capillary, venous and plamsa)."}
beeswarm_feature("FT0460", "Gluconic Acid: FT0460")
```

While female participants show higher levels in capillary and plasma samples,
the opposite can be seen for venous samples. Note however that the retention
time of the feature assigned to Gluconic Acid in positive mode does not match
the retention time of Gluconic Acid in negative polarity. In fact, at the
retention time of Gluconic Acid in negative polarity no feature is present in
positive polarity.

Lastly, we compare the coefficients of all features between capillary and
venous blood samples by plotting them against each other:

```{r feature-comparison-coef-cap-ven, fip.path = IMAGE_PATH, fig.cap = "Comparison of coefficients of all features between capillary and venous blood samples", echo = FALSE}
X <- rowData(res_cap)$coef
Y <- rowData(res_ven)$coef
plot(X, Y, 
     xlab = expression(coef[capillary]),
     ylab = expression(coef[venous]), 
     pch = 16, col = "#00000040")
grid()
LM <- lm(Y ~ X)
abline(LM)
legend("topleft", paste0("R=", format(cor(X, Y), digits = 2)))
```

Then, we compare the coefficients of all features between capillary and
plasma samples by plotting them against each other:

```{r feature-comparison-coef-cap-plas, fig.path = IMAGE_PATH, fig.cap = "Comparison of coefficients of all features between capillary and plasma samples", echo = FALSE}
X <- rowData(res_cap)$coef
Y <- rowData(res_plas)$coef
plot(X, Y, 
     xlab = expression(coef[capillary]),
     ylab = expression(coef[plasma]), 
     pch = 16, col = "#00000040")
grid()
LM <- lm(Y ~ X)
abline(LM)
legend("topleft", paste0("R=", format(cor(X, Y), digits = 2)))
```

Finally, we compare the coefficients of all features between venous and
plasma samples by plotting them against each other:

```{r feature-comparison-coef-plas-ven, fig.path = IMAGE_PATH, fig.cap = "Comparison of coefficients of all features between plasma and venous blood samples", echo = FALSE}
X <- rowData(res_plas)$coef
Y <- rowData(res_ven)$coef
plot(X, Y, 
     xlab = expression(coef[plasma]),
     ylab = expression(coef[venous]), 
     pch = 16, col = "#00000040")
grid()
LM <- lm(Y ~ X)
abline(LM)
legend("topleft", paste0("R=", format(cor(X, Y), digits = 2)))
```

```{r}
save(res_pos, file = paste0(RDATA_PATH, "res_pos.RData"))
```

# Session information

The versions of R and the individually used packges are listed below.

```{r}
sessionInfo()
```

# References
