---
title: "Sex differences, semi-targeted analysis, negative polarity"
author: "SÃ¸ren Fjelstrup, Chiara Volani, Giuseppe Paglia and Johannes Rainer"
graphics: yes
output:
  BiocStyle::html_document:
    toc_float: true
bibliography: references.bib
csl: biomed-central.csl
references:
- id: dummy
  title: no title
  author:
  - family: noname
    given: noname
---

```{r biocstyle, echo = FALSE, results='hide', message = FALSE}
library(BiocStyle)
BiocStyle::markdown()
```

**Modified**: `r file.info("vams_sex_neg_semtar.Rmd")$mtime`<br />
**Compiled**: `r date()`

```{r settings, echo = FALSE, results = "hide", message = FALSE, warning = FALSE}
#' Set general options
options(useFancyQuotes = FALSE)
set.seed(18011977)

#' Define paths:
filename <- "vams_sex_neg_semtar"
#' Path to save the images; remove all old images.
IMAGE_PATH <- paste0("images/", filename, "/")
if (file.exists(IMAGE_PATH)) 
    unlink(IMAGE_PATH, recursive = TRUE)
dir.create(IMAGE_PATH, recursive = TRUE)
#' Path to store RData files
RDATA_PATH <- paste0("data/RData/", filename, "/")
if (!file.exists(RDATA_PATH)) dir.create(RDATA_PATH, recursive = TRUE)

#' Get the number of cpus allocated or fall back to 3
ncores <- as.integer(Sys.getenv("SLURM_JOB_CPUS_PER_NODE", 3))
```

# Introduction

This document describes the *semi-targeted* analysis to identify sex differences
in each of the 4 matrices. In contrast to the full untargeted data analysis
described in [vams_sex_neg.Rmd](vams_sex_neg.Rmd) (respectively the html/pdf
reports generated from that file) we focus here on a small set of features that
potentially represent metabolites for which standards were bought and measured
to define their approximate retention time.

Below we load all required libraries, define a color for each matrix and load
the normalized data.

```{r load-data , results='hide', message = FALSE}
library(xcms)
library(RColorBrewer)
library(pander)
library(doParallel)
registerDoParallel(ncores)
register(DoparParam(), default = TRUE)
#' register(SerialParam())
library(SummarizedExperiment)
library(limma)
library(UpSetR)

#' Load utility functions for the analysis
source("util-functions.R")

#' Define colors for the groups.
col_source <- brewer.pal(5, name = "Set1")[c(1, 2, 4, 5)]
names(col_source) <- c("RBC",           #' red
                       "plasma",        #' blue
                       "capillary",     #' purple
                       "venous")        #' orange

load("data/RData/vams_normalization_neg/vams_neg.RData")


```

Below we impute missing feature intensities. These are replaced with half of the
feature's smallest value in all samples adding a small standard deviation
thus avoiding constant values.

```{r Imputation-of-Values}
assays(vams_neg)$imputed <- imputeRowMinRand(
                    assay(vams_neg), min_fraction = 1/2,
                    sd_fraction = 1, abs = TRUE)

TestedSourcenames <-  c("capillary","plasma", "RBC", "venous")

```

# Filtering of the data set

We next subset the full data set consisting of abundances of `r nrow(vams_neg)`
features to the features potentially measuring the standards. See
[vams_matrix_neg_semtar.Rmd](vams_matrix_neg_semtar.Rmd) for the definition of
the features. Below we load the definition of the data subset and filter the
full data accordingly.

```{r filter, message = FALSE, warning = FALSE}
load("data/RData/vams_matrix_neg_semtar/res_matrix_neg_semtar.RData")
vams_neg_semtar <- vams_neg[rownames(res_matrix_neg), ]
rowData(vams_neg_semtar) <- cbind(rowData(vams_neg_semtar),
                                  res_matrix_neg[, c("hmdb_id", "name")])

```

# Differential abundance analysis

Next we aim to identify features with significant differences in their
abundances between male and female individuals. We perform the analysis first
separately for each matrix followed by a multiple regression approach on the
full data set. The methods used are described in
[vams_sex_pos.Rmd](vams_sex_pos.Rmd) and thus not detailed here.


## Separate analysis for each matrix

```{r volcanoplot-function, echo = FALSE}
col_volcano <- brewer.pal(4, name = "Set1")
col_volcano[1] <- "#DDDDDD" #' Grey
col_volcano_Trans <- paste0(col_volcano, 80)

volcanoplotFunction <- function(coef, pval, pLimit, foldLimit, Title,
                                xlim = range(coef), ylim = range(-log10(pval)),
                                col_volcano = paste0(
                                    brewer.pal(9, "Set1")[c(9, 9, 9, 3)], 60),
                                cex = 1) {
    
    colorFilterLowP <- as.matrix(pval) < pLimit
    colorFilterHighFold <- abs(coef) > foldLimit
    
    colorFilter <- 1 * colorFilterLowP
    colorFilter[colorFilterHighFold] <- 2
    colorFilter[colorFilterHighFold * colorFilterLowP == 1] <- 3
    colorFilter <- colorFilter + 1

    plot(coef, -log10(pval), cex = cex,
         pch = 16, main = Title, 
         col = col_volcano[colorFilter], 
         ylab = expression(log[2] ~ p[BH]-value), 
         xlab = expression(log[2] ~ fold ~ change),
         xlim = xlim, ylim = ylim)
    abline(h = -log10(pLimit), col = "grey", lty = 3)
    abline(v = c(-foldLimit, foldLimit), col = "grey", lty = 3)
}

```

```{r sex-fit-function-limma, message = FALSE, warning = FALSE}
pLimit <- 0.05
foldLimit <- 1
res_sex_neg_sep <- rowData(vams_neg_semtar)

for (src in TestedSourcenames) {
    sex <- vams_neg_semtar$sex[vams_neg_semtar$source == src]
    age <- vams_neg_semtar$age[vams_neg_semtar$source == src]
    dsgn <- model.matrix(~ sex)
    fit <- lmFit(log2(
        assay(vams_neg_semtar, "imputed")[, vams_neg_semtar$source == src]),
        design = dsgn)
    fit <- eBayes(fit)
    fitm <- cbind(fit$p.value[, "sexM"], fit$coefficients[, "sexM"],
                  p.adjust(fit$p.value[, "sexM"], method = "BH"))
    fitm <- cbind(fitm, fitm[, 3] < pLimit & abs(fitm[, 2]) > foldLimit)
    colnames(fitm) <- paste0(c("pvalue.", "coef.", "adj.pvalue.",
                               "significant."), src, ".sexM")
    res_sex_neg_sep <- cbind(res_sex_neg_sep, fitm)
}

```

Next we create histograms of the raw p-values.

```{r Histogramofpvalues, fig.path = IMAGE_PATH, echo = FALSE, fig.cap = "Histogram of the p values in each of the matrices of male vs female. The histograms generally show somewhat few significant features, especially for RBC", fig.width = 12, fig.height = 4}
par(mfrow = c(1, 4))
for (src in TestedSourcenames) {
    hist(res_sex_neg_sep[, paste0("pvalue.", src, ".sexM")],
         main = paste0("p-value of Male vs Female in ", src),
         xlab = "p-value")
}

```

In RBC samples we can again not observe any enrichment for small p-values, which
might be explained by the high variability in this matrix (see PCA plot in [vams_matrix_neg_semtar.html](vams_matrix_neg_semtar.html).

```{r sex-sep-volcano, fig.path = IMAGE_PATH, echo = FALSE, fig.cap = "Volcano plots representing the results for the comparison between male and female individuals. Analysis was performed separately for each matrix. Horizontal and vertical dotted lines indicate the cut-off criteria for significance.", fig.width = 12, fig.height = 4}
par(mfrow = c(1, 4))
xlim <- range(as.matrix(res_sex_neg_sep[, grep("^coef", colnames(res_sex_neg_sep))]))
ylim <- range(as.matrix(res_sex_neg_sep[, grep("^adj", colnames(res_sex_neg_sep))]), pLimit)
for (src in TestedSourcenames) {
    volcanoplotFunction(
        res_sex_neg_sep[, paste0("coef.", src, ".sexM")],
        res_sex_neg_sep[, paste0("adj.pvalue.", src, ".sexM")],
        pLimit = pLimit, foldLimit = foldLimit, xlim = xlim,
        ylim = range(-log10(ylim)), Title = paste0("M vs F ", src), cex = 1.2)
}

```

Only a two feature were found to have a more than two-fold significant
difference in abundance (in plasma) at a 5% FDR.

The table below lists all features that are found to be significant in at least
one of the matrices.

```{r sex-sep-sig-table, results = "asis", echo = FALSE}
sig_count <- rowSums(
    as.matrix(res_sex_neg_sep[, grep("significant", colnames(res_sex_neg_sep))]))
sig_fts <- rownames(res_sex_neg_sep)[sig_count > 0]
sig_fts <- sig_fts[order(sig_count[sig_fts], decreasing = TRUE)]

T <- res_sex_neg_sep[sig_fts, c("mzmed", "rtmed", "name", "QC_rsd",
                                "coef.capillary.sexM",
                                "coef.plasma.sexM", "coef.RBC.sexM",
                                "coef.venous.sexM", "adj.pvalue.capillary.sexM",
                                "adj.pvalue.plasma.sexM", "adj.pvalue.RBC.sexM",
                                "adj.pvalue.venous.sexM"), drop = FALSE]
colnames(T) <- sub(".sexM", "", colnames(T), fixed = TRUE)
cap <- paste0("Features with significant difference in abundances between ",
              "male and female individuals in at least one matrix.")
pandoc.table(as.data.frame(T), style = "rmarkdown", caption = cap)

```

At last we compare the top 10 features with the most significant differences
between male and female for each matrix to evaluate whether they are shared
between matrices.

```{r sex-sep-top-10-pval, echo = FALSE, fig.path = IMAGE_PATH, fig.cap = "Overlap of top 50 features with smallest p-values (male vs female)."}
fts_capillary <- rownames(res_sex_neg_sep)[
    order(res_sex_neg_sep$pvalue.capillary.sexM)][1:10]
fts_venous <- rownames(res_sex_neg_sep)[
    order(res_sex_neg_sep$pvalue.venous.sexM)][1:10]
fts_plasma <- rownames(res_sex_neg_sep)[
    order(res_sex_neg_sep$pvalue.plasma.sexM)][1:10]
fts_RBC <- rownames(res_sex_neg_sep)[
    order(res_sex_neg_sep$pvalue.RBC.sexM)][1:10]

fts_any <- unique(c(fts_capillary, fts_venous, fts_plasma, fts_RBC))
ovlp <- matrix(nrow = length(fts_any), ncol = 4, 0,
               dimnames = list(fts_any, c("capillary", "plasma", "RBC",
                                          "venous")))
ovlp[fts_capillary, "capillary"] <- 1
ovlp[fts_plasma, "plasma"] <- 1
ovlp[fts_RBC, "RBC"] <- 1
ovlp[fts_venous, "venous"] <- 1

upset(data.frame(ovlp))

```

The overlap is relatively low but one feature is among the top 10 features
across all matrices, 3 are common to venous and plasma and 2 each are common to
venous and capillary as well as to venous and RBC.

```{r sex-sep-export, echo = FALSE}
library(writexl)
write_xlsx(as.data.frame(res_sex_neg_sep),
           path = "data/xls/vams_sex_neg_semtar_sep_results.xlsx")

save(res_sex_neg_sep, file = paste0(RDATA_PATH, "res_sex_neg_sep.RData"))

```

```{r dependency-age, echo = FALSE, eval = FALSE}
ft <- "FT00371" #' poor QC rsd
ft <- "FT00222" #' OK QC rsd - EIC looks OK too.


cols <- rep("#ff0000", ncol(vams_neg_semtar))
cols[vams_neg_semtar$sex == "M"] <- "#0000ff"
par(mfrow = c(1, 4))
for (src in unique(vams_neg_semtar$source)) {
    keep <- which(vams_neg_semtar$source == src)
    X <- vams_neg_semtar$age[keep]
    Y <- log2(assay(vams_neg_semtar, "imputed")[ft, keep])
    plot(X, Y, col = cols[keep],
         main = src, ylab = expression(log[2]~abundance),
         xlab = "age", pch = NA)
    text(X, Y, col = cols[keep], vams_neg_semtar$sample[keep])
}

load("data/RData/vams_normalization_neg/data_neg.RData")
ft_chrom <- featureChromatograms(data_neg, features = ft)

plot(ft_chrom)

par(mfrow = c(2, 2))
plot(ft_chrom[, ft_chrom$source == "capillary"], main = "capillary")
plot(ft_chrom[, ft_chrom$source == "plasma"], main = "plasma")
plot(ft_chrom[, ft_chrom$source == "RBC"], main = "RBC")
plot(ft_chrom[, ft_chrom$source == "venous"], main = "venous")

fts <- rownames(res_sex_neg_sep)[grep("Creatine", res_sex_neg_sep$name)]
tmp <- featureChromatograms(data_neg, features = fts)

plot(tmp[, tmp$source == "capillary"], main = "capillary")
plot(tmp[, tmp$source == "plasma"], main = "plasma")
plot(tmp[, tmp$source == "RBC"], main = "RBC")
plot(tmp[, tmp$source == "venous"], main = "venous")

```


## Multiple regression analysis

We next use multiple linear regression to identify features (representing
standards) with different abundances between male and female study
participants. The corresponding methodology is detailed in
[vams_sex_neg.Rmd](vams_sex_neg.Rmd).

```{r Linear-fit-combined, message = FALSE, warning = FALSE}
sex <- vams_neg_semtar$sex
source <- vams_neg_semtar$source
age <- log2(vams_neg_semtar$age)
#' Define the design of the study
dsgn <- model.matrix(~ 0 + sex : source)
colnames(dsgn) <- sub(":", ".", colnames(dsgn), fixed = TRUE)

#' Fit the linear model
fit <- lmFit(log2(assay(vams_neg_semtar, "imputed")), design = dsgn)

#' Define and fit the contrasts
contr <- makeContrasts(
    capillary.sexM = sexM.sourcecapillary - sexF.sourcecapillary,
    plasma.sexM = sexM.sourceplasma - sexF.sourceplasma,
    RBC.sexM = sexM.sourceRBC - sexF.sourceRBC,
    venous.sexM = sexM.sourcevenous - sexF.sourcevenous,
    levels = dsgn)
fit <- contrasts.fit(fit, contr)
#' Calculate p-values
fit <- eBayes(fit)

#' Adjust for multiple hypothesis testing
adjp <- apply(fit$p.value, 2, p.adjust, method = "BH")

sign <- adjp < pLimit & abs(fit$coefficients) > foldLimit

res_sex_neg <- cbind(rowData(vams_neg_semtar),
                     pvalue = fit$p.value,
                     coef = fit$coefficients,
                     adj.pvalue = adjp,
                     significant = sign)

```

As before, histograms of the unadjusted p-values are made.

```{r sex-neg-pvalue-hist, fig.path = IMAGE_PATH, echo = FALSE, fig.cap = "Histogram of the p-values for male vs female in each of the matrices. Analysis was performed on the full data.", fig.width = 12, fig.height = 4}
par(mfrow = c(1, 4))
for (src in TestedSourcenames) {
    hist(res_sex_neg[, paste0("pvalue.", src, ".sexM")],
         main = paste0("p-value of Male vs Female in ", src),
         xlab = "p-value")
}

```

The enrichment for small p-values seems smaller than in the analysis performed
separately for each matrix. Next we create volcano plots representing the
results for the comparison between male and female individuals.

```{r sex-neg-volcano, fig.path = IMAGE_PATH, echo = FALSE, fig.cap = "Volcano plots representing the results for the comparison between male and female individuals. Analysis was performed on the full data.", fig.width = 12, fig.height = 4}
par(mfrow = c(1, 4))
xlim <- range(as.matrix(res_sex_neg[, grep("^coef", colnames(res_sex_neg))]))
ylim <- range(as.matrix(res_sex_neg[, grep("^adj", colnames(res_sex_neg))]))
for (src in TestedSourcenames) {
    volcanoplotFunction(
        res_sex_neg[, paste0("coef.", src, ".sexM")],
        res_sex_neg[, paste0("adj.pvalue.", src, ".sexM")],
        pLimit = pLimit, foldLimit = foldLimit, xlim = xlim,
        ylim = range(-log10(ylim)), Title = paste0("M vs F ", src), cex = 1.2)
}

```

More significant features are found in plasma and in venous samples, but none in
capillary and RBC samples.

The table below lists all features that are found to be significant in at least
one of the matrices.

```{r sex-neg-sig-table, results = "asis", echo = FALSE}
sig_count <- rowSums(
    as.matrix(res_sex_neg[, grep("significant", colnames(res_sex_neg))]))
sig_fts <- rownames(res_sex_neg)[sig_count > 0]
sig_fts <- sig_fts[order(sig_count[sig_fts], decreasing = TRUE)]

T <- res_sex_neg[sig_fts, c("mzmed", "rtmed", "name", "QC_rsd",
                            "coef.capillary.sexM",
                            "coef.plasma.sexM", "coef.RBC.sexM",
                            "coef.venous.sexM", "adj.pvalue.capillary.sexM",
                            "adj.pvalue.plasma.sexM", "adj.pvalue.RBC.sexM",
                            "adj.pvalue.venous.sexM")]
colnames(T) <- sub(".sexM", "", colnames(T), fixed = TRUE)
cap <- paste0("Features with significant difference in abundances between ",
              "male and female individuals in at least one matrix.")
pandoc.table(as.data.frame(T), style = "rmarkdown", caption = cap)

```

Differential abundance for none of the identified features seems to be
consistent across all 4 matrices. Note that including the age into the model did
not have any impact on this result.

At last we compare the top 10 features with the most significant differences
between male and female for each matrix to evaluate whether they are shared
between matrices.

```{r sex-neg-top-10-pval, echo = FALSE, fig.path = IMAGE_PATH, fig.cap = "Overlap of top 50 features with smallest p-values (male vs female)."}
fts_capillary <- rownames(res_sex_neg)[
    order(res_sex_neg$pvalue.capillary.sexM)][1:10]
fts_venous <- rownames(res_sex_neg)[
    order(res_sex_neg$pvalue.venous.sexM)][1:10]
fts_plasma <- rownames(res_sex_neg)[
    order(res_sex_neg$pvalue.plasma.sexM)][1:10]
fts_RBC <- rownames(res_sex_neg)[
    order(res_sex_neg$pvalue.RBC.sexM)][1:10]

fts_any <- unique(c(fts_capillary, fts_venous, fts_plasma, fts_RBC))
ovlp <- matrix(nrow = length(fts_any), ncol = 4, 0,
               dimnames = list(fts_any, c("capillary", "plasma", "RBC",
                                          "venous")))
ovlp[fts_capillary, "capillary"] <- 1
ovlp[fts_plasma, "plasma"] <- 1
ovlp[fts_RBC, "RBC"] <- 1
ovlp[fts_venous, "venous"] <- 1

upset(data.frame(ovlp))

```

The overlap is again very low.

```{r sex-neg-export, echo = FALSE}
write_xlsx(as.data.frame(res_sex_neg),
           path = "data/xls/vams_sex_neg_semtar_results.xlsx")

save(res_sex_neg, file = paste0(RDATA_PATH, "res_sex_neg.RData"))

```


# Session information

```{r sessionInfo}
devtools::session_info()
```

# References
