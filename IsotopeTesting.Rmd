---
title: "Isotope Testing"
author: "Søren Fjelstrup"
date: "14 maj 2019"
output: html_document
---


```{r biocstyle, echo = FALSE, results='hide', message = FALSE}
library(BiocStyle)
BiocStyle::markdown()
```

**Modified**: `r file.info("vams_matrix_pos.Rmd")$mtime`<br />
**Compiled**: `r date()`

```{r settings, echo = FALSE, results = "hide", message = FALSE, warning = FALSE}
#' Set general options
options(useFancyQuotes = FALSE)
set.seed(18011977)

#' Define paths:
filename <- "vams_matrix_pos"
#' Path to save the images; remove all old images.
IMAGE_PATH <- paste0("images/", filename, "/")
if (file.exists(IMAGE_PATH)) 
    unlink(IMAGE_PATH, recursive = TRUE)
dir.create(IMAGE_PATH, recursive = TRUE)
#' Path to store RData files
RDATA_PATH <- paste0("data/RData/", filename, "/")
if (!file.exists(RDATA_PATH)) dir.create(RDATA_PATH, recursive = TRUE)

#' Get the number of cpus allocated or fall back to 3
ncores <- as.integer(Sys.getenv("SLURM_JOB_CPUS_PER_NODE", 3))
```

# Introduction

This script was made to examine whether the isotope pairs found by CAMERA,
agrees with common sense. Namely that the M1 isotope should be mch rarer than
the M0, but that with increasing mass the ratio should slow shift towards more
isotopes, as the amount of C increases.
First the data and packages are loaded.

```{r load-data , results='hide', message = FALSE}
library(xcms)
library(SummarizedExperiment)


load("data/RData/vams_normalization/vams_pos.RData")
#' find path
load("Output/CAMERA/ExportTable.RData")

```

The features present in the vams_pos is extracted from the CAMERA data.

```{r Subsetting-of-ExportTable}
CAMERAData <- ExportTable[rownames(vams_pos),]

```

The features are now first ordered by whether they contain an isotope group or
note. After that Only pairs containing both a M0 and A M1 is retained, they are
paired and later compared.

```{r IsotopeGrouping}

rowMaxAbundance <- apply(assay(vams_pos, "abundances"), 1, max, na.rm = TRUE)

#' Logicals for parent, Isotope+1, Isotope+2

max(as.numeric(unlist(CAMERAData$isotopeGroups)))
Indices <- unique(as.numeric(unlist(CAMERAData$isotopeGroups)))
Indices <- Indices[!is.na(Indices)]


M0 <- c()
M1 <- c()
mz0 <- c()
mz1 <- c()

for (ind in Indices) {
isotopesInGroup <-
CAMERAData$isotopes[which(CAMERAData$isotopeGroups == ind)]
rowMaxAbundanceInGroup <-
rowMaxAbundance[which(CAMERAData$isotopeGroups == ind)]
mzInGroup <- CAMERAData$mz[which(CAMERAData$isotopeGroups == ind)]

if (any(grepl(pattern = "M\\]", isotopesInGroup)) &&
any(grepl(pattern = "M\\+1", isotopesInGroup))) {
M0[ind] <-
rowMaxAbundanceInGroup[grepl(pattern = "M\\]", isotopesInGroup)]
mz0[ind] <- mzInGroup[grepl(pattern = "M\\]", isotopesInGroup)]

mz1[ind] <- mzInGroup[grepl(pattern = "M\\+1", isotopesInGroup)]
M1[ind] <-
rowMaxAbundanceInGroup[grepl(pattern = "M\\+1", isotopesInGroup)]
}
}

Data <- cbind(M0, M1, mz0, mz1)
#' grepl(pattern = "M+2",CAMERAData$isotopeGroups)

boxplot(log2(M0), log2(M1),  ylab = expression(log[2] ~ abundance),
        names = (c("[M]", "[M+1]")),las = 1,  main = "Abundance of Isotopes")
plot( mz0, log2(M0) - log2(M1),  ylab = "log2[M]-log2[M+1]", xlab = "mz",
  main = "log2[M]-log2[M+1] vs mz")


```

As can be seen by the first plot the overall abundance of isotopes are lower
than the parent molecules, this is as expected, as a the chance of a Carbon atom
being an isotope is about 1.1%. Thus we would expect that as the molecular mass
increases so would the abundance of M1 compared to M0. We do not have the mass
of the isotope, but we do have the mz, which be proportional to the mass. We do
however expect the data to be somewhat noisy as many different compounds will be
present with different proportions of C-atoms to overall mass, note that they
may also contain other atoms with Isotopes, such as Nitrogen (0.4%), Hydrogen
(0.01%) and Oxygen (0.04%). ALthough Carbon will dominate.
