---
title: "Differential abundance analysis, semi-targeted approach"
subtitle: "Positive polarity"
author: "Christa Malfertheiner"
date: "25 August 2021"
output:
  BiocStyle::html_document:
    toc: true
    number_sections: false
    toc_float: true
bibliography: references.bib
csl: biomed-central.csl
references:
  - family: noname
    given: noname
---

```{r setup, echo = FALSE, results = "asis", warning = FALSE}
library(BiocStyle)
BiocStyle::markdown()
knitr::opts_chunk$set(echo = TRUE, message = FALSE, dev = c("png", "pdf"))
```

<!--
**Modified**: `r file.info("semi_t_matrices_pos.Rmd")$mtime`<br />
**Compiled**: `r date()`
-->

```{r parameters, echo = FALSE, warning = FALSE}
## Set general parameters
polarity <- "POS" # specify "POS" or "NEG"
p.cut <- 0.05     # cut-off for significance.
m.cut <- 0.7      # cut-off for log2 fold change
set.seed(123)
## Setting golden ratio to save images
phi <- (1+sqrt(5))/2
FILE_NAME <- "semi_t_matrices_pos"
## Define paths:
IMAGE_PATH <- paste0("images/", FILE_NAME, "/")
if (dir.exists(IMAGE_PATH)) unlink(IMAGE_PATH, recursive = TRUE, force = TRUE)
dir.create(IMAGE_PATH, recursive = TRUE, showWarnings = FALSE)
RDATA_PATH <- paste0("data/RData/", FILE_NAME, "/")
dir.create(RDATA_PATH, recursive = TRUE, showWarnings = FALSE)
RESULT_PATH <- paste0("data/results/", FILE_NAME, "/")
dir.create(RESULT_PATH, recursive = TRUE, showWarnings = FALSE)
```

# Introduction

In this document we perform the differential abundance analysis of the features
previously identified for the *MitYOU* project, with the aim of identifying
significant sample source-related features. This task is performed by hypothesis
testing, where we try to identify which metabolites have the most different 
concentrations between plasma samples, venous and capillary blood samples. 
We follow a semi-targeted approach, where we look at concentrations of features
corresponding to lab-internal set of standards.


# Data import

First, we load the required packages and the data, after preprocessing and
normalization. The end result of these steps is a `SummarizedExperiment` that
contains aligned data, where features are grouped (after correspondence), and
that have undergone gap filling, normalization by the median, linear fitting and 
per-feature between-batch normalization to remove any unwanted variability. 
The `SummarizedExperiment` lets us store all the information regarding the 
normalization steps in the form of `assays`, which we are still able to access 
to proceed with the analysis.

```{r load-data, echo = FALSE, warning = FALSE}
library(xcms)
library(limma)
library(pheatmap)
library(writexl)
library(SummarizedExperiment)
library(RColorBrewer)
library(MsFeatures)
library(CompMetaboTools)
library(pander)
load("data/RData/vams_normalization_pos/res_pos.RData")
res_pos$sample_pair <- paste0(res_pos$source, ".", res_pos$sample)
```

It is important now to remove the `POOL` samples from the dataset, because the
analysis has to be performed only on study samples; the `POOL` samples, though
are still required to evaluate the goodness of the detected features, therefore
they will be stored in a separate `SummarizedExperiment` object that can be
accessed when needed.
We also exclude the `RBC` samples from our analysis, as these samples showed
a noisy signal beforehand. We also store them separatedly in a 
`SummarizedExperiment` object

We also assign the colours as seen before.

```{r split-qc, echo = TRUE}
res_qc <- res_pos[, res_pos$source == "all"]
res_rbc <- res_pos[, res_pos$source == "RBC"]
res_pos <- res_pos[, res_pos$source != "all"]
res_pos <- res_pos[, res_pos$source != "RBC"]
res_pos$source <- factor(as.character(res_pos$source))
res_pos$sex <- factor(as.character(res_pos$sex))
col_source <- brewer.pal(5, name = "Set1")
names(col_source) <- c("RBC",           #' red
                       "plasma",        #' blue
                       "all",           #' green
                       "capillary",     #' purple
                       "venous")        #' orange
col_sex <- brewer.pal(4, name = "Set1") [c(1, 2, 3)]
names(col_sex) <- c("F",           # red
                    "M",           # blue
                    "POOL")        # green
## Setting golden ratio to save images
phi <- (1+sqrt(5))/2
```

Next, we merge the technical replicates.

```{r}
#' Average 
averageSE <- function(x, column = character(), mainAssay = character()) {
    if (!column %in% colnames(colData(x)))
        stop("Column '", "' not found in 'colData' of 'x'")
    f <- factor(colData(x)[, column], levels = unique(colData(x)[, column]))
    ## new colData: take the first element for each replicate.
    cd <- colData(x)[match(levels(f), f), ]
    ## loop over the assays and average them.
    a <- lapply(assays(x), function(z) {
        z <- split.data.frame(t(z), f = f)
        z <- do.call(cbind, lapply(z, colMeans, na.rm = TRUE))
        z[is.na(z)] <- NA
        z
    })
    if (length(mainAssay)) {
        tmp <- split.data.frame(t(assay(x, mainAssay)), f = f)
        tmp <- do.call(cbind, lapply(tmp, function(y) {
            apply(y, MARGIN = 2, FUN = sd, na.rm = TRUE)
        }))
        tmp[is.na(tmp)] <- NA
        a[[paste0(mainAssay, "_sd")]] <- tmp
    }
    SummarizedExperiment(assays = a, rowData = rowData(x),
                         colData = cd, metadata = metadata(x))
}
## Average technical replicates:
res_pos <- averageSE(res_pos, column = "sample_pair",
                     mainAssay = "normalized_filled")
```

The samples used in this analysis are listed below.

```{r, echo = FALSE, results = "asis"}
tab <- colData(res_pos)[, c("source", "sex", "age")]
pandoc.table(as.data.frame(tab), style = "rmarkdown",
             caption = "Samples used in this analysis")
```

# Semi-targeted analysis

First, we restrict the analysis to a set of known compounds, whose
mass-to-charge ratio and retention time have been previously measured from the
pure standards. To start, a table of standards is loaded, then
a search in the m/z and retention time dimensions is carried out to match the
features found before to these compounds. Subsequently, EICs for all the
assigned features are plotted and visually inspected: this step is necessary to
accurately pair the detected peaks to the standards. When the list of assigned
standards is complete, we perform a differential abundance analysis on the
subset of features.

First, we load the information on the standards, with the aim of identifying
features potentially matching these and plotting the EICs for all of these.

```{r known-cmps, message = FALSE, warning = FALSE}
## Extract known compunds
library("MetaboCoreUtils")
library(Rdisop)
std_info <- read.table(
    "https://raw.githubusercontent.com/EuracBiomedicalResearch/lcms-standards/master/data/standards_dilution.txt",
    sep = "\t", header = TRUE, as.is = TRUE)
std_info <- std_info[!is.na(std_info[, "POS"]), ]
rownames(std_info) <- 1:nrow(std_info)
std_info$mzneut = NA
std_info$mz_ion = NA
for (i in seq(nrow(std_info))) {
    if (grepl("C", std_info$formula[i])) {
        std_info$mzneut[i] <- getMolecule(
            as.character(std_info$formula[i]))$exactmass
    } else {
        std_info$mzneut[i] = as.numeric(std_info$formula[i])
    }
    ## Calculate also the m/z
    std_info$mz_ion[i] <- mass2mz(
        std_info$mzneut[i], adduct = std_info[i, "POS"])[1, 1]
}
std_info <- std_info[!is.na(std_info$mz_ion), ]
std_info <- std_info[order(std_info$name), ]

## Manually adding an additional row for Creatinine and Creatine
to_add <- std_info[std_info$name %in% c("Creatinine", "Creatine"), ]
to_add$name <- paste0(to_add$name, "-full")
std_info <- rbind(std_info, to_add)

dr <- paste0(IMAGE_PATH, "/standards/")
dir.create(dr, recursive = TRUE, showWarnings = FALSE)
##load data_pos
load("data/RData/vams_normalization_pos/data_pos_filled.RData")
## Subset to the samples we're currently analyzing.
tmp <- filterFile(data_pos, match(res_pos$mzML_file, data_pos$mzML_file),
                  keepFeatures = TRUE)
```

We next match features from our data set against m/z of the expected ions and
the retention times for the set of lab-internal standards, extract their ion
chromatogram and plot these.

```{r}
## Match feature's m/z and rt values against expecte values for standards.
library(MetaboAnnotation)
rowData(res_pos)$ft <- row.names(res_pos)
## Note: would need a ppm of 40 to get Homocysteine-FT0178
par <- MzRtParam(tolerance = 0, ppm = 20, toleranceRt = 30)
mo <- matchMz(res_pos, std_info, param = par, mzColname = c("mzmed", "mz_ion"), 
              rtColname = c("rtmed", "RT"))
## Subset to matching features.
mo <- mo[whichQuery(mo)]
mo <- pruneTarget(mo)

chrs <- featureChromatograms(tmp, features = mo$ft, expandRt = 7, filled = TRUE)
sample_colors <- col_source[tmp$source]
for (i in seq_len(length(mo$ft))) {
    chr <- chrs[i, ]
    pks <- chromPeaks(chr)
    fl <- mo$target_name[i]
    png(paste0(dr, fl, "-", mo$ft[i], ".png"),
        width = 10, height = 8, units = "cm", res = 300, pointsize = 6)
    plot(chr, col = "#00000040",
         peakCol = paste0(sample_colors[pks[, "column"]], 50),
         peakBg = paste0(sample_colors[pks[, "column"]], 10))
    abline(v = mo$target_RT[i])
    legend("topleft", legend = c(mo$ft[i], fl,
                                 paste0("rt: ", mo$target_RT[i]),
                                 paste0("mz: ", mo$target_mz_ion[i])))
    dev.off()
}

```

The EICs have been manually inspected and the best matching feature has been
manually assigned to the corresponding standard.

```{r assign-feature-metabolite, echo = FALSE, warning = FALSE, message = FALSE}
## This is the tricky manual thing:
## - Go through all plots for all standards and if there is one feature
##   that clearly matches (i.e. retention time close to the expected retention
##   time and a single peak present in the wider rt range) assign it.

to_keep <- c(FT0293 = "1-Methylhistidine",
             FT0293 = "3-Methylhistidine", # same as 1-Methylhistidine
             FT0154 = "5-Oxoproline",
             FT0415 = "Acetylcarnitine",
             FT0518 = "Acetyl-Glucosamine",
             FT0384 = "Acetylhistidine",
             FT0407 = "ADMA",
             FT0051 = "Alanine",
             FT0268 = "alpha-Aminoadipic acid",
             FT1330 = "alpha-Lactose", # or FT1331
             FT1197 = "AMP",
             FT0307 = "Arginine",
             FT0162 = "Asparagine",
             ## c("Betaine", "FT0111/FT0112"),
             FT0486 = "C4 Carnitine",
             FT0527 = "C5 Carnitine", # rt shifted 10s
             FT0378 = "Caffeine",
             FT0472 = "Carnosine",
             ## c("Choline", "FT0072"),
             FT0312 = "Citrulline",
             ## c("Corticosterone", "FT1193"), # rt shifted 10s
             ##c("Creatine", "FT0159/FT0160"),
             ##c("Creatinine", "FT0099/FT0100"),
             FT0507 = "Cystine",
             FT1198 = "dGMP",
             FT0402 = "Fructose", # same as glucose and mannose
             FT0420 = "Galactitol", # same as sorbitol
             FT0460 = "Gluconic Acid",
             FT0402 = "Glucose", # same as Fructose
             FT0215 = "Glutamine",
             FT3342 = "Glutathione Oxidized", # same as Glu. Reduced
             FT3342 = "Glutathione Reduced", # same as Glu. Oxidized
             FT0581 = "Glycero-phosphocholine",
             FT0031 = "Glycine",
             FT0249 = "Histidine",
             ## FT0178 = "Homocysteine",      # only found with ppm 40
             FT0158 = "Hydroxyproline",
             FT0182 = "Hypoxanthine",
             FT0161 = "Isoleucine",
             FT0168 = "L-Aspartic Acid", # or FT0169
             FT0270 = "L-Carnitine", 
             FT0123 = "L-Cysteine",
             FT0161 = "Leucine",
             ##c("Levodopa", "FT0384"), # found with ppm = 50
             FT0220 = "L-Glutamic Acid",
             FT0216= "Lysine",
             FT0402 = "Mannose", # same as Fructose and Glucose
             FT0226 = "Methionine",
             FT0280 = "Methioninesulfoxide", 
             ## c("Myoinositol", "FT0402"), # detected as FT0820 and FT0821 - same as fructose, glucose and mannose
             FT0306 = "N-Acetylornithine",
             FT3776 = "NAD",
             FT0134 = "Niacinamide",
             FT0165 = "Ornithine",
             FT1588 = "Palmitoylcarnitine", # or FT1589
             FT0281 = "Phenylalanine",
             ##c("Phenylethylamine", "FT0129"),
             ##c("Phosphocreatine", "FT0436"),
             FT0338 = "Phosphorylcholine",
             FT0201 = "Phosphorylethanolamine",
             ##c("Pipecolic acid", "FT0155"),
             ## c("Proline", "FT0107/FT106"),
             ##c("Putrescine", "FT0024"),
             FT1481 = "SAH",
             FT1583 = "SAMe",
             FT0407 = "SDMA",
             FT0079 = "Serine",
             FT0420 = "Sorbitol", # same as galactitol
             FT1451 = "Sphingosine-1-phosphate",
             FT0843 = "Sphingosine",
             FT1331 = "Sucrose", # or FT1330
             FT0146 = "Taurine",
             FT0117 = "Threonine",
             FT0422 = "Tryptophan",
             FT0328 = "Tyrosine",
             FT0112 = "Valine",
             FT0160 = "Creatine",
             FT5630 = "Creatine-full",
             FT0099 = "Creatinine",
             FT5631 = "Creatinine-full")

mo <- filterMatches(mo, queryValue = names(to_keep), 
                    targetValue = to_keep, 
                    queryColname = "ft",
                    targetColname = "target_name",
                    keep = TRUE)
mo <- mo[whichQuery(mo)]
mo <- pruneTarget(mo) # Probably it's not very useful but since these two lines
# are used one after the other we could create a function e.g. reduceMatched 
# that does the two things

## Handling duplicates.
md <- as.data.frame(matchedData(mo, c("ft", "target_name", "target_HMDB.code")))
md <- split(md, md$ft)
md <- do.call(rbind, lapply(md, function(z) {
    tmp <- data.frame(ft = z$ft[1L])
    tmp$name <- paste0(z$target_name, collapse = ";")
    tmp$HMDB <- paste0(z$target_HMDB.code, collapse = ";")
    tmp
}))
```

A total of `r sum(nrow(md))` standards have been identified. The features
identified and the corresponding metabolite are summarized in this table:

```{r result-table-ft-std, echo = FALSE, results = "asis"}
## Write result table
md <- md[order(md$name), ]
pandoc.table(md[, c("ft", "name")], style = "rmarkdown",
             caption = "Features assigned to known compounds")
```

Next, only the features assigned to the standards are taken into consideration
and are subsetted in the `std_res` object.

```{r std-subset, echo = FALSE}
std_res <- query(mo)
rowData(std_res) <- cbind(rowData(std_res),
                          md[rownames(std_res), c("name", "HMDB")])
```

The subsetting reduced the number of features to `r length(std_res)`. 

A PCA analysis is then performed on the subset to verify whether anything has
changed and if any similarities among the samples are visible or not.

```{r standards-pca-all, echo = FALSE}
pc <- prcomp(t(log2(assay(std_res, "normalized_filled_imputed"))),
                 center = TRUE, scale. = FALSE)
```

```{r standards-pca-plot, fig.path = IMAGE_PATH, fig.cap = "PCA of the samples based on intensities of known compounds.", fig.width = 7 * phi, fig.height = 7, echo = FALSE}
par(mfrow = c(1, 2))
plot_pca(pc, col = paste0(col_source[as.character(std_res$source)], 90),
         pc_x = 1, pc_y = 2, labels = std_res$differentiation)
plot_pca(pc, col = paste0(col_source[as.character(std_res$source)], 90),
         pc_x = 3, pc_y = 4)
legend("topleft", col = col_source, legend = names(col_source),
       title = "phenotype", pch = 16, ncol = 2)
```

In the PC1 plot, we see a clear separation between the three matrices, which is 
also seen in PC2.In PC3, some of the capillary samples do not cluster with the
rest of the samples, but it needs to be considered that the variance described 
by this dimension is rather low.

## Heatmap 

To visualize the intensity of all detected standards across the three matrices,
we created a heatmap of the known compounds we found in our samples.

```{r heatmap-source-semitargeted, fig.width = 15, fig.height = 13, fig.cap = "Heatmap of known compounds. Note that for better visibility, the color range has been restricted to -5 to 5, thus, differences larger than these values are assigned the extreme colors.", echo = FALSE, fig.path = IMAGE_PATH}
## Create heatmap
tmp <- log2(assay(
    std_res, "normalized_filled_imputed")[rownames(std_res), , drop = FALSE])
tmp <- tmp - rowMeans(tmp, na.rm = TRUE)
rownames(tmp) <- rowData(std_res)$name
colnames(tmp) <- std_res$source_sample
ann <- as.data.frame(colData(std_res)[, c("source", "sex")])
rownames(ann) <- colnames(tmp)

pm <- pheatmap(tmp, annotation_col = ann, labels_col = colnames(tmp),
               breaks = seq(-5, 5, length.out = 101),
               annotation_color = list(source = col_source,
                                   sex = col_sex))

```

In the heatmap we see two main cluster, one containing all plasma samples and 
the other containing all venous and capillary blood samples, which indicates
a higher similarity in the intensities of the lab internal standards for these
sample matrices. The second cluster is then split up in two subclusters, 
containing all samples from each matrix.

Metabolites also clearly cluster into different group. One cluster contains only
**Cystine** (FT0507) which shows a high intensity in plasma samples, but has a
low intensity in capillary and venous samples. In contrast, another cluster of
14 metatolites shows higher concentrations in venous and capillary
samples. Finally, a cluster of 5 metabolites (Acetylhistidine, Sucrose, Gluconic
Acid, Methioninesulfoxide and alpha-Lactose, has highest concentrations in
capillary samples while it has lower concentrations in the other two matrices.



## Present and absent features

We then wanted to check if there are compounds that are only present in some of
the three matrices. For a metabolite to be *present* we require that a signal
was detected by the MS instrument for that metabolite in a large fraction of
samples of a certain sample matrix. We thus call a metabolite to be present, if
a chromatographic peak was detected in 2/3 or samples per matrix. Therefore, we
use below the `raw` data of our three sample sources (which only contains
intensity values for detected chromatographic peaks) and looked, which compounds
are present in more than 2/3 of the samples.

```{r Present and absent features, echo = FALSE}
plas <- assay(std_res, "raw")[, std_res$source == "plasma"]
plas_present <- moreAreValidThan(plas, prop = 2/3)

ven <- assay(std_res, "raw")[, std_res$source == "venous"]
ven_present <- moreAreValidThan(ven, prop = 2/3)

cap <- assay(std_res, "raw")[, std_res$source == "capillary"]
cap_present <- moreAreValidThan(cap, prop = 2/3)


```


We then create a plot an `UpSetR` plot to see the overlap of present features:

```{r present-feature-comparison-upset, fig.path = IMAGE_PATH, fig.cap = "Overlap of present features across the 3 sample matrices.", echo = FALSE, eval = TRUE}
#create an UpSetR plot
library(UpSetR)

listInput <- list(capillary = which(cap_present, useNames = TRUE),
                  venous = which(ven_present, useNames = TRUE),
                  plasma = which(plas_present, useNames = TRUE))
upset(fromList(listInput), order.by = "freq")
```

The majority of known compounds, 35 features, are present in all three sample
sources, whereas 10 features are only present in capillary and venous blood 
samples and 9 features are only present in capillary blood samples. 2 features
are present in plasma and venous blood samples, but absent in capillary blood 
samples and one feature is only present in plasma samples.

We want to identify the features present in only some of the matrices, starting
with features that are only present in capillary blood samples:

```{r present-features_cap, echo = FALSE, results = "asis"}

#identify features present in only one or two matrices
only_cap <- rowData(std_res)[cap_present & !ven_present & !plas_present, ]
only_plas <- rowData(std_res)[plas_present & !ven_present & !cap_present, ]
only_capven <- rowData(std_res)[cap_present & ven_present & !plas_present, ]
only_venplas <- rowData(std_res)[ven_present & plas_present & !cap_present, ]

## Calculate average concentration per matrix
aname <- "normalized_filled_imputed"
std_res_avg = cbind(
    capillary = rowMeans(assay(std_res, aname)[, std_res$source == "capillary"],
                         na.rm = TRUE),
    venous = rowMeans(assay(std_res, aname)[, std_res$source == "venous"],
                         na.rm = TRUE),
    plasma = rowMeans(assay(std_res, aname)[, std_res$source == "plasma"],
                         na.rm = TRUE)
    )

## Write result table
tab <- data.frame(name = only_cap[, c("name")],
                  std_res_avg[rownames(only_cap), ])
pandoc.table(tab, style = "rmarkdown",
             caption = "Features only present in capillary blood samples")

```

Then we take a look at the feature, which is only present in plasma samples:

```{r present-features_plas, echo = FALSE, results = "asis"}
tab <- data.frame(name = only_plas[, c("name")],
                  std_res_avg[rownames(only_plas), , drop = FALSE])
pandoc.table(as.data.frame(tab), style = "rmarkdown",
             caption = "Features only present in plasma samples")
```

Next, we want to identify the features that are present in capillary and venous
blood samples, but absent in plasma samples:

```{r present-features_cap_ven, echo = FALSE, results = "asis"}
tab <- data.frame(name = only_capven[, c("name")],
                  std_res_avg[rownames(only_capven), , drop = FALSE])
pandoc.table(as.data.frame(tab), style = "rmarkdown",
             caption = "Features only present in capillary and venous blood samples")
```

And lastly, we take a look at the features found in plasma and venous blood
samples, but not in capillary blood:

```{r present-features_ven_plas, echo = FALSE, results = "asis"}
tab <- data.frame(name = only_venplas[, c("name")],
                  std_res_avg[rownames(only_venplas), , drop = FALSE])
pandoc.table(as.data.frame(tab), style = "rmarkdown",
             caption = "Features only present in plasma and venous blood samples")
```

Now, we start with the differential abundance analysis.

## Differential abundance analysis

We next identify metabolites with significant differences in their abundances
between the sample matrices. The differential abundance analysis is performed
on the subset of features that have previously been assigned to the
standards. We apply feature-wise multiple linear regression using the `lmFit`
function and we add the matrix defining the contrasts using
`contrast.fit`. Then, we calculate the p-values with `eBayes`.  Subsequently, we
generate a data frame with the coefficients, the raw and adjusted p-values (we
apply a Benjamini-Hochberg correction for better control of the false discovery
rate), the average intensity of signals in plasma samples, capillary and venous
blood samples and whether or not a feature is to be considered significant.

```{r standards-analysis cap/ven, echo = FALSE}
source <- factor(std_res$source)
sex <- factor(std_res$sex)

dsgn <- model.matrix(~ 0 + source + sex)
fit <- lmFit(log2(assay(std_res, "normalized_filled_imputed")), design = dsgn)

## Fit the actual contrasts of interest
contr_mat <- makeContrasts(
    CapvsVen = sourcecapillary - sourcevenous,
    CapvsPlas = sourcecapillary - sourceplasma,
    VenvsPlas = sourcevenous - sourceplasma,
    levels = dsgn)
fit <- contrasts.fit(fit, contrasts = contr_mat)
fit <- eBayes(fit)
adjp <- apply(fit$p.value, 2, p.adjust, method = "BH")
tmp <- data.frame(
    coef = fit$coefficient,
    pvalue = fit$p.value,
    adjp = adjp,
    avg = std_res_avg,
    significant = adjp < p.cut & abs(fit$coefficient) > m.cut
)
rowData(std_res) <- cbind(rowData(std_res), tmp)
```

We plot then the distribution of p-values, both raw and adjusted:

```{r standards-p-value-histogram, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "Distribution of raw (left) and adjusted p-values (right) for all 3 comparisons."}
par(mfrow = c(3, 2))
hist(rowData(std_res)$pvalue.CapvsPlas, breaks = 64, xlab = "p value",
     main = "Capillary vs plasma")
hist(rowData(std_res)$adjp.CapvsPlas, breaks = 64,
     xlab = expression(p[BH]~value),
     main = "Capillary vs plasma")
hist(rowData(std_res)$pvalue.VenvsPlas, breaks = 64, xlab = "p value",
     main = "Venous vs plasma")
hist(rowData(std_res)$adjp.VenvsPlas, breaks = 64,
     xlab = expression(p[BH]~value),
     main = "Venous vs plasma")
hist(rowData(std_res)$pvalue.CapvsVen, breaks = 64, xlab = "p value",
     main = "Capillary vs venous")
hist(rowData(std_res)$adjp.CapvsVen, breaks = 64,
     xlab = expression(p[BH]~value),
     main = "Capillary vs venous")
```

Thus, most of the metabolites were identified to have significantly different
concentrations between the comparison. A table with the number of significant
metabolites is shown below.

```{r table-sig, echo = FALSE, results = "asis"}
tab <- colSums(as.matrix(rowData(std_res)[, grep("significant", colnames(rowData(std_res)))]))
pandoc.table(tab, style = "rmarkdown",
             caption = "Number of significant metabolites.")
```

### Capillary *vs* venous

The volcano plot below shows the results for the comparison of capillary and
venous samples.

```{r standards-volcano-cap-ven, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 6, fig.height = 6, fig.cap = "Volcano plot for the comparison of capillary against venous samples."}
par(mfrow = c(1, 1))
plot_volc <- function(x, main) {
    plot(rowData(std_res)[, paste0("coef.", x)],
         -log10(rowData(std_res)[, paste0("adjp.", x)]),
         xlab = expression(log[2]~difference),
         ylab = expression(-log[10]~p[BH]), pch = 16, col = "#00000060",
         main = main)
    rect(xleft = -100, ybottom = -log10(p.cut), xright = -m.cut, ytop = 100,
         border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
    rect(xleft = m.cut, ybottom = -log10(p.cut), xright = 100, ytop = 100,
         border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
    sigs <- rowData(std_res)[, paste0("significant.", x)]
    if (any(sigs))
        points(rowData(std_res)[sigs, paste0("coef.", x)],
               -log10(rowData(std_res)[sigs, paste0("adjp.", x)]),
               col = "#0000ffcc")
}
plot_volc("CapvsVen", main = "Capillary vs venous")

```

In total `r sum(rowData(std_res)$significant.CapvsVen)` feature were found to 
have a significant difference in abundances between the two groups. The table 
below lists these features (or the 20 features with the smallest p-values if no
feature was found significant).

```{r significant-standards-result-table capillary/venous, echo = FALSE, results = "asis"}
sig_table <- function(x, caption = "") {
    sigs <- rowData(std_res)[, paste0("significant.", x)]
    tab <- rowData(std_res)[sigs, c("name", paste0("coef.", x),
                                    paste0("adjp.", x), "avg.capillary",
                                    "avg.venous", "avg.plasma")]
    tab <- tab[order(tab[, paste0("adjp.", x)]), ]
    pandoc.table(
        as.data.frame(tab), style = "rmarkdown",
        caption = caption
    )
    invisible(tab)
}
tab <- sig_table(
    "CapvsVen", "Metabolites significant between capillary and venous samples.")

```

We now create the beeswarm plot:

```{r beeswarm capillary/venous, echo = FALSE}
library(beeswarm)

bee_plots <- function(x, tab) {
    std_sig <- std_res[rowData(std_res)[, paste0("significant.", x)], ]
    tmp <- log2(assay(std_sig, "normalized_filled_imputed"))
    rownames(tmp) <- rowData(std_sig)$name
    dr <- paste0(IMAGE_PATH, x, "-beeswarm/")
    dir.create(dr, recursive = TRUE, showWarning = FALSE)
    for (i in seq_len(nrow(tmp))) {
        vals <- split(tmp[i, ], f = std_sig$source)
        col <- col_source[names(vals)]
        png(file = paste0(dr, rownames(std_sig)[i],
                          "_", rownames(tmp)[i], ".png"),
            width = 6 * phi, height = 6, units = "in", res = 300,
            pointsize = 12)
        par(mar = c(5, 5, 5, 1))
        beeswarm(vals, col = paste0(col, 80), pch = 16, cex = 1.5,
                 spacing = 1.2,
                 cex.main = 1.5,
                 cex.lab = 1.5,
                 cex.axis = 1.3,
                 main = paste0(rownames(std_sig)[i], ": ", rownames(tmp)[i]),
                 ylab = expression(log[2]~intensity))
        bxplot(vals, probs = 0.5, col = "#00000060", add = TRUE, width = 0.9)
        dev.off()
    }
}
bee_plots("CapvsVen", tab)

```

![](images/semi_t_matrices_pos/CapvsVen-beeswarm/FT0384_Acetylhistidine.png)
**Acetylhistidine** shows a significant higher concentration in capillary blood
samples compared to venous blood samples. 

![](images/semi_t_matrices_pos/CapvsVen-beeswarm/FT1331_Sucrose.png)
Also, the intensity of **Sucrose** is higher in capillary samples than in the
other two matrices.

![](images/semi_t_matrices_pos/CapvsVen-beeswarm/FT0079_Serine.png)

**Serine** shows also higher intensity levels in capillary blood samples 
compared to plasma and venous blood samples.

Of the `r sum(rowData(std_res)$significant)` significant features, only three
show a higher intensity in venous blood:

![](images/semi_t_matrices_pos/CapvsVen-beeswarm/FT0112_Valine.png)

![](images/semi_t_matrices_pos/CapvsVen-beeswarm/FT0160_Creatine.png)

![](images/semi_t_matrices_pos/CapvsVen-beeswarm/FT0226_Methionine.png)
While **Valine** and **Methionine** show comparable intensities in plasma and 
venous blood samples, **Creatine** levels are higher in venous blood compared
to both plasma and capillary blood samples. 


### Capillary *vs* plasma

The volcano plot below shows the results for the comparison of capillary and
plasma samples.

```{r standards-volcano-cap-plas, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 6, fig.height = 6, fig.cap = "Volcano plot for the comparison of capillary against plasma samples."}
par(mfrow = c(1, 1))
plot_volc("CapvsPlas", main = "Capillary vs plasma")

```

In total `r sum(rowData(std_res)$significant.CapvsPlas)` feature were found to 
have a significant difference in abundances between the two groups. The table 
below lists these features (or the 20 features with the smallest p-values if no
feature was found significant).

```{r significant-standards-result-table capillary/plasma, echo = FALSE, results = "asis"}
tab <- sig_table(
    "CapvsPlas", "Metabolites significant between capillary and plasma samples.")

```

We now create the beeswarm plot:

```{r beeswarm capillary/plasma, echo = FALSE}
bee_plots("CapvsPlas", tab)

```

![](images/semi_t_matrices_pos/CapvsPlas-beeswarm/FT0507_Cystine.png)
As already seen in the heatmap, **Cystine** shows a much higher intensity in
plasma samples compared to venous and capillary blood samples. 

![](images/semi_t_matrices_pos/CapvsPlas-beeswarm/FT0338_Phosphorylcholine.png)
Both, **Acetylhistidine** and **Phosphorylcholine** show higher intensities in 
capillary and venous blood samples compared to plasma samples.

Of the `r sum(rowData(std_res)$significant)` significant features, six showed
a higher intensity in plasma: **Cystine**, **Valine**, **Arginine**, 
**Fructose, Glucose, Mannose**, **Methylhistidine** and **Methionine**.


### Venous *vs* plasma

The volcano plot below shows the results for the comparison of capillary and
venous samples.

```{r standards-volcano-ven-plas, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 6, fig.height = 6, fig.cap = "Volcano plot for the comparison of venous against plasma samples."}
par(mfrow = c(1, 1))
plot_volc("VenvsPlas", main = "Venous vs plasma")

```

In total `r sum(rowData(std_res)$significant.VenvsPlas)` feature were found to 
have a significant difference in abundances between the two groups. The table 
below lists these features (or the 20 features with the smallest p-values if no
feature was found significant).

```{r significant-standards-result-table venous/plasma, echo = FALSE, results = "asis"}
tab <- sig_table(
    "VenvsPlas", "Metabolites significant between venous and plasma samples.")

```

We now create the beeswarm plot:

```{r beeswarm venous/plasma, echo = FALSE}
bee_plots("VenvsPlas", tab)

```

As already seen previously, **Cystine** shows a much higher intensity in plasma 
samples compared to the other two sample matrices.

![](images/semi_t_matrices_pos/VenvsPlas-beeswarm/FT3342_Glutathione Oxidized;Glutathione Reduced.png)
The intensity level of **Glutathione** and **Phosphorylcholine** is higher in 
capillary and venous blood samples, compared to plasma samples.

Of the `r sum(rowData(std_res)$significant)` features found to have a 
significant difference in intensity between plasma and venous blood samples,
only six have a higher intensity in plasma samples:
**Hydroxyproline**, **Isoleucine, Leucine**, **Arginine**, **Tryptophan**,
**Fructose, Glucose, Mannose** and **Cystine**.


Finally, we take a look at the overlap of features that show a significant 
difference between the intensity in capillary and plasma samples and features 
that show a significant difference between the intensity in venous and plasma
samples:

```{r significant-feature-comparison-upset, fig.path = IMAGE_PATH, fig.cap = "Overlap of significant features in matrix comparisons.", echo = FALSE, eval = TRUE}
listInput <- list(
    capillaryVSplasma = which(rowData(std_res)$significant.CapvsPlas),
    venousVSplasma = which(rowData(std_res)$significant.VenvsPlas))
upset(fromList(listInput), order.by = "freq")
```

Most of the significant features were found in both matrix comparisons.

# Session information

The versions of R and the individually used packges are listed below.

```{r}
sessionInfo()
```
