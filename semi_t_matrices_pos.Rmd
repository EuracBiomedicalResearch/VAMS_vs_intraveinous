---
title: "Differential abundance analysis, semi-targeted approach"
subtitle: "Positive polarity"
author: "Christa Malfertheiner"
date: "25 August 2021"
output:
  BiocStyle::html_document:
    toc: true
    number_sections: false
    toc_float: true
bibliography: references.bib
csl: biomed-central.csl
references:
  - family: noname
    given: noname
---

```{r setup, echo = FALSE, results = "asis", warning = FALSE}
library(BiocStyle)
BiocStyle::markdown()
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

<!--
**Modified**: `r file.info("differential_abundance_pos.Rmd")$mtime`<br />
**Compiled**: `r date()`
-->

```{r parameters, echo = FALSE, warning = FALSE}
## Set general parameters
polarity <- "POS" # specify "POS" or "NEG"
p.cut <- 0.05     # cut-off for significance.
m.cut <- 0.7      # cut-off for log2 fold change
set.seed(123)
## Setting golden ratio to save images
phi <- (1+sqrt(5))/2
FILE_NAME <- "semi_t_matrices_pos"
## Define paths:
IMAGE_PATH <- paste0("images/", FILE_NAME, "/")
if (dir.exists(IMAGE_PATH)) unlink(IMAGE_PATH, recursive = TRUE, force = TRUE)
dir.create(IMAGE_PATH, recursive = TRUE, showWarnings = FALSE)
RDATA_PATH <- paste0("data/RData/", FILE_NAME, "/")
dir.create(RDATA_PATH, recursive = TRUE, showWarnings = FALSE)
RESULT_PATH <- paste0("data/results/", FILE_NAME, "/")
dir.create(RESULT_PATH, recursive = TRUE, showWarnings = FALSE)
```

# Introduction

In this document we perform the differential abundance analysis of the features
previously identified for the *MitYOU* project, with the aim of identifying
significant sample source-related features. This task is performed by hypothesis
testing, where we try to identify which metabolites have the most different 
concentrations between plasma samples, venous and capillary blood samples. 
We follow a semi-targeted approach, where we look at concentrations of features
corresponding to lab-internal set of standards.
The analysis comprises a differential abundance analysis carried out on each 
matrix separately.


# Data import

First, we load the required packages and the data, after preprocessing and
normalization. The end result of these steps is a `SummarizedExperiment` that
contains aligned data, where features are grouped (after correspondence), and
that have undergone gap filling, normalization by the median, linear fitting and 
per-feature between-batch normalization to remove any unwanted variability. 
The `SummarizedExperiment` lets us store all the information regarding the 
normalization steps in the form of `assays`, which we are still able to access 
to proceed with the analysis.

```{r load-data, echo = FALSE, warning = FALSE}
library(xcms)
library(limma)
library(pheatmap)
library(writexl)
library(SummarizedExperiment)
library(RColorBrewer)
library(MsFeatures)
library(CompMetaboTools)
library(pander)
load("data/RData/vams_normalization_pos/res_pos.RData")
res_pos$sample_pair <- paste0(res_pos$source, ".", res_pos$sample)
```

It is important now to remove the `POOL` samples from the dataset, because the
analysis has to be performed only on study samples; the `POOL` samples, though
are still required to evaluate the goodness of the detected features, therefore
they will be stored in a separate `SummarizedExperiment` object that can be
accessed when needed.
We also exclude the `RBC` samples from our analysis, as these samples showed
a noisy signal beforehand. We also store them separatedly in a 
`SummarizedExperiment` object

We also assign the colours as seen before.

```{r split-qc, echo = TRUE}
res_qc <- res_pos[, res_pos$source == "all"]
res_rbc <- res_pos[, res_pos$source == "RBC"]
res_pos <- res_pos[, res_pos$source != "all"]
res_pos <- res_pos[, res_pos$source != "RBC"]
res_pos$source <- factor(as.character(res_pos$source))
res_pos$sex <- factor(as.character(res_pos$sex))
col_source <- brewer.pal(5, name = "Set1")
names(col_source) <- c("RBC",           #' red
                       "plasma",        #' blue
                       "all",           #' green
                       "capillary",     #' purple
                       "venous")        #' orange
col_sex <- brewer.pal(4, name = "Set1") [c(1, 2, 3)]
names(col_sex) <- c("F",           # red
                    "M",           # blue
                    "POOL")        # green
## Setting golden ratio to save images
phi <- (1+sqrt(5))/2
```

The samples used in this analysis are listed below.

```{r, echo = FALSE, results = "asis"}
tab <- colData(res_pos)[, c("source", "sex", "age")]
pandoc.table(as.data.frame(tab), style = "rmarkdown",
             caption = "Samples used in this analysis")
```

# Semi-targeted analysis

First, we restrict the analysis to a set of known compounds, whose
mass-to-charge ratio and retention time have been previously measured from the
pure standards. To start, a table of standards is loaded, then
a search in the m/z and retention time dimensions is carried out to match the
features found before to these compounds. Subsequently, EICs for all the
assigned features are plotted and visually inspected: this step is necessary to
accurately pair the detected peaks to the standards. When the list of assigned
standards is complete, we perform a differential abundance analysis on the
subset of features.

First, we load the information on the standards, with the aim of identifying
features potentially matching these and plotting the EICs for all of these.

```{r known-cmps, message = FALSE, warning = FALSE}
## Extract known compunds
library("MetaboCoreUtils")
library(Rdisop)
std_info <- read.table(
    "https://raw.githubusercontent.com/EuracBiomedicalResearch/lcms-standards/master/data/standards_dilution.txt",
    sep = "\t", header = TRUE, as.is = TRUE)
std_info <- std_info[!is.na(std_info[, "POS"]), ]
rownames(std_info) <- 1:nrow(std_info)
std_info$mzneut = NA
std_info$mz_ion = NA
for (i in seq(nrow(std_info))) {
    if (grepl("C", std_info$formula[i])) {
        std_info$mzneut[i] <- getMolecule(
            as.character(std_info$formula[i]))$exactmass
    } else {
        std_info$mzneut[i] = as.numeric(std_info$formula[i])
    }
    ## Calculate also the m/z
    std_info$mz_ion[i] <- mass2mz(
        std_info$mzneut[i], adduct = std_info[i, "POS"])[1, 1]
}
std_info <- std_info[!is.na(std_info$mz_ion), ]
std_info <- std_info[order(std_info$name), ]
dr <- paste0(IMAGE_PATH, "/standards/")
dir.create(dr, recursive = TRUE, showWarnings = FALSE)
##load data_pos
load("data/RData/vams_normalization_pos/data_pos_filled.RData")
## Subset to the samples we're currently analyzing.
tmp <- filterFile(data_pos, match(res_pos$mzML_file, data_pos$mzML_file),
                  keepFeatures = TRUE)
## Try to identify all features potentially matching these.
sample_colors <- col_source[tmp$source]
for (i in seq_len(nrow(std_info))) {
    fts <- featureDefinitions(tmp, mz = std_info$mz_ion[i],
                              rt = std_info$RT[i] + c(-30, 30),
                              ppm = 10)
    if (nrow(fts)) {
        fl <- std_info$name[i]
        chrs <- featureChromatograms(tmp, features = rownames(fts),
                                     expandRt = 7, filled = TRUE)
        #chrs <- chrs[, colnames(res)]
        chrs <- chrs[, seq_len(ncol(res_pos))]
        for (j in seq_len(nrow(fts))) {
            chr <- chrs[j, ]
            pks <- chromPeaks(chr)
            png(paste0(dr, fl, "-", rownames(fts)[j], ".png"),
                width = 10, height = 8, units = "cm", res = 300, pointsize = 6)
            plot(chr, col = "#00000040",
                 peakCol = paste0(sample_colors[pks[, "column"]], 50),
                 peakBg = paste0(sample_colors[pks[, "column"]], 10))
            abline(v = std_info$RT[i])
            legend("topleft", legend = c(rownames(fts)[j], fl,
                                         paste0("rt: ", std_info$RT[i]),
                                         paste0("mz: ", std_info$mz_ion[i])))
            dev.off()
        }
    }
}
```

The EICs have been manually inspected and the best matching feature has been
manually assigned to the corresponding standard. Some features found a better
match than others, such as xyz; in this case, in fact, there is a single
peak detected, with high intensity, that is well within the theoretical m/z
range and it is very close to the theoretical retention time.

```{r assign-feature-metabolite, echo = FALSE, warning = FALSE, message = FALSE}
## This is the tricky manual thing:
## - Go through all plots for all standards and if there is one feature
##   that clearly matches (i.e. retention time close to the expected retention
##   time and a single peak present in the wider rt range) assign it.
std_info$feature <- NA
std_info$feature[std_info$name == "1-Methylhistidine"] <- "FT0293"
std_info$feature[std_info$name == "3-Methylhistidine"] <- "FT0293" # same as 1-Methylhistidine
std_info$feature[std_info$name == "5-Oxoproline"] <- "FT0154"
std_info$feature[std_info$name == "Acetylcarnitine"] <- "FT0415"
std_info$feature[std_info$name == "Acetyl-Glucosamine"] <- "FT0518"
std_info$feature[std_info$name == "Acetylhistidine"] <- "FT0384"
std_info$feature[std_info$name == "ADMA"] <- "FT0407"
std_info$feature[std_info$name == "Alanine"] <- "FT0051"
std_info$feature[std_info$name == "alpha-Aminoadipic acid"] <- "FT0268"
std_info$feature[std_info$name == "alpha-Lactose"] <- "FT1330" # or FT1331
std_info$feature[std_info$name == "AMP"] <- "FT1197"
std_info$feature[std_info$name == "Arginine"] <- "FT0307"
std_info$feature[std_info$name == "Asparagine"] <- "FT0162"
## std_info$feature[std_info$name == "Betaine"] <- "FT0111/FT0112"
std_info$feature[std_info$name == "C4 Carnitine"] <- "FT0486"
std_info$feature[std_info$name == "C5 Carnitine"] <- "FT0527" # rt shifted 10s
std_info$feature[std_info$name == "Caffeine"] <- "FT0378"
std_info$feature[std_info$name == "Carnosine"] <- "FT0472"
## std_info$feature[std_info$name == "Choline"] <- "FT0072"
std_info$feature[std_info$name == "Citrulline"] <- "FT0312"
## std_info$feature[std_info$name == "Corticosterone"] <- "FT1193" # rt shifted 10s
##std_info$feature[std_info$name == "Creatine"] <- "FT0159/FT0160"
##std_info$feature[std_info$name == "Creatinine"] <- "FT0099/FT0100"
std_info$feature[std_info$name == "Cystine"] <- "FT0507"
std_info$feature[std_info$name == "dGMP"] <- "FT1198"
std_info$feature[std_info$name == "Fructose"] <- "FT0402" # same as glucose and mannose
std_info$feature[std_info$name == "Galactitol"] <- "FT0420" # same as sorbitol
std_info$feature[std_info$name == "Gluconic Acid"] <- "FT0460"
std_info$feature[std_info$name == "Glucose"] <- "FT0402" # same as Fructose
std_info$feature[std_info$name == "Glutamine"] <- "FT0215"
std_info$feature[std_info$name == "Glutathione Oxidized"] <- "FT3342" # same as Glu. Reduced
std_info$feature[std_info$name == "Glutathione Reduced"] <- "FT3342" # same as Glu. Oxidized
std_info$feature[std_info$name == "Glycero-phosphocholine"] <- "FT0581"
std_info$feature[std_info$name == "Glycine"] <- "FT0031"
std_info$feature[std_info$name == "Histidine"] <- "FT0249"
#std_info$feature[std_info$name == "Homocysteine"] <- "FT0178"
std_info$feature[std_info$name == "Hydroxyproline"] <- "FT0158"
std_info$feature[std_info$name == "Hypoxanthine"] <- "FT0182"
std_info$feature[std_info$name == "Isoleucine"] <- "FT0161"
std_info$feature[std_info$name == "L-Aspartic Acid"] <- "FT0168" # or FT0169
std_info$feature[std_info$name == "L-Carnitine"] <- "FT0270" 
std_info$feature[std_info$name == "L-Cysteine"] <- "FT0123"
std_info$feature[std_info$name == "Leucine"] <- "FT0161"
##std_info$feature[std_info$name == "Levodopa"] <- "FT0384" # found with ppm = 50
std_info$feature[std_info$name == "L-Glutamic Acid"] <- "FT0220"
std_info$feature[std_info$name == "Lysine"] <- "FT0216"
std_info$feature[std_info$name == "Mannose"] <- "FT0402" # same as Fructose and Glucose
std_info$feature[std_info$name == "Methionine"] <- "FT0226"
std_info$feature[std_info$name == "Methioninesulfoxide"] <- "FT0280" 
## std_info$feature[std_info$name == "Myoinositol"] <- "FT0402" # detected as FT0820 and FT0821 - same as fructose, glucose and mannose
std_info$feature[std_info$name == "N-Acetylornithine"] <- "FT0306"
std_info$feature[std_info$name == "NAD"] <- "FT3776"
std_info$feature[std_info$name == "Niacinamide"] <- "FT0134"
std_info$feature[std_info$name == "Ornithine"] <- "FT0165"
std_info$feature[std_info$name == "Palmitoylcarnitine"] <- "FT1588" # or FT1589
std_info$feature[std_info$name == "Phenylalanine"] <- "FT0281"
##std_info$feature[std_info$name == "Phenylethylamine"] <- "FT0129"
##std_info$feature[std_info$name == "Phosphocreatine"] <- "FT0436"
std_info$feature[std_info$name == "Phosphorylcholine"] <- "FT0338"
std_info$feature[std_info$name == "Phosphorylethanolamine"] <- "FT0201"
##std_info$feature[std_info$name == "Pipecolic acid"] <- "FT0155"
## std_info$feature[std_info$name == "Proline"] <- "FT0107/FT106"
##std_info$feature[std_info$name == "Putrescine"] <- "FT0024"
std_info$feature[std_info$name == "SAH"] <- "FT1481"
std_info$feature[std_info$name == "SAMe"] <- "FT1583"
std_info$feature[std_info$name == "SDMA"] <- "FT0407"
std_info$feature[std_info$name == "Serine"] <- "FT0079"
std_info$feature[std_info$name == "Sorbitol"] <- "FT0420" # same as galactitol
std_info$feature[std_info$name == "Sphingosine-1-phosphate"] <- "FT1451"
std_info$feature[std_info$name == "Sphingosine"] <- "FT0843"
std_info$feature[std_info$name == "Sucrose"] <- "FT1331" # or FT1330
std_info$feature[std_info$name == "Taurine"] <- "FT0146"
std_info$feature[std_info$name == "Threonine"] <- "FT0117"
std_info$feature[std_info$name == "Tryptophan"] <- "FT0422"
std_info$feature[std_info$name == "Tyrosine"] <- "FT0328"
std_info$feature[std_info$name == "Valine"] <- "FT0112"
## Add creatine and creatinine...
std_info <- rbind(std_info,
                  std_info[std_info$name == "Creatine", , drop = FALSE])
std_info$name[nrow(std_info)] <- "Creatine-full"
std_info <- rbind(std_info,
                  std_info[std_info$name == "Creatinine", , drop = FALSE])
std_info$name[nrow(std_info)] <- "Creatinine-full"
std_info$feature[std_info$name == "Creatine"] <- "FT0160"
std_info$feature[std_info$name == "Creatine-full"] <- "FT5630"
std_info$feature[std_info$name == "Creatinine"] <- "FT0099"
std_info$feature[std_info$name == "Creatinine-full"] <- "FT5631"
std_info <- std_info[!is.na(std_info$feature), ]
## Check if we've got the same feature for multiple standards. In case combine
## them into one row.
dups <- std_info$feature[duplicated(std_info$feature)]
for (dup in dups) {
    idx <- which(std_info$feature == dup)
    std_info$HMDB.code[idx[1]] <- paste0(std_info$HMDB.code[idx], collapse = ";")
    std_info$name[idx[1]] <- paste0(std_info$name[idx], collapse = ";")
    std_info$feature[idx[-1]] <- NA
}
std_info <- std_info[!is.na(std_info$feature), ]
rownames(std_info) <- std_info$feature
```

A total of `r sum(nrow(std_info))` standards have been identified. The features
identified and the corresponding metabolite are summarized in this table:

```{r result-table-ft-std, echo = FALSE, results = "asis"}
## Write result table
tab <- std_info[, c("name", "RT")]
pandoc.table(as.data.frame(tab), style = "rmarkdown",
             caption = "Features assigned to known compounds")
```

Next, we merge the technical replicates.

```{r}
#' Average 
averageSE <- function(x, column = character(), mainAssay = character()) {
    if (!column %in% colnames(colData(x)))
        stop("Column '", "' not found in 'colData' of 'x'")
    f <- factor(colData(x)[, column], levels = unique(colData(x)[, column]))
    ## new colData: take the first element for each replicate.
    cd <- colData(x)[match(levels(f), f), ]
    ## loop over the assays and average them.
    a <- lapply(assays(x), function(z) {
        z <- split.data.frame(t(z), f = f)
        z <- do.call(cbind, lapply(z, colMeans, na.rm = TRUE))
        z[is.na(z)] <- NA
        z
    })
    if (length(mainAssay)) {
        tmp <- split.data.frame(t(assay(x, mainAssay)), f = f)
        tmp <- do.call(cbind, lapply(tmp, function(y) {
            apply(y, MARGIN = 2, FUN = sd, na.rm = TRUE)
        }))
        tmp[is.na(tmp)] <- NA
        a[[paste0(mainAssay, "_sd")]] <- tmp
    }
    SummarizedExperiment(assays = a, rowData = rowData(x),
                         colData = cd, metadata = metadata(x))
}
## Average technical replicates:
res_pos <- averageSE(res_pos, column = "sample_pair",
                     mainAssay = "normalized_filled")
```

Next, only the features assigned to the standards are taken into consideration
and are subsetted in the `std_res` object.

```{r std-subset, echo = FALSE}
std_res <- res_pos[rownames(res_pos) %in% std_info$feature, ]
rowData(std_res) <- cbind(rowData(std_res),
                          std_info[rownames(std_res), c("name", "HMDB.code")])
```

The subsetting reduced the number of features to `r length(std_res)`. 
A PCA analysis is then performed on the subset to verify whether anything has
changed and if any similarities among the samples are visible or not.

```{r standards-pca-all, echo = FALSE}
pc <- prcomp(t(log2(assay(std_res, "normalized_filled_imputed"))),
                 center = TRUE, scale. = FALSE)
```

```{r standards-pca-plot, fig.path = IMAGE_PATH, fig.cap = "PCA of the samples based on intensities of known compounds.", fig.width = 7 * phi, fig.height = 7, echo = FALSE}
par(mfrow = c(1, 2))
plot_pca(pc, col = paste0(col_source[as.character(std_res$source)], 90),
         pc_x = 1, pc_y = 2, labels = std_res$differentiation)
plot_pca(pc, col = paste0(col_source[as.character(std_res$source)], 90),
         pc_x = 3, pc_y = 4)
legend("topleft", col = col_source, legend = names(col_source),
       title = "phenotype", pch = 16, ncol = 2)
```

In the PC1 plot, we see a clear separation between the three matrices, which is 
also seen in PC2.In PC3, some of the capillary samples do not cluster with the
rest of the samples, but it needs to be considered that the variance described 
by this dimension is rather low.

## Heatmap 

To visualize the intensity of all detected standards across the three matrices,
we created a heatmap of the known compounds we found in our samples.

```{r heatmap, fig.width = 15, fig.height = 13, fig.cap = "Heatmap of known compounds. Note that for better visibility, the color range has been restricted to -5 to 5, thus, differences larger than these values are assigned the extreme colors.", echo = FALSE}
## Create heatmap
tmp <- log2(assay(
            std_res, "normalized_filled_imputed")[rownames(tab), , drop = FALSE])
tmp <- tmp - rowMeans(tmp, na.rm = TRUE)
ann <- as.data.frame(colData(std_res)[, c("source", "sex")])
pm <- pheatmap(tmp, annotation_col = ann, labels_col = colnames(tmp),
               breaks = seq(-5, 5, length.out = 101),
               annotation_color = list(source = col_source,
                                   sex = col_sex))
tmp <- data.frame(
  heatmap = pm$tree_row$order
)

```

In the heatmap we see two main cluster, one containing all plasma samples and 
the other containing all venous and capillar< blood samples, which indicates
a higher similarity in the intensities of the lab internal standards. The 
second cluster is then split up in two subclusters, containing all samples 
from each matrix.
FT0507, **Cystine**, shows a high intensity in plasma samples, but has a low
intensity in capillary and venous samples.
There are 14 Features, that have a high intensity in venous and capillary 
samples, but low intensity in plasma samples, whereas 5 Features show a high
intensity signal in capillary samples, but not in plasma or venous blood 
samples. 


## Present and absent features

We then wanted to check if there are compounds that are only present in some of
the three matrices. Therefore, we used the `raw` data of our three sample 
sources and looked, which compounds are present in more than 2/3 of the samples.

```{r Present and absent features}
plas <- assay(std_res, "raw")[, std_res$source == "plasma"]
plas_present <- moreAreValidThan(plas, prop = 2/3)

ven <- assay(std_res, "raw")[, std_res$source == "venous"]
ven_present <- moreAreValidThan(ven, prop = 2/3)

cap <- assay(std_res, "raw")[, std_res$source == "capillary"]
cap_present <- moreAreValidThan(cap, prop = 2/3)


```

listInput <- list(capillary = which(cap_present, useNames = TRUE),
                  venous = which(ven_present, useNames = TRUE),
                  plasma = which(plas_present, useNames = TRUE))
upset(fromList(listInput), order.by = "freq")
```
The majority of known compounds, 35 features, are present in all three sample
sources, whereas 10 features are only present in capillary and venous blood 
samples and 9 features are only present in capillary blood samples. 2 features
are present in plasma and venous blood samples, but absent in capillary blood 
samples and one feature is only present in plasma samples.

Now, we start with the differential abundance analysis.

## Differential abundance analysis

The differential abundance analysis is performed on the subset of features that
have previously been assigned to the standards. We apply feature-wise multiple
linear regression using the `lmFit` function and we add the matrix defining
the contrasts using `contrast.fit`. Then, we calculate the p-values with `eBayes`.
Subsequently, we generate a data frame with the coefficients, the raw
and adjusted p-values (we apply a Benjamini-Hochberg correction for better
control of the false discovery rate), the average intensity of signals in plasma
samples, capillary and venous blood samples and whether or not a feature is to 
be considered significant.
This data frame is then added to the `rowData` of the `res_capven` object.

We start the analysis for the capillary and venous blood samples:

```{r standards-analysis cap/ven, echo = FALSE}
source <- factor(std_res$source)
sex <- factor(std_res$sex)

dsgn <- model.matrix(~ 0 + source + sex)
fit <- lmFit(log2(assay(std_res, "normalized_filled_imputed")), design = dsgn)

## Fit the actual contrasts of interest
contr_mat <- makeContrasts(
  CapvsVen = sourcecapillary - sourcevenous,
  levels = dsgn)
fit <- contrasts.fit(fit, contrasts = contr_mat)
fit <- eBayes(fit)
tmp <- data.frame(
    coef = fit$coefficient[, "CapvsVen"],
    pvalue = fit$p.value[, "CapvsVen"],
    adjp = p.adjust(fit$p.value[, "CapvsVen"]),
    avg.Cap = rowMeans(
        log2(assay(
             std_res, "normalized_filled_imputed")
             [, std_res$source == "capillary"])),
    avg.Ven = rowMeans(
        log2(assay(
             std_res, "normalized_filled_imputed")
             [, std_res$source == "venous"]))
    )
tmp$significant <- abs(tmp$coef) > m.cut & tmp$adjp < p.cut
rowData(std_res) <- cbind(rowData(std_res), tmp)
```

We plot then the distribution of p-values, both raw and adjusted:

```{r standards-histogram cap/ven, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "Distribution of raw (left) and adjusted p-values (right)."}
par(mfrow = c(1, 2))
hist(rowData(std_res)$pvalue, breaks = 64, xlab = "p value",
     main = "Distribution of raw p-values")
hist(rowData(std_res)$adjp, breaks = 64, xlab = expression(p[BH]~value),
     main = "Distribution of adjusted p-values")
```

The distribution of the raw p-values reflects what was expected: the tallest bar
is close to 0 and the other p-values are randomly distributed. Also, we notice
that there are several p-values that are not represented at all in the dataset.

The distribution of the adjusted p-values also follows the trend we predicted:
the bar with the highest frequency is found near 0, the second highest is near
to 1, while few other values are scarcely represented.

The volcano plot is now plotted to evaluate whether significant features are
still present or not. First, we plot data belonging to the capillary blood 
samples:

```{r standards-volcano cap/ven, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 10, fig.height = 10, fig.cap = "Volcano plot showing the analysis results."}
par(mfrow = c(1, 1))
plot(rowData(std_res)$coef, -log10(rowData(std_res)$adjp),
     xlab = expression(log[2]~difference),
     ylab = expression(-log[10]~p[BH]), pch = 16, col = "#00000060")
rect(xleft = -100, ybottom = -log10(p.cut), xright = -m.cut, ytop = 100,
     border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
rect(xleft = m.cut, ybottom = -log10(p.cut), xright = 100, ytop = 100,
     border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
if (any(rowData(std_res)$significant)) {
    points(rowData(std_res)$coef[rowData(std_res)$significant],
           -log10(rowData(std_res)$adjp[rowData(std_res)$significant]),
           col = "#0000ffcc")
}
```

In total `r sum(rowData(std_res)$significant)` feature were found to have a
significant difference in abundances between the two groups. The table below
lists these features (or the 20 features with the smallest p-values if no
feature was found significant).

```{r significant-standards-result-table capillary/venous, echo = FALSE, results = "asis"}
## Write result table
if (any(rowData(std_res)$significant)) {
    tab <- rowData(std_res)[rowData(std_res)$significant,
                            c("name", "mzmed", "rtmed", "coef", "adjp", "pvalue"
                              )]
    tab <- tab[order(tab$adjp, abs(tab$coef)), ]
    pandoc.table(
        as.data.frame(tab), style = "rmarkdown",
        caption = "Features with significant differences in abundances.")
} else {
    tab <- rowData(std_res)[order(rowData(std_res)$pvalue),
                            c("name", "mzmed", "rtmed", "coef", "adjp"
                              )]
    tab <- tab[1:20, ]
    pandoc.table(
        as.data.frame(tab), style = "rmarkdown",
        caption = "Top 20 features with the smallest p-values.")
}
```

In total `r sum(rowData(std_res)$significant)` features were found to have a
significant difference in abundances between the capillary and venous blood
samples.

We now create the beeswarm plot:

```{r beeswarm capillary/venous, echo = FALSE}
library(beeswarm)
tab <- rowData(std_res)[rownames(tab), ]
tmp <- log2(assay(std_res, "normalized_filled_imputed")[rownames(tab), 
                                                        , drop = FALSE])
rownames(tmp) <- tab$name
dr <- paste0(IMAGE_PATH, "standards-beeswarm-capven/")
dir.create(dr, recursive = TRUE, showWarnings = FALSE)
for (i in seq_len(nrow(tmp))) {
    vals <- split(tmp[i, ], f = std_res$source)
    col <- col_source[names(vals)]
    png(file = paste0(dr, rownames(tab)[i], "_", rownames(tmp)[i], ".png"),
        width = 6 * phi, height = 6, units = "in", res = 300, pointsize = 12)
    par(mar = c(5, 5, 5, 1))
    beeswarm(vals, col = paste0(col, 80), pch = 16, cex = 1.5, spacing = 1.2,
             cex.main = 1.5,
             cex.lab = 1.5,
             cex.axis = 1.3,
             main = paste0(rownames(tab)[i], ": ", rownames(tmp)[i]),
             ylab = expression(log[2]~intensity))
    bxplot(vals, probs = 0.5, col = "#00000060", add = TRUE, width = 0.9)
    dev.off()
}
```

![](images/semi_t_matrices_pos/standards-beeswarm-capven/FT0384_Acetylhistidine.png)
**Acetylhistidine** shows a significant higher concentration in capillary blood
samples compared to venous blood samples. 

![](images/semi_t_matrices_pos/standards-beeswarm-capven/FT1331_Sucrose.png)
Also, the intensity of **Sucrose** is higher in capillary samples than in the
other two matrices.

![](images/semi_t_matrices_pos/standards-beeswarm-capven/FT0079_Serine.png)

**Serine** shows also higher intensity levels in capillary blood samples 
compared to plasma and venous blood samples.

Of the `r sum(rowData(std_res)$significant)` significant features, only three
show a higher intensity in venous blood:

![](images/semi_t_matrices_pos/standards-beeswarm-capven/FT0112_Valine.png)

![](images/semi_t_matrices_pos/standards-beeswarm-capven/FT0160_Creatine.png)

![](images/semi_t_matrices_pos/standards-beeswarm-capven/FT0226_Methionine.png)
While **Valine** and **Methionine** show comparable intensities in plasma and 
venous blood samples, **Creatine** levels are higher in venous blood compared
to both plasma and capillary blood samples. 

We save the significant features in a new variable:

```{r}
feat_sig <- function(x) {
    if (any(rowData(x)$significant)) {
        as.data.frame(rowData(x)[rowData(x)$significant,
                                 c("name", "mzmed", "rtmed", "coef", "adjp")])
}}
capven_sig <- feat_sig(std_res)
```


We now want to compare the feature intensity in capillary blood samples and
plasma samples:

```{r std-subset 2, echo = FALSE}
std_res <- res_pos[rownames(res_pos) %in% std_info$feature, ]
rowData(std_res) <- cbind(rowData(std_res),
                          std_info[rownames(std_res), c("name", "HMDB.code")])
```

```{r standards-analysis cap/plas, echo = FALSE}
source <- factor(std_res$source)
sex <- factor(std_res$sex)

dsgn <- model.matrix(~ 0 + source + sex)
fit <- lmFit(log2(assay(std_res, "normalized_filled_imputed")), design = dsgn)

## Fit the actual contrasts of interest
contr_mat <- makeContrasts(
  CapvsPlas = sourcecapillary - sourceplasma,
  levels = dsgn)
fit <- contrasts.fit(fit, contrasts = contr_mat)
fit <- eBayes(fit)
tmp <- data.frame(
    coef = fit$coefficient[, "CapvsPlas"],
    pvalue = fit$p.value[, "CapvsPlas"],
    adjp = p.adjust(fit$p.value[, "CapvsPlas"]),
    avg.Cap = rowMeans(
        log2(assay(
             std_res, "normalized_filled_imputed")
             [, std_res$source == "capillary"])),
    avg.Plas = rowMeans(
        log2(assay(
             std_res, "normalized_filled_imputed")
             [, std_res$source == "plasma"]))
    )
tmp$significant <- abs(tmp$coef) > m.cut & tmp$adjp < p.cut
rowData(std_res) <- cbind(rowData(std_res), tmp)
```

We plot then the distribution of p-values, both raw and adjusted:

```{r standards-histogram cap/plas, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "Distribution of raw (left) and adjusted p-values (right)."}
par(mfrow = c(1, 2))
hist(rowData(std_res)$pvalue, breaks = 64, xlab = "p value",
     main = "Distribution of raw p-values")
hist(rowData(std_res)$adjp, breaks = 64, xlab = expression(p[BH]~value),
     main = "Distribution of adjusted p-values")
```
The distribution of the raw p-values reflects what was expected: the tallest bar
is close to 0 and the other p-values are randomly distributed. Also, we notice
that there are several p-values that are not represented at all in the dataset.

The distribution of the adjusted p-values also follows the trend we predicted:
the bar with the highest frequency is found near 0, the second highest is near
to 1, while few other values are scarcely represented.

The volcano plot is now plotted to evaluate whether significant features are
still present or not. First, we plot data belonging to the capillary blood 
samples:

```{r standards-volcano cap/plas, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 10, fig.height = 10, fig.cap = "Volcano plot showing the analysis results."}
par(mfrow = c(1, 1))
plot(rowData(std_res)$coef, -log10(rowData(std_res)$adjp),
     xlab = expression(log[2]~difference),
     ylab = expression(-log[10]~p[BH]), pch = 16, col = "#00000060")
rect(xleft = -100, ybottom = -log10(p.cut), xright = -m.cut, ytop = 100,
     border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
rect(xleft = m.cut, ybottom = -log10(p.cut), xright = 100, ytop = 100,
     border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
if (any(rowData(std_res)$significant)) {
    points(rowData(std_res)$coef[rowData(std_res)$significant],
           -log10(rowData(std_res)$adjp[rowData(std_res)$significant]),
           col = "#0000ffcc")
}
```

In total `r sum(rowData(std_res)$significant)` feature were found to have a
significant difference in abundances between plasma and capillary blood samples.
The table below lists these features (or the 20 features with the smallest 
p-values if no feature was found significant).

```{r significant-standards-result-table capillary/plasma, echo = FALSE, results = "asis"}
## Write result table
if (any(rowData(std_res)$significant)) {
    tab <- rowData(std_res)[rowData(std_res)$significant,
                            c("name", "mzmed", "rtmed", "coef", "adjp", "pvalue"
                              )]
    tab <- tab[order(tab$adjp, abs(tab$coef)), ]
    pandoc.table(
        as.data.frame(tab), style = "rmarkdown",
        caption = "Features with significant differences in abundances.")
} else {
    tab <- rowData(std_res)[order(rowData(std_res)$pvalue),
                            c("name", "mzmed", "rtmed", "coef", "adjp"
                              )]
    tab <- tab[1:20, ]
    pandoc.table(
        as.data.frame(tab), style = "rmarkdown",
        caption = "Top 20 features with the smallest p-values.")
}
```
In total `r sum(rowData(std_res)$significant)` features were found to have a
significant difference in abundances between the plasma and capillary blood
samples.

We now create the beeswarm plot:

```{r beeswarm capillary/plasma, echo = FALSE}
library(beeswarm)
tab <- rowData(std_res)[rownames(tab), ]
tmp <- log2(assay(std_res, "normalized_filled_imputed")[rownames(tab), 
                                                        , drop = FALSE])
rownames(tmp) <- tab$name
dr <- paste0(IMAGE_PATH, "standards-beeswarm-capplas/")
dir.create(dr, recursive = TRUE, showWarnings = FALSE)
for (i in seq_len(nrow(tmp))) {
    vals <- split(tmp[i, ], f = std_res$source)
    col <- col_source[names(vals)]
    png(file = paste0(dr, rownames(tab)[i], "_", rownames(tmp)[i], ".png"),
        width = 6 * phi, height = 6, units = "in", res = 300, pointsize = 12)
    par(mar = c(5, 5, 5, 1))
    beeswarm(vals, col = paste0(col, 80), pch = 16, cex = 1.5, spacing = 1.2,
             cex.main = 1.5,
             cex.lab = 1.5,
             cex.axis = 1.3,
             main = paste0(rownames(tab)[i], ": ", rownames(tmp)[i]),
             ylab = expression(log[2]~intensity))
    bxplot(vals, probs = 0.5, col = "#00000060", add = TRUE, width = 0.9)
    dev.off()
}
```

![](images/semi_t_matrices_pos/standards-beeswarm-capplas/FT0507_Cystine.png)
As already seen in the heatmap, **Cystine** shows a much higher intensity in
plasma samples compared to venous and capillary blood samples. 

![](images/semi_t_matrices_pos/standards-beeswarm-capplas/FT0338_Phosphorylcholine.png)
Both, **Acetylhistidine** and **Phosphorylcholine** show higher intensities in 
capillary and venous blood samples compared to plasma samples.

Of the `r sum(rowData(std_res)$significant)` significant features, six showed
a higher intensity in plasma: **Cystine**, **Valine**, **Arginine**, 
**Fructose, Glucose, Mannose**, **Methylhistidine** and **Methionine**.

We save the significant features in a new variable:

```{r}
capplas_sig <- feat_sig(std_res)
```


Lastly, we compare plasma and venous blood samples:

```{r std-subset 3, echo = FALSE}
std_res <- res_pos[rownames(res_pos) %in% std_info$feature, ]
rowData(std_res) <- cbind(rowData(std_res),
                          std_info[rownames(std_res), c("name", "HMDB.code")])
```

```{r standards-analysis ven/plas, echo = FALSE}
source <- factor(std_res$source)
sex <- factor(std_res$sex)

dsgn <- model.matrix(~ 0 + source + sex)
fit <- lmFit(log2(assay(std_res, "normalized_filled_imputed")), design = dsgn)

## Fit the actual contrasts of interest
contr_mat <- makeContrasts(
  VenvsPlas = sourcevenous - sourceplasma,
  levels = dsgn)
fit <- contrasts.fit(fit, contrasts = contr_mat)
fit <- eBayes(fit)
tmp <- data.frame(
    coef = fit$coefficient[, "VenvsPlas"],
    pvalue = fit$p.value[, "VenvsPlas"],
    adjp = p.adjust(fit$p.value[, "VenvsPlas"]),
    avg.Ven = rowMeans(
        log2(assay(
             std_res, "normalized_filled_imputed")
             [, std_res$source == "venous"])),
    avg.Plas = rowMeans(
        log2(assay(
             std_res, "normalized_filled_imputed")
             [, std_res$source == "plasma"]))
    )
tmp$significant <- abs(tmp$coef) > m.cut & tmp$adjp < p.cut
rowData(std_res) <- cbind(rowData(std_res), tmp)
```

We plot then the distribution of p-values, both raw and adjusted:

```{r standards-histogram ven/plas, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 7 * phi, fig.height = 7, fig.cap = "Distribution of raw (left) and adjusted p-values (right)."}
par(mfrow = c(1, 2))
hist(rowData(std_res)$pvalue, breaks = 64, xlab = "p value",
     main = "Distribution of raw p-values")
hist(rowData(std_res)$adjp, breaks = 64, xlab = expression(p[BH]~value),
     main = "Distribution of adjusted p-values")
```
The distribution of the raw p-values reflects what was expected: the tallest bar
is close to 0 and the other p-values are randomly distributed. Also, we notice
that there are several p-values that are not represented at all in the dataset.

The distribution of the adjusted p-values also follows the trend we predicted:
the bar with the highest frequency is found near 0, the second highest is near
to 1, while few other values are scarcely represented.

The volcano plot is now plotted to evaluate whether significant features are
still present or not. First, we plot data belonging to the capillary blood 
samples:

```{r standards-volcano ven/plas, echo = FALSE, fig.path = IMAGE_PATH, fig.width = 10, fig.height = 10, fig.cap = "Volcano plot showing the analysis results."}
par(mfrow = c(1, 1))
plot(rowData(std_res)$coef, -log10(rowData(std_res)$adjp),
     xlab = expression(log[2]~difference),
     ylab = expression(-log[10]~p[BH]), pch = 16, col = "#00000060")
rect(xleft = -100, ybottom = -log10(p.cut), xright = -m.cut, ytop = 100,
     border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
rect(xleft = m.cut, ybottom = -log10(p.cut), xright = 100, ytop = 100,
     border = NA, col = paste0(brewer.pal(3, "Set1")[2], 10))
if (any(rowData(std_res)$significant)) {
    points(rowData(std_res)$coef[rowData(std_res)$significant],
           -log10(rowData(std_res)$adjp[rowData(std_res)$significant]),
           col = "#0000ffcc")
}
```

In total `r sum(rowData(std_res)$significant)` feature were found to have a
significant difference in abundances between plasma and capillary blood samples.
The table below lists these features (or the 20 features with the smallest 
p-values if no feature was found significant).

```{r significant-standards-result-table venous/plasma, echo = FALSE, results = "asis"}
## Write result table
if (any(rowData(std_res)$significant)) {
    tab <- rowData(std_res)[rowData(std_res)$significant,
                            c("name", "mzmed", "rtmed", "coef", "adjp", "pvalue"
                              )]
    tab <- tab[order(tab$adjp, abs(tab$coef)), ]
    pandoc.table(
        as.data.frame(tab), style = "rmarkdown",
        caption = "Features with significant differences in abundances.")
} else {
    tab <- rowData(std_res)[order(rowData(std_res)$pvalue),
                            c("name", "mzmed", "rtmed", "coef", "adjp"
                              )]
    tab <- tab[1:20, ]
    pandoc.table(
        as.data.frame(tab), style = "rmarkdown",
        caption = "Top 20 features with the smallest p-values.")
}
```

In total `r sum(rowData(std_res)$significant)` features were found to have a
significant difference in abundances between the capillary and venous blood
samples.

We now create the beeswarm plot:

```{r beeswarm venous/plasma, echo = FALSE}
library(beeswarm)
tab <- rowData(std_res)[rownames(tab), ]
tmp <- log2(assay(std_res, "normalized_filled_imputed")[rownames(tab), 
                                                        , drop = FALSE])
rownames(tmp) <- tab$name
dr <- paste0(IMAGE_PATH, "standards-beeswarm-venplas/")
dir.create(dr, recursive = TRUE, showWarnings = FALSE)
for (i in seq_len(nrow(tmp))) {
    vals <- split(tmp[i, ], f = std_res$source)
    col <- col_source[names(vals)]
    png(file = paste0(dr, rownames(tab)[i], "_", rownames(tmp)[i], ".png"),
        width = 6 * phi, height = 6, units = "in", res = 300, pointsize = 12)
    par(mar = c(5, 5, 5, 1))
    beeswarm(vals, col = paste0(col, 80), pch = 16, cex = 1.5, spacing = 1.2,
             cex.main = 1.5,
             cex.lab = 1.5,
             cex.axis = 1.3,
             main = paste0(rownames(tab)[i], ": ", rownames(tmp)[i]),
             ylab = expression(log[2]~intensity))
    bxplot(vals, probs = 0.5, col = "#00000060", add = TRUE, width = 0.9)
    dev.off()
}
```

As already seen previously, **Cystine** shows a much higher intensity in plasma 
samples compared to the other two sample matrices.

![](images/semi_t_matrices_pos/standards-beeswarm-venplas/FT3342_Glutathione Oxidized;Glutathione Reduced.png)
The intensity level of **Glutathione** and **Phosphorylcholine** is higher in 
capillary and venous blood samples, compared to plasma samples.

Of the `r sum(rowData(std_res)$significant)` features found to have a 
significant difference in intensity between plasma and venous blood samples,
only six have a higher intensity in plasma samples:
**Hydroxyproline**, **Isoleucine, Leucine**, **Arginine**, **Tryptophan**,
**Fructose, Glucose, Mannose** and **Cystine**.

Lastly, we also save these features in a variable:

```{r}
venplas_sig <- feat_sig(std_res)
```

Finally, we take a look at the overlap of features that show a significant 
difference between the intensity in capillary and plasma samples and features 
that show a significant difference between the intensity in venous and plasma
samples:

```{r}
listInput <- list(capillaryVSplasma = rownames(capplas_sig),
                  venousVSplasma = rownames(venplas_sig))
upset(fromList(listInput), order.by = "freq")
```
Most of the significant features were found in both matrix comparisons.

# Session information

The versions of R and the individually used packges are listed below.

```{r}
sessionInfo()
```